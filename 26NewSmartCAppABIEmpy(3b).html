
```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Empyrean Humanitarian Foundation Platform</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- PDF Generation Libraries (for Whitepaper) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* --- PLATFORM STYLES (Existing) --- */
        :root {
            --primary-color: #4A148C; --secondary-color: #6A1B9A; --accent-color: #FFC107; --accent-hover-color: #FFB300;
            --background-color: #F5F5F5; --text-color: #212121; --light-gray: #E0E0E0; --white-color: #ffffff;
            --success-color: #4CAF50; --danger-color: #F44336;
            --retweet-color: #17BF63;
            --status-new-color: #4CAF50; --status-viewed-color: #FFC107;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: var(--background-color); color: var(--text-color); line-height: 1.6; }
        body.modal-open { overflow: hidden; }
        #app-container { display: flex; width: 100%; position: relative; }

        .main-logo-uploader {
            position: relative; width: 100%; max-width: 450px; height: 90px;
            border: 2px dashed var(--light-gray); border-radius: 8px; margin: 20px auto 20px auto;
            background-color: #fafafa; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: background-color 0.3s, border-color 0.3s; overflow: hidden;
        }
        .main-logo-uploader:hover { background-color: #f0f0f0; border-color: var(--secondary-color); }
        .main-logo-uploader .upload-placeholder { color: var(--primary-color); text-align: center; font-weight: 500; }
        .main-logo-uploader .upload-placeholder i { font-size: 1.5rem; display: block; margin-bottom: 5px; }
        #main-logo-link { display: none; height: 100%; padding: 5px; }
        #main-logo-preview { height: 100%; width: auto; object-fit: contain; }

        #auth-modal-overlay, .modal-overlay-container {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 3000;
            align-items: center; justify-content: center; animation: fadeInModal 0.3s;
        }
        @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }
        #auth-modal-overlay.show, .modal-overlay-container.show { display: flex; }
        .auth-card, .modal-card { background: var(--white-color); padding: 40px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); width: 100%; max-width: 450px; text-align: center; position: relative; }
        .modal-card { max-width: 500px; }
        .close-modal { position: absolute; top: 15px; right: 15px; font-size: 1.5rem; color: #aaa; cursor: pointer; border: none; background: none;}
        #signup-view, #forgot-password-view { display: none; }
        .auth-switch { margin-top: 15px; font-size: 0.9rem; }
        .forgot-password-link { margin-left: 10px; }
        .captcha-group { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 20px; }
        #captcha-code { user-select: none; font-family: 'Courier New', monospace; letter-spacing: 4px; font-weight: bold; font-size: 1.5rem; background-color: #f0f0f0; padding: 10px 15px; border-radius: 5px; border: 1px solid #ccc; text-decoration: line-through; color: #555; }
        #refresh-captcha { background: none; border: none; font-size: 1.2rem; cursor: pointer; color: var(--primary-color); }
        .avatar-uploader { text-align: center; margin-bottom: 20px; }
        .avatar-uploader label { display: inline-block; width: 120px; height: 120px; border-radius: 50%; border: 3px solid var(--light-gray); cursor: pointer; position: relative; overflow: hidden; background-color: #f0f0f0; }
        .avatar-uploader img, .avatar-uploader video { width: 100%; height: 100%; object-fit: cover; }

        .avatar-uploader img { display: none; }
        .avatar-uploader .upload-icon { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--primary-color); transition: opacity 0.3s; }

        .avatar-uploader img.active { display: block; }
        .avatar-uploader img.active + .upload-icon { opacity: 0; }
        .form-group { margin-bottom: 15px; text-align: left; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--primary-color); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 5px; font-size: 1rem; }
        .form-feedback { padding: 10px; margin-bottom: 15px; border-radius: 5px; font-size: 0.9rem; text-align: center; display: none; border-left-width: 5px; border-left-style: solid; animation: fadeIn 0.3s; }
        .form-feedback.info { background-color: #e3f2fd; border-color: #2196f3; color: #1e88e5; }
        .form-feedback.success { background-color: #e8f5e9; border-color: var(--success-color); color: #1e88e5; }
        .form-feedback.warning { background-color: #fff8e1; border-color: #ffb300; color: #f57c00; }
        .form-feedback.error { background-color: #ffebee; border-color: var(--danger-color); color: #c62828; }
        .user-type-selection { display: flex; justify-content: center; gap: 15px; margin-bottom: 25px; }
        .user-type-selection input[type="radio"], .wallet-selection input[type="radio"] { display: none; }
        .user-type-selection label, .wallet-selection label { cursor: pointer; padding: 10px 20px; border: 2px solid var(--light-gray); border-radius: 25px; transition: all 0.3s ease; }
        .user-type-selection input[type="radio"]:checked + label, .wallet-selection input[type="radio"]:checked + label { background-color: var(--secondary-color); color: var(--white-color); border-color: var(--primary-color); }
        .user-type-selection label i, .wallet-selection label i { margin-right: 8px; }
        .wallet-selection { display: flex; justify-content: flex-start; gap: 15px; margin-bottom: 25px; flex-wrap: wrap;}
        #org-fields { display: none; }
        .sidebar { width: 260px; background: var(--primary-color); color: var(--white-color); display: flex; flex-direction: column; height: 100vh; position: fixed; left: 0; top: 0; transition: transform 0.3s ease; overflow-y: auto; z-index: 1000;}
        .sidebar-header { padding: 20px; text-align: center; border-bottom: 1px solid var(--secondary-color); display: flex; align-items: center; justify-content: center; }
        .sidebar-header h2 { font-size: 1.5rem; }
        .sidebar-nav { list-style: none; flex-grow: 1; margin-top: 20px; }
        .sidebar-nav li a { display: flex; align-items: center; padding: 15px 20px; color: #E0E0E0; text-decoration: none; transition: background 0.3s, padding-left 0.3s; font-weight: 500; border-left: 4px solid transparent;}
        .sidebar-nav li a:hover, .sidebar-nav li a.active { background: var(--secondary-color); color: var(--white-color); border-left: 4px solid var(--accent-color); padding-left: 25px; }
        .sidebar-nav li a i { width: 30px; font-size: 1.1rem; margin-right: 10px; }
        .sidebar-footer { padding: 20px; text-align: center; border-top: 1px solid var(--secondary-color); }
        .sidebar-footer .social-links { display: flex; justify-content: center; gap: 15px; margin-bottom: 15px; }
        .sidebar-footer .social-links a { color: var(--white-color); font-size: 1.2rem; transition: color 0.3s; }
        .sidebar-footer .social-links a:hover { color: var(--accent-color); }
        .sidebar-footer a { color: var(--white-color); text-decoration: none; font-weight: bold; }
        .main-content { margin-left: 260px; flex-grow: 1; padding: 30px; overflow-y: auto; height: 100vh; }
        .content-section { display: none; }
        .content-section.active { display: block; animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #content-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 999;
        }
        #content-overlay.show { display: block; }

		.header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 15px; }
        .card { background: var(--white-color); padding: 0; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.07); margin-bottom: 20px; overflow: hidden; }

        .card > h3 { padding: 25px 25px 0 25px; color: var(--primary-color); display: flex; justify-content: space-between; align-items: center;}
        .card-content { padding: 25px; }
        .btn { background: var(--secondary-color); color: var(--white-color); padding: 12px 25px; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: background-color 0.3s, transform 0.2s; }
        .btn:hover, .btn:active { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn-accent { background: var(--accent-color); color: var(--text-color); }
        .btn-accent:hover { background-color: var(--accent-hover-color); }
        .btn-success { background: var(--success-color); }
        .btn-danger { background: var(--danger-color); }
        .btn-small { padding: 8px 15px; font-size: 0.9rem; }

        .impact-story { border-bottom: 1px solid var(--light-gray); padding: 20px 25px; }
        .impact-story:last-child { border-bottom: none; }
        .story-header { display: flex; align-items: center; margin-bottom: 15px; }
        .avatar-placeholder { position: relative; overflow: hidden; background-color: #e0e0e0; cursor: pointer; flex-shrink: 0;}
        .avatar-placeholder.square { width: 45px; height: 45px; border-radius: 8px; margin-right: 15px; }
        .avatar-placeholder .upload-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); color: white; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; }
        .avatar-placeholder:hover .upload-overlay { opacity: 1; }
        .avatar-placeholder img, .avatar-placeholder video { width: 100%; height: 100%; object-fit: cover; }
        .story-user-info { flex-grow: 1; }
        .story-user-info strong { color: var(--primary-color); font-size: 1.1rem; }
        .story-user-info span { color: #666; font-size: 0.9rem; display: block; }
        .sponsored-badge { background: var(--accent-color); color: var(--text-color); padding: 3px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: bold; margin-left: 10px; }
        .follow-btn { background: var(--accent-color); color: var(--text-color); border: none; padding: 6px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; transition: background-color 0.3s; }
        .follow-btn.followed { background: var(--secondary-color); color: var(--white-color); }
        .story-content { margin-bottom: 15px; }
        .story-content p { white-space: pre-wrap; word-wrap: break-word; }
        .story-content p strong { font-weight: bold; } .story-content p em { font-style: italic; } .story-content p s { text-decoration: line-through; } /* WhatsApp Style Formatting */
        .story-media-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .story-media-container[data-nav-target] { cursor: pointer; }
        .story-main-image, .story-video { width: 100%; max-height: 400px; object-fit: cover; border-radius: 8px; }
        .story-youtube-embed { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; background: #000; border-radius: 8px; margin-bottom: 15px; }
        .story-youtube-embed iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .story-actions { display: flex; align-items: center; gap: 20px; }
        .action-btn { color: #555; text-decoration: none; font-size: 1rem; display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .action-btn i { transition: color 0.3s, transform 0.2s; }
        .action-btn:hover i { transform: scale(1.2); }
        .action-btn .fa-heart.liked { color: var(--danger-color); font-weight: 900; animation: heartBeat 0.4s; }
        .action-btn .fa-retweet.retweeted { color: var(--retweet-color); font-weight: 900; }
        @keyframes heartBeat { 0% {transform: scale(1);} 50% {transform: scale(1.3);} 100% {transform: scale(1);} }
        .gift-button { background: var(--accent-color); color: var(--text-color); padding: 6px 15px; border-radius: 20px; font-weight: bold; border: none; margin-left: auto; cursor: pointer; }
        .retweet-header { font-size: 0.9rem; color: #666; margin-bottom: 10px; font-weight: bold; }
        .retweet-header i { margin-right: 5px; color: var(--retweet-color); }

		#reward-notification { position: fixed; top: 20px; right: 20px; color: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 5000; font-size: 1.1rem; font-weight: bold; opacity: 0; transform: translateY(-20px); transition: opacity 0.3s ease, transform 0.3s ease; }
        #reward-notification.show { opacity: 1; transform: translateY(0); }
        .mobile-menu-toggle { display: none; position: fixed; top: 15px; left: 15px; font-size: 1.5rem; background: var(--primary-color); color: white; border: none; padding: 8px 12px; border-radius: 5px; z-index: 1001; cursor: pointer; }
        @media (max-width: 992px) { .sidebar { transform: translateX(-100%);} .sidebar.open { transform: translateX(0); box-shadow: 5px 0 15px rgba(0,0,0,0.2); } .main-content { margin-left: 0; } .mobile-menu-toggle { display: block; } }

        .grid-2, .grid-3 { display: grid; gap: 20px; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }

        .wallet-card { text-align: center; padding: 30px; border: 1px solid var(--light-gray); border-radius: 8px; }
        .empy-balance { color: var(--accent-color) !important; }
        .property-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; }
        .property-card { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.07); display: flex; flex-direction: column; cursor: pointer; position: relative; }
        .property-card img, .property-card video { width: 100%; height: 200px; object-fit: cover; }
        .property-info { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; }
        .property-info h4 { flex-grow: 1; margin-bottom: 10px; color: var(--primary-color); }
        .property-info p { margin-bottom: 15px; color: #555;}
        .property-info div { margin-top: auto; font-weight: bold; font-size: 1.2rem; }
        .reels-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .reel-card { position: relative; height: 450px; border-radius: 12px; overflow: hidden; color: white; display: flex; flex-direction: column; justify-content: flex-end; padding: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); cursor: pointer; border: 2px solid transparent; transition: border-color 0.3s ease, box-shadow 0.3s ease; }
        .reel-card:before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent 60%); z-index: 2;}
        .reel-card > img, .reel-card > video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; transition: transform 0.3s ease; }
        .reel-card:hover > img, .reel-card:hover > video { transform: scale(1.05); }
        .reel-content, .reel-actions { z-index: 3; position: relative; }
        .reel-user-info { display: flex; align-items: center; gap: 10px; margin-bottom: 10px;}
        .reel-user-info .avatar-placeholder { width: 35px; height: 35px; border-radius: 8px; border: 2px solid var(--white-color); flex-shrink: 0; }
        .reel-content p { font-weight: normal; margin: 0; }
        .reel-content p strong { font-weight: bold; } .reel-content p em { font-style: italic; } .reel-content p s { text-decoration: line-through; }
        .reel-content span { font-weight: bold; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); }
        #reels .header h1 { color: var(--danger-color); }
        #reels .reel-card:hover { border-color: var(--danger-color); box-shadow: 0 8px 25px rgba(244, 67, 54, 0.3); }
        
        /* Dashboard Feed & Horizontal Sliders */
        .dashboard-grid { display: grid; grid-template-columns: 1fr; gap: 30px; }
        .horizontal-slider-container { overflow: hidden; padding-bottom:15px; }
        .horizontal-slider-wrapper { display: flex; overflow-x: auto; gap: 20px; padding: 5px 25px 15px 25px; white-space: nowrap; -webkit-overflow-scrolling: touch; direction: ltr; }
        .horizontal-slider-wrapper::-webkit-scrollbar { height: 8px; }
        .horizontal-slider-wrapper::-webkit-scrollbar-thumb { background: var(--light-gray); border-radius: 4px; }
        .horizontal-slider-wrapper::-webkit-scrollbar-thumb:hover { background: #b0b0b0; }

		/* Dashboard Reel Card & Market Card Styles */
        .dashboard-reel-card, .dashboard-market-card, .dashboard-news-card { flex-shrink: 0; position: relative; border-radius: 12px; overflow: hidden; display: inline-block; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: transform 0.3s ease, box-shadow 0.3s ease; cursor: pointer; }
        .dashboard-reel-card:hover, .dashboard-market-card:hover, .dashboard-news-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        
        .dashboard-reel-card { width: 180px; height: 280px; }
        .dashboard-reel-card > * { z-index: 3; position:relative; }
        .dashboard-reel-card:before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to top, rgba(0,0,0,0.7), transparent 70%); z-index: 2;}
        .dashboard-reel-card video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        .dashboard-reel-card .reel-content { position: absolute; bottom: 15px; left: 15px; right: 15px; color: white; text-align: left; }
        
        .dashboard-market-card, .dashboard-news-card { width: 250px; background: white; }
        .dashboard-market-card img, .dashboard-news-card img, .dashboard-news-card video, .dashboard-market-card video { width: 100%; height: 150px; object-fit: cover; }
        .dashboard-market-card-info, .dashboard-news-card-info { padding: 15px; }
        .dashboard-market-card-info h5, .dashboard-news-card-info h5 { color: var(--primary-color); margin-bottom: 5px; font-size: 1rem; }
        .dashboard-market-card-info p, .dashboard-news-card-info p { font-size: 0.9rem; color: #555; }


        /* Recorded Livestream Card Styles */
        .livestream-card { flex: 0 0 280px; width: 280px; height: 220px; display: flex; flex-direction: column; background: #fafafa; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .livestream-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .livestream-video-container { position: relative; width: 100%; height: 150px; background-color: #e0e0e0; }
        .livestream-video-container video { width: 100%; height: 100%; object-fit: cover; }
        .livestream-info { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; justify-content: center; }
        .livestream-info strong { display: block; color: var(--primary-color); margin-bottom: 5px; white-space: normal; line-height: 1.2; }
        .livestream-info span { font-size: 0.9rem; color: #666; white-space: normal;}
        
        .profile-header-container { position: relative; } 
        .cover-photo-container {
            height: 250px; background-color: var(--light-gray);
            position: relative; border-radius: 8px 8px 0 0;
            overflow: hidden; background-size: cover; background-position: center;
        }
        .cover-photo-container img { width: 100%; height: 100%; object-fit: cover; }
        .cover-photo-container .upload-overlay {
            position: absolute; top: 10px; right: 10px; z-index: 2;
            background: rgba(0,0,0,0.5); color: white;
            padding: 5px 10px; border-radius: 5px; font-size: 0.9rem;
            cursor: pointer;
        }
        .profile-header { display: flex; align-items: flex-end; gap: 20px; flex-wrap: wrap; padding: 0 25px 25px 25px; transform: translateY(-50px); }
        .profile-header-info { flex-grow: 1; padding-top: 50px; }
        .profile-header-actions { display: flex; gap: 10px; margin-top: 10px; }
        .profile-pic-container { position: relative; flex-shrink: 0; }
        .profile-pic { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 4px solid var(--white-color); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .badge { background: var(--success-color); color: white; padding: 4px 10px; border-radius: 15px; font-size: 0.9rem; font-weight: bold; display: inline-flex; align-items: center; gap: 5px; }
        .impact-story.success-story { border-left: 5px solid var(--success-color); background: #f7fff7; padding-left: 20px;}
        .header-actions { display: flex; align-items: center; gap: 20px; }
        .cart-icon-button .cart-item-count { background-color: var(--danger-color); color: white; border-radius: 50%; padding: 2px 7px; font-size: 0.8rem; vertical-align: top; margin-left: 5px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1999; display: none; }
        .modal-overlay.show { display: block; }
        
        /* --- FIX 2: Cart Modal Scroll --- */
        .cart-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 30px; border-radius: 10px; z-index: 2000;
            width: 90%; max-width: 600px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-height: 90vh; /* Set a max height */
            overflow-y: auto;   /* Allow vertical scroll */
        }
        
        .cart-modal h2 { margin-bottom: 20px; color: var(--primary-color); }
        .cart-item { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--light-gray); }
        .cart-item img { width: 80px; height: 80px; object-fit: cover; border-radius: 5px; }
        .cart-item-info { flex-grow: 1; }
        #cart-total { margin-top: 20px; text-align: right; font-size: 1.2rem; font-weight: bold; }
        #checkout-view { display: none; }

		#withdrawal-method-fields > div { display: none; }
        #withdrawal-preview, #transfer-preview, #cross-chain-transfer-preview { background: #E8EAF6; padding: 15px; border-radius: 5px; margin-top: 20px; border: 1px solid #C5CAE9;}
        #withdrawal-preview p, #transfer-preview p, #cross-chain-transfer-preview p { margin: 5px 0; font-weight: 500; }
        #withdrawal-preview strong, #transfer-preview strong, #cross-chain-transfer-preview strong { color: var(--primary-color); }
        .sos-badge { background-color: var(--danger-color); color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.9rem; font-weight: bold; margin-left: 15px; }
        .crisis-badge { background-color: #FFB300; color: var(--text-color); padding: 5px 12px; border-radius: 20px; font-size: 0.9rem; font-weight: bold; margin-left: 15px; }
        .sos-button { background: var(--danger-color); color: var(--white-color); }
        .impact-story.sos-request { border-left: 5px solid var(--danger-color); border-radius: 4px; background: #fff8f7; padding-left: 20px;}
        .impact-story.crisis-report { border-left: 5px solid #FFB300; border-radius: 4px; background: #fff8e1; padding-left: 20px;}
        .story-content .amount-needed { font-weight: bold; color: var(--primary-color); font-size: 1.1rem;}
        
        #news .card { padding: 0; }
        .news-list { display: flex; flex-direction: column; }
        .news-list-item { background: white; padding: 20px; display: flex; flex-direction: column; border-bottom: 1px solid var(--light-gray); transition: background-color 0.3s ease; }
        .news-list-item:hover { background-color: #f9f6fc; }
        .news-item-content-wrapper { flex-grow: 1; min-width: 0; }
        .news-item-image { width: 100%; height: 200px; flex-shrink: 0; border-radius: 8px; overflow: hidden; margin-bottom: 20px; cursor: pointer; }
        .news-item-image img, .news-item-image video { width: 100%; height: 100%; object-fit: cover; }
        .news-item-content h4 { color: var(--primary-color); margin-bottom: 8px; font-size: 1.25rem; cursor: pointer; }
        .news-item-content .news-meta { color: #666; font-size: 0.9rem; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .news-item-content p { max-height: 0; overflow: hidden; margin: 0; line-height: 1.5; color: #333; transition: max-height 0.5s ease-out, margin-top 0.5s ease-out; }
        .news-list-item.expanded .news-item-content p { max-height: 500px; margin-top: 15px; transition: max-height 0.5s ease-in, margin-top 0.5s ease-in; }
        .news-item-content h4::after { content: '\f078'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: var(--secondary-color); margin-left: 10px; font-size: 0.9rem; display: inline-block; transition: transform 0.3s ease-in-out; }
        .news-list-item.expanded h4::after { transform: rotate(180deg); }
        @media (min-width: 768px) { .news-list-item { flex-direction: row; gap: 30px; align-items: flex-start; padding: 25px; } .news-item-image { order: 2; width: 160px; height: 160px; margin-bottom: 0; } .news-item-content-wrapper { order: 1; } }

        /* --- NEWS FORM PREVIEW --- */
        #news-media-preview { margin-top: 15px; }
        #news-media-preview img, #news-media-preview video { max-width: 200px; max-height: 200px; border-radius: 8px; }


        .security-note { font-size: 0.9rem; color: #555; margin-top: 15px; text-align: center; }
        .security-note i { color: var(--success-color); margin-right: 5px; }

        /* --- POST CREATION & ACTIONS --- */
        #create-post-form { position: relative; }
        #post-format-toolbar {
            position: absolute; top: 0; right: 0; display: flex; gap: 5px;
            background: #f0f0f0; padding: 5px; border-radius: 5px;
            transform: translateY(-120%);
        }
        #post-format-toolbar button {
            background: none; border: 1px solid #ccc; border-radius: 3px;
            width: 30px; height: 30px; font-weight: bold; cursor: pointer;
        }
        #create-post-form textarea { min-height: 80px; margin-bottom: 15px; }
        .post-actions-container { display: flex; justify-content: space-between; align-items: center; }
        #post-media-preview, #sos-media-preview, #crisis-media-preview, #business-post-media-preview { margin-top: 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
        #post-media-preview img, #post-media-preview video,
        #sos-media-preview img, #sos-media-preview video,
        #crisis-media-preview img, #crisis-media-preview video,
        #business-post-media-preview img, #business-post-media-preview video { width: 100%; height: 100px; object-fit: cover; border-radius: 8px; }
        .btn-media-upload { background-color: #f0f0f0; border: 1px solid #ccc; color: var(--primary-color); padding: 8px 15px; font-weight: 500;}
        .btn-media-upload:hover { background-color: #e0e0e0;}
        
        .post-options { position: relative; margin-left: auto; }
        .options-btn { background: none; border: none; font-size: 1rem; color: #888; cursor: pointer; padding: 5px; }
        .options-menu { display: none; position: absolute; right: 0; top: 100%; background: var(--white-color); border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); overflow: hidden; list-style: none; padding: 5px 0; z-index: 10; width: 120px; }
		.options-menu.show { display: block; }
        .options-menu a { display: flex; align-items: center; gap: 10px; padding: 10px 15px; text-decoration: none; color: var(--text-color); font-size: 0.9rem; }
        .options-menu a:hover { background: #f5f5f5; }
        .options-menu a i { width: 20px; }

        /* --- COMMENT SECTION --- */
        .comment-section { display: none; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--light-gray); }
        .comment-list { max-height: 300px; overflow-y: auto; margin-bottom: 15px; }
        .comment { display: flex; gap: 10px; margin-bottom: 15px; }
        .comment .avatar-placeholder { width: 35px; height: 35px; border-radius: 8px; }
        .comment-content { background: #f7f7f7; padding: 10px 15px; border-radius: 12px; flex-grow: 1; }
        .comment-content strong { font-size: 0.9rem; color: var(--primary-color); }
        .comment-content p { font-size: 0.95rem; margin: 5px 0 0 0; line-height: 1.4; white-space: pre-wrap; word-wrap: break-word; }
        .comment-content p strong { font-weight: bold; } .comment-content p em { font-style: italic; } .comment-content p s { text-decoration: line-through; }
        .comment-form { display: flex; gap: 10px; }
        .comment-form input { flex-grow: 1; border-radius: 20px; padding-left: 15px; }
        .comment-form button { background: var(--accent-color); border: none; border-radius: 50%; width: 45px; height: 45px; font-size: 1.1rem; color: var(--text-color); cursor: pointer; flex-shrink: 0; }
        #edit-post-modal textarea { min-height: 120px; }

        /* --- GOOGLE SEARCH --- */
        .header-search-container {
            width: 100%;
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--white-color);
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.07);
        }
        
        /* RESPONSIVENESS FOR AUTH MODAL (SIGNUP FORM FIX) */
        @media (max-width: 480px) {
            #auth-modal-overlay, .modal-overlay-container { align-items: flex-start; padding-top: 5vh; }
            .auth-card, .modal-card { padding: 25px 20px; max-height: 90vh; overflow-y: auto; }
            .auth-card h2, .modal-card h2 { font-size: 1.4rem; }
            .avatar-uploader label { width: 100px; height: 100px; }
            .form-group { margin-bottom: 12px; }
            .user-type-selection { gap: 10px; margin-bottom: 20px; }
            .user-type-selection label { padding: 8px 15px; }
        }

        /* --- LIVE STREAM MODAL STYLES --- */
        #go-live-modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 4000;
            justify-content: center; align-items: center;
        }
        #buy-empy-modal.modal-overlay-container, #promotion-modal-overlay.modal-overlay-container { z-index: 4001; }
        
        .live-stream-container {
            width: 100%; max-width: 450px; height: 80vh; max-height: 700px;
            background: #222; border-radius: 15px; overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            position: relative; color: white;
            display: flex; flex-direction: column;
            background-size: cover; background-position: center;
        }
        .live-stream-container::before { /* Gradient overlay */
            content: ''; position: absolute; top:0; left:0; width:100%; height:100%;
            background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.3) 50%, transparent 100%);
            z-index: 1; pointer-events: none;
        }
        .live-header, .live-footer, .live-body { position: relative; z-index: 2; padding: 15px; }
        .live-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .live-host-info { display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.4); padding: 5px 10px; border-radius: 25px; cursor:pointer; }
        .live-host-info img { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--accent-color); }
        .live-host-info strong { font-size: 1rem; }
        .live-host-info .fa-heart { color: var(--danger-color); margin-left: 5px; }
        .live-stats { display: flex; align-items: center; gap: 10px; }
        .live-stat-item { background: rgba(0,0,0,0.4); padding: 8px 12px; border-radius: 20px; font-weight: bold; font-size: 0.9rem; cursor: pointer;}
        .live-stat-item i { margin-right: 5px; }
        .live-stat-item.recording { color: var(--danger-color); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 var(--danger-color); } 70% { box-shadow: 0 0 0 10px rgba(244,67,54,0); } 100% { box-shadow: 0 0 0 0 rgba(244,67,54,0); } }
        
        .live-body { flex-grow: 1; display: flex; flex-direction: column-reverse; overflow: hidden; }
        .live-comments-container { height: 25vh; overflow-y: auto; display: flex; flex-direction: column-reverse; -ms-overflow-style: none; scrollbar-width: none;}
        .live-comments-container::-webkit-scrollbar { display: none; }
        .live-comment { background: rgba(0,0,0,0.3); padding: 8px 12px; border-radius: 10px; margin-bottom: 8px; animation: slideInUp 0.3s; align-self: flex-start; max-width: 90%;}
        @keyframes slideInUp { from { opacity: 0; transform: translateY(20px); } }
        .live-comment strong { color: var(--accent-color); font-size: 0.9rem; }
        .live-comment p { font-size: 0.95rem; margin: 2px 0 0; word-wrap: break-word; white-space: pre-wrap; }
        .live-comment p strong { font-weight: bold; } .live-comment p em { font-style: italic; } .live-comment p s { text-decoration: line-through; }
        
        #gift-animation-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 3; pointer-events: none; overflow: hidden; }
        .gift-animation { position: absolute; font-size: 3rem; animation: floatUpAndFade 3s ease-out forwards; }
        @keyframes floatUpAndFade { 0% { opacity: 1; transform: translateY(0) scale(0.5); } 100% { opacity: 0; transform: translateY(-300px) scale(1.5) rotate(360deg); } }

        .like-bubble { position: absolute; bottom: 80px; right: 20px; font-size: 2rem; color: var(--danger-color); animation: bubbleUp 1.5s ease-out forwards; opacity: 0.8; }
        @keyframes bubbleUp { 0% { transform: translateY(0) scale(1); opacity: 0.8; } 100% { transform: translateY(-200px) scale(1.5); opacity: 0; } }

        .live-footer { display: flex; gap: 10px; align-items: center; }
        .live-footer form { flex-grow: 1; display: flex; gap: 10px; }
        .live-footer input { flex-grow: 1; background: rgba(0,0,0,0.4); border: 1px solid #555; border-radius: 25px; padding: 12px 20px; color: white; }
        .live-footer .live-action-btn { background: rgba(0,0,0,0.4); width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: white; cursor:pointer; border: 1px solid #555; flex-shrink: 0;}
        #live-gift-btn { color: var(--accent-color); }
        
        #live-gift-catalog-modal, #live-viewers-modal { display: none; position: absolute; bottom: 0; left: 0; width: 100%; height: 50%; background: #2a2a2e; border-top-left-radius: 20px; border-top-right-radius: 20px; z-index: 4; padding: 20px; flex-direction: column; animation: slideUpModal 0.3s; }
        #live-gift-catalog-modal.show, #live-viewers-modal.show { display: flex; }
        @keyframes slideUpModal { from { transform: translateY(100%); } }
        #live-gift-catalog-modal h3, #live-viewers-modal h3 { text-align: center; margin-bottom: 15px; }
        .gift-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px; overflow-y: auto; }
        .gift-item { display: flex; flex-direction: column; align-items: center; justify-content: center; background: #3c3c42; padding: 10px; border-radius: 10px; cursor: pointer; transition: background 0.2s; }
        .gift-item:hover { background: var(--secondary-color); }
        .gift-item .symbol { font-size: 2rem; }
        .gift-item .price { font-size: 0.8rem; font-weight: bold; color: var(--accent-color); margin-top: 5px; }
        .gift-item .price i { font-size: 0.7rem; }
        
        .viewer-list { overflow-y: auto; }
        .viewer-item { display: flex; align-items: center; gap: 15px; padding: 10px; border-bottom: 1px solid #444; }
        .viewer-item:last-child { border-bottom: none; }
        .viewer-item img { width: 40px; height: 40px; border-radius: 50%; }
        .viewer-item-info { flex-grow: 1; }
        .viewer-actions button { background: var(--secondary-color); border: none; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; cursor: pointer; }
        
        #host-avatar-container { position: absolute; top: 100px; left: 15px; z-index: 2; width: 100px; }
        #host-avatar-container .host-box { width: 100%; height: 80px; background: rgba(0,0,0,0.5); border: 2px solid var(--accent-color); border-radius: 8px; }
        #host-avatar-container img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }

        #multi-guest-container { position: absolute; top: 100px; right: 15px; z-index: 2; width: 120px; }
        #multi-guest-slots { display: grid; grid-template-columns: repeat(4, 1fr)); gap: 5px; }
        .guest-slot { width: 100%; padding-bottom: 100%; /* 1:1 Aspect Ratio */ position: relative; background: rgba(0,0,0,0.5); border: 1px dashed #777; border-radius: 8px; }
        .guest-slot > * { position: absolute; top:0; left:0; width:100%; height:100%; display:flex; align-items:center; justify-content:center; }
        .guest-slot img { object-fit: cover; border-radius: 8px; }

        #go-live-form #live-bg-selector { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-top:10px; }
        #go-live-form .bg-thumb { width: 80px; height: 120px; border-radius: 8px; flex-shrink: 0; cursor: pointer; border: 3px solid transparent; transition: border-color 0.3s; background-size: cover; background-position: center;}
        #go-live-form .bg-thumb img { width:100%; height:100%; object-fit:cover; border-radius: 5px; }
        #go-live-form .bg-thumb.active { border-color: var(--primary-color); }
        
        /* --- DASHBOARD LIVE STREAM SLIDER --- */
        #dashboard-live-container { display: block; } /* Make visible by default */
        .live-stream-preview-card {
            flex: 0 0 180px; width: 180px; height: 250px; position: relative;
            border-radius: 12px; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            background-size: cover; background-position: center;
            display: flex; flex-direction: column; justify-content: space-between;
            padding: 10px; color: white; cursor: pointer;
        }
        .live-stream-preview-card::before {
            content:''; position: absolute; top:0; left:0; width:100%; height:100%; z-index:1;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            pointer-events: none; 
        }
        .live-preview-header, .live-preview-footer { position: relative; z-index: 2; }
        .live-tag { background: var(--danger-color); padding: 2px 8px; border-radius: 5px; font-size: 0.8rem; font-weight: bold; display: inline-block;}
        .live-preview-footer .host-name { font-weight: bold; }
        .live-preview-footer .stream-title { font-size: 0.9rem; line-height: 1.2; }

        /* --- ADMIN PANEL --- */
        .admin-queue-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid var(--light-gray); transition: opacity 0.3s ease; }
        .admin-queue-item:last-child { border-bottom: none; }
        .admin-queue-info { flex-grow: 1; }
        .admin-queue-info p { margin: 0; }
        .admin-queue-actions { display: flex; gap: 10px; }
        
        /* --- MESSAGING SYSTEM --- */
        #messages-view { display: flex; height: calc(100vh - 120px); background: var(--white-color); border-radius: 8px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.07);}
        .contact-list { width: 300px; border-right: 1px solid var(--light-gray); overflow-y: auto; }
        .contact-item { display: flex; align-items: center; gap: 15px; padding: 15px; cursor: pointer; border-bottom: 1px solid var(--light-gray); }
        .contact-item:hover, .contact-item.active { background: #f9f6fc; }
        .contact-item .avatar-placeholder { width: 50px; height: 50px; border-radius: 50%; }
        .chat-view { flex-grow: 1; display: flex; flex-direction: column; }
        .chat-header { padding: 15px; border-bottom: 1px solid var(--light-gray); display: flex; align-items: center; gap: 15px; cursor: pointer;}
        .chat-header .avatar-placeholder { width: 40px; height: 40px; border-radius: 50%; }
        .chat-messages { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .message { max-width: 70%; padding: 10px 15px; border-radius: 18px; line-height: 1.4; }
        .message.sent { background: var(--primary-color); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .message.received { background: var(--light-gray); color: var(--text-color); align-self: flex-start; border-bottom-left-radius: 4px; }
        .message-media { max-width: 100%; border-radius: 15px; margin-top: 5px;}
        .message-input-area { padding: 15px; border-top: 1px solid var(--light-gray); display: flex; gap: 10px; align-items: center; }
        .message-input-area input[type="text"] { flex-grow: 1; padding: 12px 20px; border: 1px solid #ccc; border-radius: 25px; }
        .message-input-area .btn { border-radius: 50%; width: 48px; height: 48px; padding: 0; display:flex; align-items:center; justify-content:center; flex-shrink: 0; }
        
        /* --- PROFILE GALLERY --- */
        #profile-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .gallery-item { position: relative; height: 200px; border-radius: 8px; overflow: hidden; cursor: pointer; background: #eee; }
        .gallery-item img, .gallery-item video { width: 100%; height: 100%; object-fit: cover; }
        
        /* --- MINIMIZED PROFILE & BIO --- */
        #profile-extended-info { display: none; margin-top: 20px; }
        #profile-bio { min-height: auto; max-height: 60px; /* Approx 3 lines */ transition: max-height 0.3s ease-out; overflow: hidden; }
        #profile-bio.expanded { max-height: 200px; }
        .bio-container { position: relative; }
        #toggle-bio-btn, #toggle-profile-info-btn { font-size: 0.9rem; color: var(--primary-color); text-decoration: underline; cursor: pointer; margin-top: 5px; display: inline-block; background: none; border: none; padding: 0; }
        #toggle-profile-info-btn { margin-top: 15px; font-weight: bold; }


        /* --- STATUS FEATURE --- */
        #dashboard-status-container .card { background: none; box-shadow: none; padding:0; }
        .status-slider-wrapper { display: flex; overflow-x: auto; gap: 15px; padding: 5px 25px 15px 25px; white-space: nowrap; -webkit-overflow-scrolling: touch; }
        .status-item { flex: 0 0 80px; text-align: center; cursor: pointer; }
        .status-avatar { position: relative; width: 70px; height: 70px; border-radius: 50%; margin: 0 auto 5px; display: flex; align-items: center; justify-content: center; background: #ddd; }
        .status-avatar::before { content: ''; position: absolute; top: -4px; left: -4px; right: -4px; bottom: -4px; border-radius: 50%; border: 3px solid; transition: border-color 0.3s; }
        .status-item.new .status-avatar::before { border-color: var(--status-new-color); }
        .status-item.viewed .status-avatar::before { border-color: var(--status-viewed-color); }
        .status-avatar img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; border: 3px solid white; }
        .status-item span { font-size: 0.85rem; }
        .status-item .multi-status-indicator { position: absolute; top: 0; right: 0; width: 18px; height: 18px; background-color: var(--accent-color); color: var(--text-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; border: 2px solid white; }

        #status-modal-overlay { display: none; z-index: 5000; background: rgba(10,10,10,0.95); }
        #status-modal-content { max-width: 500px; width:100%; height: 95vh; background: #111; padding: 0; position: relative; overflow:hidden;}
        #status-progress-bar-container { position: absolute; top: 10px; left: 10px; right: 10px; display: flex; gap: 4px; z-index: 2; }
        .progress-bar { flex-grow: 1; height: 3px; background: rgba(255,255,255,0.3); border-radius: 3px; }
        .progress-bar .progress { width: 0%; height: 100%; background: white; border-radius: 3px;}
        .progress-bar .progress.full { width: 100%; }
        #status-media-container { width:100%; height:100%; display:flex; align-items:center; justify-content:center; position:relative; }
        #status-media-container img, #status-media-container video { max-width: 100%; max-height: 100%; object-fit: contain; }
        #status-sound-toggle { position: absolute; top: 60px; right: 15px; z-index: 5; font-size: 1.2rem; color: white; background: rgba(0,0,0,0.4); border-radius: 50%; width: 40px; height: 40px; display: none; align-items: center; justify-content: center; cursor: pointer; }
        #status-text-container { width:100%; height:100%; display:flex; align-items:center; justify-content:center; padding: 40px; font-size: 1.8rem; color: white; text-align: center; }
        .status-caption { position: absolute; bottom: 20px; left: 20px; right: 20px; text-align: center; color: white; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 8px; z-index: 2;}
        .status-nav { position: absolute; top: 0; width: 30%; height: 100%; z-index: 3; cursor: pointer; }
        #status-nav-prev { left: 0; }
        #status-nav-next { right: 0; }
        #status-header-actions { position: absolute; top: 20px; right: 15px; z-index: 4; display: flex; gap: 15px; }
        #status-header-actions .action-btn { color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); font-size: 1.2rem; }

        #create-status-modal .modal-card { max-width: 500px; }
        .status-type-selector { display: flex; justify-content: space-around; margin-bottom: 20px; }
        #status-text-input-area { display:none; }
        #status-media-preview-container { margin-top: 10px; text-align: center; }
        #status-media-preview-container img, #status-media-preview-container video { max-width: 150px; max-height: 150px; border-radius: 8px; } /* Increased size for visibility */
        #status-text-input { font-size: 1.5rem; text-align: center; border:none; background: #eee; padding: 20px; min-height: 150px; }
        #color-palette { display: flex; justify-content: center; gap: 10px; margin-top: 10px; flex-wrap: wrap;}
        .color-swatch { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
    
        /* --- SOS & PAYMENT MODALS --- */
        #sos-donation-modal .modal-card, #buy-empy-modal .modal-card { max-width: 550px; text-align: left;}
        .payment-tabs { display: flex; border-bottom: 1px solid var(--light-gray); margin-bottom: 20px; }
        .payment-tab { padding: 10px 20px; cursor: pointer; color: #888; font-weight: bold; border-bottom: 3px solid transparent; }
        .payment-tab.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .payment-method-content { display: none; }
        .payment-method-content.active { display: block; }
        .crypto-address-box { background: #f0f0f0; padding: 15px; border-radius: 5px; font-family: 'Courier New', monospace; word-wrap: break-word; }

        /* --- CRISIS REPORT ENHANCEMENTS --- */
        .map-placeholder { height: 150px; background: #e0e0e0; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #888; text-align: center; border: 1px solid #ccc; margin-bottom: 10px; }
        #crisis-location-coords { font-size: 0.9em; font-style: italic; color: var(--success-color); }

        /* --- FULL SCREEN REEL VIEWER --- */
        #reel-viewer-modal-overlay { display: none; position: fixed; inset: 0; background: #000; z-index: 6000; }
        .reel-viewer-container { width: 100%; height: 100%; overflow-y: auto; scroll-snap-type: y mandatory; }
        .reel-viewer-item { width: 100%; height: 100%; position: relative; scroll-snap-align: start; display: flex; align-items: center; justify-content: center; }
        .reel-viewer-item video { width: 100%; height: 100%; object-fit: contain; }
        .reel-viewer-close { position: absolute; top: 20px; left: 20px; font-size: 1.8rem; color: white; background: rgba(0,0,0,0.5); border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; z-index: 10; }
        .reel-viewer-info { position: absolute; bottom: 20px; left: 20px; right: 20px; color: white; z-index: 5; text-shadow: 1px 1px 3px rgba(0,0,0,0.7); display: flex; justify-content: space-between; align-items: flex-end; }
        .reel-viewer-actions { display: flex; flex-direction: column; gap: 15px; align-items: center; }
        .reel-viewer-actions .action-btn { font-size: 1.5rem; color: white; background: rgba(0,0,0,0.4); border-radius: 50%; width: 50px; height: 50px; display: flex; flex-direction:column; align-items: center; justify-content: center; text-decoration: none; }
        .reel-viewer-actions .action-btn span { font-size: 0.8rem; margin-top: 4px; }


        /* --- KYC FORM STYLES --- */
        #kyc-entity-selector { display: grid; grid-template-columns: repeat(2, 1fr)); gap: 20px; }
        .kyc-entity-btn {
            background: var(--white-color); border: 2px solid var(--light-gray); border-radius: 8px;
            padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s ease;
        }
        .kyc-entity-btn:hover { border-color: var(--secondary-color); transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .kyc-entity-btn.active { border-color: var(--primary-color); background-color: #f8f5fc; color: var(--primary-color); }
        .kyc-entity-btn i { font-size: 2rem; display: block; margin-bottom: 10px; color: var(--primary-color); }
        .kyc-entity-btn span { font-weight: bold; font-size: 1.1rem; }
        .kyc-form { display: none; animation: fadeIn 0.4s; }
        .kyc-form.active { display: block; }
        .upload-area { border: 2px dashed var(--light-gray); border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; }
        .upload-area:hover { border-color: var(--primary-color); }
        .upload-area i { font-size: 1.5rem; margin-bottom: 10px; }
        .upload-area span { font-weight: 500; }
        .live-capture-btn { margin-top: 10px; }
        .date-select-group { display: flex; gap: 10px; }

        /* --- SETTINGS PAGE STYLES --- */
        .settings-tabs { display: flex; border-bottom: 1px solid var(--light-gray); margin-bottom: 20px; }
        .settings-tab { padding: 15px 25px; cursor: pointer; color: #555; font-weight: 600; border-bottom: 3px solid transparent; }
        .settings-tab.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .settings-content { display: none; }
        .settings-content.active { display: block; animation: fadeIn 0.4s; }
        .static-content p, .static-content h3, .static-content h4, .static-content li { margin-bottom: 1em; }
        .static-content ul, .static-content ol { padding-left: 20px; }
        .static-content blockquote { border-left: 4px solid var(--light-gray); padding-left: 15px; margin: 1em 0; font-style: italic; }
        .session-item { display:flex; justify-content:space-between; align-items:center; padding:10px; border:1px solid #eee; border-radius:5px; margin-bottom:10px; }

        /* --- MONETIZATION & ANALYTICS --- */
        .profile-tabs { display: flex; border-bottom: 1px solid var(--light-gray); margin-top: -30px; } /* MODIFIED for cover */
        .profile-tab { padding: 15px 25px; cursor: pointer; font-weight: 600; color: #555; border-bottom: 3px solid transparent; }
        .profile-tab.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .profile-tab-content { display: none; padding: 25px 0 0 0; }
        .profile-tab-content.active { display: block; animation: fadeIn 0.4s; }
        .analytics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .stat-card { background: #f9f9f9; padding: 20px; border-radius: 8px; text-align: center; }
        .stat-card h4 { color: var(--primary-color); }
        .stat-card .stat-value { font-size: 2rem; font-weight: bold; margin: 10px 0; }
        #marketplace-media-preview { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        .media-thumbnail { position: relative; width: 100px; height: 100px; }
        .media-thumbnail img, .media-thumbnail video { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }
        .remove-media-btn { position: absolute; top: -5px; right: -5px; background: var(--danger-color); color: white; border-radius: 50%; width: 22px; height: 22px; border: none; font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 1; }

        /* --- MARKETPLACE GALLERY MODAL --- */
        #marketplace-gallery-modal { z-index: 7000; }
        .gallery-modal-content { max-width: 90vw; max-height: 90vh; background: #111; padding: 15px; text-align: center; }
        .gallery-main-image-container { width: 100%; height: 70vh; display:flex; align-items:center; justify-content:center; margin-bottom: 15px; position:relative; }
        .gallery-main-image-container img, .gallery-main-image-container video { max-width: 100%; max-height: 100%; object-fit: contain; }
        .gallery-nav-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.5rem; cursor: pointer; z-index: 1; }
        #gallery-prev-btn { left: 10px; }
        #gallery-next-btn { right: 10px; }
        .gallery-thumbnails { display: flex; gap: 10px; justify-content: center; overflow-x: auto; padding-bottom: 5px; }
        .gallery-thumbnail { width: 80px; height: 80px; cursor: pointer; border: 2px solid transparent; border-radius: 8px; overflow: hidden; }
        .gallery-thumbnail img, .gallery-thumbnail video { width: 100%; height: 100%; object-fit: cover; }
        .gallery-thumbnail.active { border-color: var(--accent-color); }

        /* --- MARKETPLACE ENHANCEMENTS & DIRECT TRADE --- */
        #marketplace-text-fields { display: none; }
        .property-description { margin-bottom: 15px; font-size: 0.95rem; line-height: 1.5; color: #444; }
        .property-description strong { font-weight: bold; } .property-description em { font-style: italic; } .property-description s { text-decoration: line-through; }
        .verified-badge-small { font-size: 0.8rem; color: var(--success-color); margin-left: 5px;}
        .unverified-badge-small { font-size: 0.8rem; color: var(--danger-color); margin-left: 5px;}
        .star-rating { color: var(--accent-color); }
        .property-seller-info { display: flex; align-items: center; justify-content: space-between; padding: 0 20px 10px 20px; }
        .direct-trade-warning, .direct-contact-info { display: none; padding: 0 20px 15px 20px; }
        .direct-trade-warning { background: #fff8e1; border-top: 1px solid #eee; border-bottom: 1px solid #eee; padding-top: 15px; font-size: 0.9rem;}
        .direct-trade-warning strong { color: #f57c00; }
        .direct-contact-info p { margin-bottom: 5px; font-size: 0.9rem; }
        .dispute-section { border: 1px solid var(--danger-color); padding: 15px; border-radius: 5px; margin-top: 20px; background: #fff5f5; }
        .inspection-report { margin-top: 15px; }
        .inspection-report label { font-weight: bold; }
        .property-actions { padding: 0 20px 20px 20px; }
        .contact-seller-btn { width: 100%; }
        .promote-item-btn { margin-top: 10px; width: 100%; background-color: var(--accent-color); color: var(--text-color); }
        
        /* --- PROMOTION MODAL FIXES --- */
        #promotion-payment-details { display: none; }

        /* --- NEW: GRANT PORTAL & COMMUNITY TASKS --- */
        .table-container { overflow-x: auto; }
        .styled-table { width: 100%; border-collapse: collapse; margin: 25px 0; font-size: 0.9em; box-shadow: 0 0 20px rgba(0, 0, 0, 0.15); }
        .styled-table thead tr { background-color: var(--primary-color); color: #ffffff; text-align: left; }
        .styled-table th, .styled-table td { padding: 12px 15px; }
        .styled-table tbody tr { border-bottom: 1px solid #dddddd; }
        .styled-table tbody tr:nth-of-type(even) { background-color: #f3f3f3; }
        .styled-table tbody tr:last-of-type { border-bottom: 2px solid var(--primary-color); }
        .tx-hash { font-family: 'Courier New', monospace; font-size: 0.85em; color: var(--secondary-color); text-decoration: none; }
        .tx-hash:hover { text-decoration: underline; }
        .status-completed { color: var(--success-color); font-weight: bold; }
        .task-list { list-style: none; }
        .task-item { background: #fff; padding: 15px; border-radius: 5px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .task-item i { color: var(--primary-color); margin-right: 10px; font-size: 1.2rem; }
        
        /* --- FIX 3: NGO SLIDER STYLES --- */
        #ngo-grid-view .ngo-card {
            flex: 0 0 280px; /* Give cards a fixed width so they slide */
        }
        
        .ngo-profile-header { display: flex; gap: 20px; align-items: center; padding: 25px; background: #f9f6fc; border-radius: 8px; }
        .ngo-profile-header .avatar-placeholder { width: 100px; height: 100px; border-radius: 50%; flex-shrink: 0; }
        .ngo-impact-stats { display: grid; grid-template-columns: repeat(3, 1fr)); gap: 15px; margin: 25px 0; text-align: center; }
        .ngo-impact-stats .stat-value { font-size: 1.5rem; font-weight: bold; color: var(--primary-color); }

        /* --- NEW: BUSINESS PAGE ENHANCEMENTS --- */
        .business-page-header { position: relative; }
        .business-page-header .profile-header { transform: translateY(-60px); }
        .business-page-header .profile-pic { width: 150px; height: 150px; object-fit: cover; border-radius: 8px !important; }
        .business-page-header .avatar-placeholder { width: 150px; height: 150px; border-radius: 8px !important; }
        .business-page-header .profile-header-info { padding-top: 60px; }
        .business-page-content h4 { color: var(--primary-color); border-bottom: 2px solid var(--light-gray); padding-bottom: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .business-page-content .edit-icon { font-size: 0.9rem; color: var(--secondary-color); cursor: pointer; }
        .business-page-content p { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .business-page-content p .edit-icon { margin-left: auto; }
        #create-page-prompt { text-align: center; padding: 40px; }
        #business-page-feed-tab { padding-top: 0 !important; }
        #business-page-feed-container { margin-top: 30px; }
        #business-page-tabs { margin-top: -30px; }

        /* --- Suggested Users UI Enhancement --- */
        #suggested-users-container { margin-top: 30px; }
        .suggested-user-card {
            flex: 0 0 180px; text-align: center;
            background: white; border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            overflow: hidden; 
            position: relative;
            padding-top: 60px;
            cursor: pointer; /* Make it look clickable */
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .suggested-user-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        .suggested-user-cover {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 70px;
            background-color: var(--light-gray);
            background-size: cover;
            background-position: center;
        }
        .suggested-user-card .avatar-placeholder {
            width: 70px; height: 70px; border-radius: 50%;
            margin: -35px auto 10px auto;
            position: relative;
            border: 3px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .suggested-user-card-info {
             padding: 0 15px 15px 15px;
        }
        .suggested-user-card-info strong { font-size: 1rem; color: var(--primary-color); display: block; }
        .suggested-user-card-info p { font-size: 0.9rem; color: #666; margin-bottom: 15px; }

        /* --- NEW: GOOGLE SIGNUP BUTTON --- */
        .auth-card .separator { display: flex; align-items: center; text-align: center; color: #888; margin: 20px 0; }
        .auth-card .separator::before, .auth-card .separator::after { content: ''; flex: 1; border-bottom: 1px solid #ccc; }
        .auth-card .separator:not(:empty)::before { margin-right: .25em; }
        .auth-card .separator:not(:empty)::after { margin-left: .25em; }
        .btn-google { background-color: #fff; color: #444; border: 1px solid #ccc; width: 100%; margin-top: 10px; }
        .btn-google:hover { background-color: #f5f5f5; }
        .btn-google i { color: #DB4437; margin-right: 10px; }

        /* --- NEW: BUSINESS PAGE CREATION MODAL --- */
        #create-business-page-modal .modal-card { max-width: 600px; text-align: left; }
        .page-image-uploader { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; }
        .page-cover-photo-preview { width: 100%; height: 150px; background: #eee; border-radius: 8px; margin-bottom: -50px; background-size: cover; background-position: center; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #888; border: 2px dashed var(--light-gray); }
        .page-profile-photo-preview { width: 100px; height: 100px; border-radius: 50%; background: #ddd; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer; background-size: cover; background-position: center; }
    
        /* --- WHITEPAPER STYLES --- */
        #whitepaper-container { background-color: #7B1FA2; background-attachment: fixed; }
        #whitepaper-container * { box-sizing: border-box; margin: 0; padding: 0; }
        #whitepaper-container html { scroll-behavior: smooth; }
        #whitepaper-container body {
            font-family: 'Roboto', sans-serif;
            color: #141414;
            line-height: 1.6;
            font-size: 16px;
        }
        /* --- FIX 4: Widened the whitepaper container --- */
        #whitepaper-container .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
        #whitepaper-container header { padding: 40px 20px; text-align: center; color: #ffffff; position: relative; }
        #whitepaper-container .logo-uploader {
            position: relative; width: 140px; height: 140px; margin: 0 auto 30px auto; border-radius: 50%;
            border: 5px solid #fbc400; background-color: rgba(255,255,255,0.1); box-shadow: 0 0 25px rgba(251, 196, 0, 0.4);
            cursor: pointer; transition: transform 0.3s, box-shadow 0.3s; display: flex; align-items: center; justify-content: center; overflow: hidden;
        }
        #whitepaper-container .logo-uploader:hover { transform: scale(1.05); box-shadow: 0 0 35px rgba(251, 196, 0, 0.7); }
        #whitepaper-container #logo-placeholder { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
        #whitepaper-container .logo-uploader .upload-text { position: absolute; color: #ffffff; font-weight: bold; background-color: rgba(0,0,0,0.4); padding: 5px 10px; border-radius: 5px; pointer-events: none; }
        #whitepaper-container #logo-upload-input { display: none; }
        #whitepaper-container header h1 { font-family: 'Poppins', sans-serif; font-size: 3em; text-shadow: 2px 2px 8px rgba(0,0,0,0.5); }
        #whitepaper-container header p { font-size: 1.2em; color: #fbc400; font-weight: 700; text-shadow: 1px 1px 5px rgba(0,0,0,0.5); }
        #whitepaper-container h2 { font-family: 'Poppins', sans-serif; color: #3d1b63; font-size: 1.9em; border-bottom: 3px solid #fbc400; padding-bottom: 15px; margin-bottom: 20px; }
        #whitepaper-container h3 { font-family: 'Poppins', sans-serif; color: #3d1b63; font-size: 1.6em; margin-top: 30px; margin-bottom: 15px; }
        #whitepaper-container h4 { font-family: 'Poppins', sans-serif; color: #141414; font-weight: 600; font-size: 1.2em; margin-top: 25px; margin-bottom: 10px; }
        #whitepaper-container nav {
            background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(12px); padding: 10px; border-radius: 50px;
            border: 1px solid rgba(255, 255, 255, 0.2); position: sticky; top: 80px; z-index: 100; margin: 20px auto;
            max-width: 95%; width: fit-content; display: flex; justify-content: center; align-items: center; flex-wrap: wrap; box-shadow: 0 10px 35px rgba(0, 0, 0, 0.1);
        }
        #whitepaper-container nav a { color: #141414; text-decoration: none; font-weight: 700; padding: 8px 15px; transition: color 0.3s, background-color 0.3s; border-radius: 50px; font-size: 0.9em; margin: 2px; }
        #whitepaper-container nav a:hover { color: #ffffff; background-color: #3d1b63; }
        #whitepaper-container .action-button {
            background-color: #fbc400; color: #141414; padding: 15px 30px; border: 2px solid #141414; border-radius: 50px;
            cursor: pointer; font-weight: 700; font-size: 1em; text-transform: uppercase; transition: all 0.3s;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2); margin-top: 30px;
        }
        #whitepaper-container .action-button:hover { background-color: #3d1b63; color: #ffffff; border-color: #fbc400; transform: translateY(-3px); box-shadow: 0 6px 25px rgba(0, 0, 0, 0.3); }
        #whitepaper-container .action-button:disabled { background-color: #ccc; cursor: not-allowed; }
        #whitepaper-container #content-to-pdf { background-color: #ffffff; padding: 50px; border-radius: 12px; box-shadow: 0 10px 35px rgba(0, 0, 0, 0.1); margin-top: 20px; }
        #whitepaper-container section { margin-bottom: 40px; }
        #whitepaper-container ul, #whitepaper-container ol { padding-left: 25px; }
        #whitepaper-container li { color: #4a4a4a; text-align: left; margin-bottom: 15px; }
        #whitepaper-container #content-to-pdf p { color: #4a4a4a; text-align: left; margin-bottom: 16px; }
        #whitepaper-container strong { color: #3d1b63; font-weight: 700; }
        #whitepaper-container .features-grid {
            display: flex; flex-wrap: nowrap; overflow-x: auto; gap: 30px; margin-top: 30px; padding-bottom: 20px;
            -webkit-overflow-scrolling: touch; scrollbar-width: thin; scrollbar-color: #fbc400 #f0f0f0;
        }
        #whitepaper-container .features-grid::-webkit-scrollbar { height: 8px; }
        #whitepaper-container .features-grid::-webkit-scrollbar-track { background: #f0f0f0; border-radius: 4px; }
        #whitepaper-container .features-grid::-webkit-scrollbar-thumb { background-color: #fbc400; border-radius: 4px; }
        #whitepaper-container .feature-card {
            flex: 0 0 280px; background: #f9f9f9; padding: 25px; text-align: center; border-radius: 12px;
            border-bottom: 5px solid #fbc400; box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: transform 0.3s, box-shadow 0.3s;
        }
        #whitepaper-container .feature-card p { text-align: center; margin-bottom: 0; }
        #whitepaper-container .feature-card:hover { transform: translateY(-10px); box-shadow: 0 12px 30px rgba(0,0,0,0.1); }
        #whitepaper-container .feature-icon { height: 120px; margin-bottom: 10px; }
        #whitepaper-container .feature-card h3 { font-size: 1.3em; }
        #whitepaper-container .pdf-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); z-index: 8000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        #whitepaper-container .modal-content { background-color: #fff; padding: 20px; border-radius: 12px; width: 90%; max-width: 800px; height: 90%; display: flex; flex-direction: column; }
        #whitepaper-container .modal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; border-bottom: 1px solid #ccc; }
        #whitepaper-container .modal-header h2 { font-size: 1.5em; border: none; padding: 0; margin: 0; }
        #whitepaper-container .close-button { font-size: 2em; cursor: pointer; color: #888; transition: color 0.2s; }
        #whitepaper-container .close-button:hover { color: #000; }
        #whitepaper-container .pdf-preview-area { flex-grow: 1; margin: 20px 0; border: 1px solid #ccc; overflow: hidden; }
        #whitepaper-container #pdf-embed { width: 100%; height: 100%; }
        #whitepaper-container .modal-footer { text-align: right; padding-top: 15px; border-top: 1px solid #ccc; }
        #whitepaper-container #confirm-download-btn { background-color: #3d1b63; color: white; border: none; }
        #whitepaper-container .disclaimer { color: #555; background-color: #fff9e6; border-left: 4px solid #fbc400; padding: 20px; border-radius: 8px; margin-top: 30px; font-style: italic; }
        #whitepaper-container footer { text-align: center; padding: 40px 20px; color: #FFFFFF; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); }
        #whitepaper-container footer p { color: #FFFFFF !important; }

    </style>
</head>
<body>
    <div id="reward-notification"></div>

    <div id="auth-modal-overlay" class="modal-overlay-container">
        <div class="auth-card">
            <button class="close-modal" title="Close">×</button>
            <div id="login-view">
                <h2><i class="fas fa-hands-holding-circle"></i> Welcome Back</h2>
                <form id="login-form" novalidate>
                    <div class="form-group"><label for="login-email">Email</label><input type="email" id="login-email" name="login-email" required value="admin@empyrean.com"></div>
                    <div class="form-group"><label for="login-password">Password</label><input type="password" id="login-password" name="login-password" required value="adminpass"></div>
                    <div class="form-group">
                        <label for="login-captcha-input">Security Check</label>
                        <div class="captcha-group">
                            <span id="captcha-code"></span><button type="button" id="refresh-captcha" title="Refresh Code"><i class="fas fa-sync-alt"></i></button>
                            <input type="text" id="login-captcha-input" name="login-captcha" placeholder="Enter code" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-accent" style="width:100%;">Login</button>
                </form>
                <div class="separator">OR</div>
                <button type="button" class="btn btn-google"><i class="fab fa-google"></i> Sign in with Google</button>
                <p class="auth-switch">Need an account? <a href="#" id="show-signup">Sign Up</a><a href="#" id="show-forgot-password" class="forgot-password-link">Forgot Password?</a></p>
            </div>
            
            <div id="signup-view">
                <h2><i class="fas fa-user-plus"></i> Create Your Account</h2>
                <div id="signup-feedback" class="form-feedback"></div>
                <form id="signup-form" novalidate>
					<div class="avatar-uploader">
                        <label for="signup-avatar"><img src="" alt="Avatar Preview" id="avatar-preview"><div class="upload-icon"><i class="fas fa-camera"></i><span>Add Photo</span></div></label>
                        <input type="file" id="signup-avatar" name="signup-avatar" class="avatar-input" accept="image/*" style="display: none;">
                    </div>
                    <div class="form-group"><div class="user-type-selection"><input type="radio" id="type-individual" name="user-type" value="individual" checked><label for="type-individual"><i class="fas fa-user"></i> Individual</label><input type="radio" id="type-org" name="user-type" value="organisation"><label for="type-org"><i class="fas fa-sitemap"></i> Organisation</label></div></div>
                    <div id="individual-fields"><div class="grid-2"><div class="form-group"><label for="signup-fname">First Name</label><input type="text" id="signup-fname" name="signup-fname" placeholder="e.g., John" required></div><div class="form-group"><label for="signup-lname">Last Name</label><input type="text" id="signup-lname" name="signup-lname" placeholder="e.g., Doe" required></div></div></div>
                    <div id="org-fields"><div class="form-group"><label for="signup-orgname">Organisation Name</label><input type="text" id="signup-orgname" name="signup-orgname" placeholder="e.g., Empyrean Foundation"></div><div class="form-group"><label for="signup-org-reg">CAC REG No. / SCUML Cert. No.</label><input type="text" id="signup-org-reg" name="signup-org-reg" placeholder="Enter your registration number"></div></div>
                    <div class="form-group"><label for="signup-username">Username</label><input type="text" id="signup-username" name="signup-username" placeholder="e.g., johndoe99" required minlength="4"></div>
                    <div class="form-group"><label for="signup-email">Account Email</label><input type="email" id="signup-email" name="signup-email" required></div>
                    <div class="form-group"><label for="signup-phone">Phone Number</label><input type="tel" id="signup-phone" name="signup-phone" placeholder="e.g., +2348012345678" required></div>
                    <div class="form-group"><label for="signup-password">Password</label><input type="password" id="signup-password" name="signup-password" required minlength="8"></div>
                    <div class="form-group"><label for="signup-confirm-password">Confirm Password</label><input type="password" id="signup-confirm-password" name="signup-confirm-password" required minlength="8"></div>
                    
                    <button type="submit" class="btn btn-accent" style="width: 100%;">Create Account</button>
                    <div class="separator">OR</div>
                    <button type="button" class="btn btn-google"><i class="fab fa-google"></i> Sign up with Google</button>
                </form>
                <p class="auth-switch">Already have an account? <a href="#" id="show-login">Log In</a></p>
            </div>

            <div id="forgot-password-view">
                <h2><i class="fas fa-key"></i> Forgot Password</h2>
                <p>Enter your email and we'll send you a link to reset your password.</p>
                <form id="forgot-password-form" novalidate><div class="form-group"><label for="forgot-email">Email Address</label><input type="email" id="forgot-email" name="forgot-email" required></div><button type="submit" class="btn btn-accent">Send Reset Link</button></form>
                <p class="auth-switch">Remembered your password? <a href="#" id="back-to-login">Log In</a></p>
            </div>
        </div>
    </div>
    
    <div id="edit-post-modal-overlay" class="modal-overlay-container">
        <div class="modal-card">
            <button class="close-modal" title="Close">×</button>
            <h2>Edit Post</h2>
            <form id="edit-post-form" novalidate>
                <input type="hidden" id="edit-post-id" name="edit-post-id">
                <div class="form-group">
                    <label for="edit-post-text">Your Text</label>
                    <textarea id="edit-post-text" name="edit-post-text" rows="5" required></textarea>
                </div>
                <button type="submit" class="btn btn-accent">Save Changes</button>
            </form>
        </div>
    </div>
    
    <div id="go-live-modal-overlay" class="modal-overlay-container">
        <div class="live-stream-container" id="live-stream-screen">
            <div id="gift-animation-layer"></div>
            <div class="live-header">
                <div class="live-host-info" title="View Host Profile"><img id="live-host-avatar" src="https://images.unsplash.com/photo-1610482101487-790751923d38?q=80&w=200&auto=format&fit=crop" alt="Host"><div><strong id="live-host-name">Adewale Adebayo</strong><p style="font-size:0.8rem; color: #ccc;">@ade_adebayo</p></div><i class="fas fa-heart"></i></div>
                <div class="live-stats">
                    <span class="live-stat-item" id="live-record-btn" title="Start Recording"><i class="fas fa-circle"></i> Rec</span>
                    <span class="live-stat-item" id="live-like-count-container" title="Total Likes"><i class="fas fa-heart"></i> <span id="live-like-count">0</span></span>
                    <span class="live-stat-item live-viewers" title="Viewers"><i class="fas fa-users"></i> <span id="live-viewer-count">1</span></span>
                    <button class="close-modal" id="live-close-btn" title="Leave Stream">×</button>
                </div>
            </div>

            <div id="host-avatar-container">
                <div class="host-box" title="Host">
                     <img id="live-stream-host-avatar" src="https://source.unsplash.com/random/120x90/?portrait-host" alt="Host Avatar">
                </div>
            </div>
            <div id="multi-guest-container">
                <div id="multi-guest-slots">
                    <div class="guest-slot"></div><div class="guest-slot"></div><div class="guest-slot"></div><div class="guest-slot"></div>
                    <div class="guest-slot"></div><div class="guest-slot"></div><div class="guest-slot"></div><div class="guest-slot"></div>
                </div>
            </div>

            <div class="live-body"><div class="live-comments-container" id="live-comments-list"></div></div>
            <div class="live-footer">
                <form id="live-comment-form">
                    <input type="text" id="live-comment-input" placeholder="Say something..." required>
                    <button type="submit" class="live-action-btn" title="Send"><i class="fas fa-paper-plane"></i></button>
                </form>
                <button type="button" class="live-action-btn share-live-btn" title="Share Stream"><i class="fas fa-share"></i></button>
                <button type="button" class="live-action-btn" id="live-invite-btn" title="Invite a Guest"><i class="fas fa-user-plus"></i></button>
                <button type="button" class="live-action-btn" id="live-gift-btn" title="Send a Gift"><i class="fas fa-gift"></i></button>
            </div>

            <div id="live-gift-catalog-modal"><h3>Send a Gift <span id="live-user-empy-balance" style="font-size:0.9rem; color:#ccc;"></span></h3><div class="gift-grid" id="gift-grid-container"></div><button class="btn btn-accent" id="buy-empy-btn" style="width: 100%; margin-top: 15px;"><i class="fas fa-coins"></i> Buy EMPY Tokens</button></div>
            <div id="live-viewers-modal"><h3>Viewers (<span id="modal-viewer-count">1</span>)</h3><div class="viewer-list" id="viewer-list-container"></div></div>
        </div>
    </div>

    <div id="create-status-modal" class="modal-overlay-container">
        <div class="modal-card">
            <button class="close-modal" title="Close">×</button>
            <h2>Create Status</h2>
            <form id="create-status-form">
                <div class="status-type-selector">
                    <label class="btn"><i class="fas fa-photo-video"></i> Media<input type="radio" name="status-type" value="media" class="status-type-input" style="display:none;" checked></label>
                    <label class="btn"><i class="fas fa-font"></i> Text<input type="radio" name="status-type" value="text" class="status-type-input" style="display:none;"></label>
                </div>
                <div id="status-media-input-area">
                    <label for="status-media-upload" class="btn btn-media-upload" style="width:100%; text-align:center;">Select Image/Video</label>
                    <input type="file" id="status-media-upload" accept="image/*,video/*" style="display:none;">
                    <div id="status-media-preview-container"></div>
                    <p style="font-size:0.8rem; text-align:center; margin-top:5px;">Videos over 2:00 will be split.</p>
                    <div class="form-group" style="margin-top:15px;"><label for="status-media-caption">Caption</label><input type="text" id="status-media-caption" placeholder="Add a caption..."></div>
                </div>
                <div id="status-text-input-area">
                    <textarea id="status-text-input" placeholder="Type a status"></textarea>
                    <div id="color-palette"></div>
                </div>
                <button type="submit" class="btn btn-accent" style="width:100%; margin-top:20px;">Post Status</button>
            </form>
        </div>
    </div>
    
    <div id="status-modal-overlay" class="modal-overlay-container">
        <button class="close-modal" style="color:white; text-shadow: 1px 1px 3px black; z-index:4;">×</button>
        <div id="status-nav-prev" class="status-nav"></div>
        <div id="status-nav-next" class="status-nav"></div>
        <div id="status-modal-content">
            <div id="status-progress-bar-container"></div>
            <div id="status-user-info" style="position: absolute; top: 20px; left: 15px; z-index: 2; display: flex; align-items: center; gap: 10px;">
                <img src="" style="width: 40px; height: 40px; border-radius: 50%;">
                <strong style="color: white;"></strong>
            </div>
            <div id="status-header-actions"><a class="action-btn share-status-btn" title="Share Status"><i class="fas fa-share"></i></a></div>
            <div id="status-media-container">
                <div id="status-sound-toggle"><i class="fas fa-volume-mute"></i></div>
            </div>
            <div id="status-text-container"></div>
            <div class="status-caption"></div>
        </div>
    </div>

    <div id="sos-donation-modal" class="modal-overlay-container">
        <div class="modal-card">
            <button class="close-modal" title="Close">×</button>
            <h2 id="donation-modal-title">Help [User]'s Cause</h2>
            <p id="donation-modal-description">Your contribution will make a difference.</p>
            <hr style="border: 1px solid #eee; margin: 20px 0;">
            
            <div class="payment-tabs">
                <div class="payment-tab active" data-target="card-payment-sos"><i class="fas fa-credit-card"></i> Card</div>
                <div class="payment-tab" data-target="crypto-payment-sos"><i class="fab fa-bitcoin"></i> Crypto</div>
                <div class="payment-tab" data-target="bank-payment-sos"><i class="fas fa-university"></i> Bank</div>
            </div>

            <form id="donation-form">
                <div id="card-payment-sos" class="payment-method-content active">
                    <div class="form-group"><label for="donate-amount-card">Amount (NGN)</label><input type="number" id="donate-amount-card" required placeholder="e.g., 5000"></div>
                    <div class="form-group"><label for="donate-card-number">Card Number</label><input type="text" id="donate-card-number" required placeholder="0000 0000 0000 0000"></div>
                    <div class="grid-2">
                        <div class="form-group"><label for="donate-expiry">Expiry</label><input type="text" id="donate-expiry" required placeholder="MM/YY"></div>
                        <div class="form-group"><label for="donate-cvv">CVV</label><input type="text" id="donate-cvv" required placeholder="123"></div>
                    </div>
                </div>
                <div id="crypto-payment-sos" class="payment-method-content">
                    <div class="form-group"><label for="donate-amount-crypto">Amount (USDT)</label><input type="number" id="donate-amount-crypto" placeholder="e.g., 50"></div>
                    <p>Send to the following USDT (TRC-20) address:</p>
                    <p class="crypto-address-box">TKyfvrgGFFd7nKPAyFFn8yA2mB5G7Q1xR9</p>
                </div>
                <div id="bank-payment-sos" class="payment-method-content">
                    <div class="form-group"><label for="donate-amount-bank">Amount (NGN)</label><input type="number" id="donate-amount-bank" placeholder="e.g., 5000"></div>
                     <p>Transfer to the account below:</p>
                     <p><strong>Bank:</strong> Empyrean Trust Bank <br> <strong>Account No:</strong> 0123456789 <br> <strong>Name:</strong> Empyrean SOS Fund</p>
                </div>
                <button type="submit" class="btn btn-success" style="width:100%; margin-top: 20px;"><i class="fas fa-hand-holding-heart"></i> Donate Now</button>
            </form>
        </div>
    </div>
    
    <div id="buy-empy-modal" class="modal-overlay-container">
        <div class="modal-card">
            <button class="close-modal" title="Close">×</button>
            <h2>Buy EMPY Tokens</h2>
            <p>1 EMPY = $0.10. Funds will be added to your wallet balance.</p>
            <hr style="border: 1px solid #eee; margin: 20px 0;">

            <form id="buy-empy-form">
                <div class="form-group">
                    <label for="buy-empy-amount-usd">Amount (USD)</label>
                    <input type="number" id="buy-empy-amount-usd" required placeholder="e.g., 50">
                </div>
                <p id="empy-to-receive-preview" style="text-align:center; font-weight:bold; margin-bottom:15px; color: var(--primary-color)"></p>
                <div class="form-group"><label for="buy-empy-card-number">Card Number</label><input type="text" id="buy-empy-card-number" required placeholder="0000 0000 0000 0000"></div>
                <div class="grid-2">
                    <div class="form-group"><label for="buy-empy-expiry">Expiry</label><input type="text" id="buy-empy-expiry" required placeholder="MM/YY"></div>
                    <div class="form-group"><label for="buy-empy-cvv">CVV</label><input type="text" id="buy-empy-cvv" required placeholder="123"></div>
                </div>
                <button type="submit" class="btn btn-success" style="width:100%; margin-top: 20px;"><i class="fas fa-coins"></i> Complete Purchase</button>
            </form>
        </div>
    </div>

    <div id="reel-viewer-modal-overlay">
        <button class="reel-viewer-close" title="Close">×</button>
        <div class="reel-viewer-container" id="reel-viewer-container">
            <!-- Reel items will be injected here by JS -->
        </div>
    </div>
    
    <div id="marketplace-gallery-modal" class="modal-overlay-container">
        <div class="modal-card gallery-modal-content">
             <button class="close-modal" title="Close" style="color:white; z-index:2;">×</button>
             <div class="gallery-main-image-container">
                <button id="gallery-prev-btn" class="gallery-nav-btn"><i class="fas fa-chevron-left"></i></button>
                <!-- Main image/video appears here -->
                <button id="gallery-next-btn" class="gallery-nav-btn"><i class="fas fa-chevron-right"></i></button>
             </div>
             <div class="gallery-thumbnails" id="gallery-thumbnails-container">
                <!-- Thumbnails appear here -->
             </div>
        </div>
    </div>

    <!-- *** PROMOTION MODAL - MODIFIED FOR PAYMENT FLOW *** -->
    <div id="promotion-modal-overlay" class="modal-overlay-container">
        <div class="modal-card">
            <button class="close-modal" title="Close">×</button>
            <h2 id="promotion-modal-title"><i class="fas fa-rocket"></i> Promote Content</h2>
            <div id="promotion-setup-view">
                <p>Reach a wider, targeted audience by promoting this content.</p>
                <form id="promotion-setup-form" novalidate>
                    <input type="hidden" id="promote-post-id">
                    <div class="form-group">
                        <label for="promo-budget">Budget (₦1,000 - ₦1,000,000)</label>
                        <input type="number" id="promo-budget" placeholder="e.g., 5000" required min="1000" max="1000000">
                    </div>
                     <p id="promo-reach-preview" style="text-align:center; font-weight:bold; margin-bottom:15px; color: var(--primary-color)"></p>
                    <div class="form-group">
                        <label for="promo-duration">Campaign Duration</label>
                        <select id="promo-duration" required>
                            <option value="7">1 day – 7 days</option>
                            <option value="14">1 week – 2 weeks</option>
                            <option value="30">2 weeks – 1 month</option>
                            <option value="60">1 month – 2 months</option>
                            <option value="90">2 months – 3 months</option>
                            <option value="180">3 months – 6 months</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="promo-payment">Payment Method</label>
                        <select id="promo-payment">
                            <option value="wallet">EMPY Token (from Wallet)</option>
                            <option value="card">Debit/Credit Card</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-accent" style="width: 100%;">Proceed to Payment</button>
                </form>
            </div>
            
            <div id="promotion-payment-details">
                <h4 id="payment-details-title" style="margin-bottom: 20px;"></h4>
                <!-- Card Payment Form -->
                <div id="promo-card-payment-view" style="display: none;">
                    <form id="promo-card-form" novalidate>
                        <div class="form-group"><label for="promo-card-number">Card Number</label><input type="text" id="promo-card-number" required placeholder="0000 0000 0000 0000"></div>
                        <div class="grid-2">
                            <div class="form-group"><label for="promo-expiry">Expiry</label><input type="text" id="promo-expiry" required placeholder="MM/YY"></div>
                            <div class="form-group"><label for="promo-cvv">CVV</label><input type="text" id="promo-cvv" required placeholder="123"></div>
                        </div>
                    </form>
                </div>
                <!-- EMPY Wallet Payment Confirmation -->
                <div id="promo-wallet-payment-view" style="display: none;">
                    <p style="text-align: center; margin-bottom: 15px;">You are about to spend:</p>
                    <h3 id="promo-empy-cost" style="text-align: center; margin-bottom: 15px; color: var(--primary-color)"></h3>
                    <p style="text-align: center; font-size: 0.9rem;">This will be deducted from your EMPY wallet balance.</p>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <button type="button" class="btn" id="promo-back-btn" style="background-color: #666;"><i class="fas fa-arrow-left"></i> Back</button>
                    <button type="submit" form="promotion-finalize-form" class="btn btn-success" id="promo-finalize-btn">Confirm Purchase</button>
                </div>
                 <form id="promotion-finalize-form"></form> <!-- Dummy form for submit button -->
            </div>
        </div>
    </div>

    <!-- *** NEW: BUSINESS PAGE CREATION MODAL *** -->
    <div id="create-business-page-modal" class="modal-overlay-container">
        <div class="modal-card">
            <button class="close-modal" title="Close">×</button>
            <h2><i class="fas fa-briefcase"></i> Create a Business Page</h2>
            <form id="create-business-page-form" novalidate>
                <div class="page-image-uploader">
                    <label for="page-cover-photo-input" class="page-cover-photo-preview" id="page-cover-photo-preview"><i class="fas fa-camera"></i>&nbsp; Add Cover Image</label>
                    <input type="file" id="page-cover-photo-input" accept="image/*" style="display:none;">
                    <label for="page-profile-photo-input" class="page-profile-photo-preview" id="page-profile-photo-preview"></label>
                    <input type="file" id="page-profile-photo-input" accept="image/*" style="display:none;">
                </div>
                <div class="form-group"><label for="page-name">Organisation Name</label><input type="text" id="page-name" required></div>
                <div class="form-group"><label for="page-tagline">Tagline</label><input type="text" id="page-tagline" placeholder="e.g., Empowering African Farmers" required></div>
                <div class="form-group"><label for="page-industry">Industry</label>
                    <select id="page-industry" required>
                        <option value="">Select an Industry</option>
                        <option value="agriculture">Agriculture</option>
                        <option value="technology">Technology</option>
                        <option value="education">Education</option>
                        <option value="healthcare">Healthcare</option>
                        <option value="non-profit">Non-Profit</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group"><label for="page-email">Contact Email</label><input type="email" id="page-email" required></div>
                <div class="form-group"><label for="page-phone">Phone Number</label><input type="tel" id="page-phone"></div>
                <div class="form-group"><label for="page-address">Address</label><input type="text" id="page-address"></div>
                <button type="submit" class="btn btn-accent" style="width: 100%;">Create Page</button>
            </form>
        </div>
    </div>


<div id="app-container">
        <div id="content-overlay"></div>
        <button class="mobile-menu-toggle" title="Toggle Menu"><i class="fas fa-bars"></i></button>
        <aside class="sidebar"></aside>
        <main class="main-content">
            <div class="header-search-container">
                <div class="gcse-search"></div>
            </div>

            <label for="main-logo-input" class="main-logo-uploader" title="Click to upload the foundation logo">
                <div class="upload-placeholder"><i class="fas fa-image"></i><span>Click to Upload Foundation Logo</span></div>
                <a href="https://www.empyreanhumanitarianfoundation.com" target="_blank" id="main-logo-link"><img id="main-logo-preview" src="" alt="Foundation Logo"></a>
            </label>
            <input type="file" id="main-logo-input" name="main-logo-input" accept="image/*" style="display: none;">

            <section id="dashboard" class="content-section">
                <div class="header"><h1>Dashboard</h1><div id="main-header-actions" class="header-actions"></div></div>
                <div class="dashboard-grid">

                    <div class="card" id="dashboard-status-container">
                        <div class="horizontal-slider-container">
                            <div class="status-slider-wrapper" id="status-slider">
                                <!-- Status items will be injected here by JS -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="card" id="dashboard-live-container">
                        <h3><span><i class="fas fa-broadcast-tower" style="color: var(--danger-color); margin-right: 8px;"></i> Ongoing Livestreams</span></h3>
                        <div class="horizontal-slider-container">
                            <div class="horizontal-slider-wrapper" id="dashboard-live-slider">
                                <!-- Default Live Stream Card for Clickability -->
                                <div class="live-stream-preview-card join-live-btn" 
                                     data-stream-id="live-123" 
                                     style="background-image: url('https://source.unsplash.com/random/400x600/?charity-event');"
                                     data-host-name="Empyrean Events"
                                     data-stream-title="Community Fundraiser Gala"
                                     data-host-avatar="https://source.unsplash.com/random/150x150/?logo">
                                    <div class="live-preview-header"><span class="live-tag"><i class="fas fa-circle fa-beat" style="font-size: 0.7rem; margin-right: 4px;"></i> LIVE</span></div>
                                    <div class="live-preview-footer"><strong class="host-name">Empyrean Events</strong><p class="stream-title">Community Fundraiser Gala</p></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card" id="dashboard-reels-container" style="display:none;">
                        <h3><span><i class="fas fa-film" style="color: var(--danger-color); margin-right: 8px;"></i> New Reels</span></h3>
                        <div class="horizontal-slider-container">
                            <div class="horizontal-slider-wrapper" id="dashboard-reels-slider"></div>
                        </div>
                    </div>

                    <div class="card" id="dashboard-news-container" style="display:block;">
                        <h3><span><i class="fas fa-newspaper" style="margin-right: 8px;"></i> Latest News</span></h3>
                        <div class="horizontal-slider-container">
                            <div class="horizontal-slider-wrapper" id="dashboard-news-slider"></div>
                        </div>
                    </div>

                    <div class="card" id="dashboard-market-container" style="display:none;">
                        <h3><span><i class="fas fa-store" style="margin-right: 8px;"></i> New in Marketplace</span></h3>
                        <div class="horizontal-slider-wrapper" id="dashboard-market-slider"></div>
                    </div>

                    <div class="card">
                        <div class="card-content">
                             <form id="create-post-form">
                                <div id="post-format-toolbar">
                                    <button type="button" data-format="bold"><b>B</b></button>
                                    <button type="button" data-format="italic"><i>I</i></button>
                                    <button type="button" data-format="strike"><s>S</s></button>
                                </div>
                                <div class="form-group">
                                    <textarea id="post-text" name="post-text" placeholder="What's on your mind? You can use *bold*, _italic_, and ~strikethrough~. Paste a YouTube link to embed it!"></textarea>
                                </div>
                                <div id="post-media-preview"></div>
                                <div class="post-actions-container">
                                    <div>
                                        <input type="file" id="post-media-input" name="post-media-input" accept="image/*,video/*" multiple style="display: none;">
                                        <label for="post-media-input" class="btn btn-media-upload" title="Add Photos or Videos"><i class="fas fa-photo-video"></i> Add Media</label>
                                    </div>
                                    <button type="submit" class="btn btn-accent"><i class="fas fa-paper-plane"></i> Post</button>
                                </div>
                            </form>
                        </div>

                        <h3><span><i class="fas fa-stream" style="margin-right: 8px;"></i> Main Feed</span></h3>
                        <div id="feed-container">
                            <div class="impact-story success-story" data-post-id="post-1" data-user-id="user-1"><div class="story-header"><div class="avatar-placeholder square"><img src="https://source.unsplash.com/random/45x45/?water-well" alt="Water well project success"></div><div class="story-user-info"><strong>Success Story: Clean Water!</strong><span>Kano, Nigeria</span></div><div class="post-options"><button class="options-btn"><i class="fas fa-ellipsis-h"></i></button><div class="options-menu"><a href="#" class="edit-post-btn"><i class="fas fa-edit"></i> Edit</a><a href="#" class="delete-post-btn"><i class="fas fa-trash"></i> Delete</a><a href="#" class="promote-post-btn"><i class="fas fa-rocket"></i> Promote</a></div></div></div><div class="story-content"><p>Thank you Empyrean community! With your *generous donations*, we have successfully built a new borehole providing clean drinking water to over _500 people_ in our village. ~Poverty~ is being defeated. God bless you all!</p></div><div class="story-media-container"><img src="https://source.unsplash.com/random/800x400/?happy-children-water" class="story-main-image" alt="Happy children drinking clean water"></div><div class="story-actions"><a class="action-btn like-btn"><i class="far fa-heart"></i><span class="like-count">8,930</span></a><a class="action-btn comment-btn"><i class="far fa-comment"></i><span class="comment-count">1,102</span></a><a class="action-btn share-btn"><i class="fas fa-share"></i><span>Share</span></a><a class="action-btn retweet-btn"><i class="fas fa-retweet"></i><span class="retweet-count">56</span></a><span class="sponsored-badge" style="display: none; margin-left: auto;">Sponsored</span></div><div class="comment-section"><div class="comment-list"><p style="text-align: center; color: #888;">View comments...</p></div><form class="comment-form" novalidate><input type="text" name="comment-text" placeholder="Add a comment..." required><button type="submit"><i class="fas fa-paper-plane"></i></button></form></div></div>
                            <div class="impact-story" data-post-id="post-3" data-user-id="user-3"><div class="story-header"><div class="avatar-placeholder square"><img src="https://source.unsplash.com/random/45x45/?kenya" alt="Woman from Kenya"></div><div class="story-user-info"><strong>Kibera Slum Outreach</strong><span>Nairobi, Kenya</span></div><button class="follow-btn" data-user-id="user-3">Follow</button><div class="post-options"><button class="options-btn"><i class="fas fa-ellipsis-h"></i></button><div class="options-menu"><a href="#" class="edit-post-btn"><i class="fas fa-edit"></i> Edit</a><a href="#" class="delete-post-btn"><i class="fas fa-trash"></i> Delete</a><a href="#" class="promote-post-btn"><i class="fas fa-rocket"></i> Promote</a></div></div></div><div class="story-content"><p>Distributing _essential_ food items and supplies to families in one of Africa's *largest urban slums*. Your support is vital.</p></div><div class="story-media-container"><video src="https://www.w3schools.com/html/mov_bbb.mp4" class="story-video" controls alt="Food drive outreach video"></video></div><div class="story-actions"><a class="action-btn like-btn"><i class="far fa-heart"></i><span class="like-count">1,205</span></a><a class="action-btn comment-btn"><i class="far fa-comment"></i><span class="comment-count">158</span></a><a class="action-btn share-btn"><i class="fas fa-share"></i><span>Share</span></a><a class="action-btn retweet-btn"><i class="fas fa-retweet"></i><span class="retweet-count">210</span></a><button class="gift-button"><i class="fas fa-gift"></i> Gift EMPY</button><span class="sponsored-badge" style="display: none; margin-left: auto;">Sponsored</span></div><div class="comment-section"><div class="comment-list"><p style="text-align: center; color: #888;">View comments...</p></div><form class="comment-form" novalidate><input type="text" name="comment-text" placeholder="Add a comment..." required><button type="submit"><i class="fas fa-paper-plane"></i></button></form></div></div>
                        </div>
                        
                        <div class="card" id="suggested-users-container" style="display:none;">
                            <h3><span><i class="fas fa-user-plus" style="margin-right: 8px;"></i> Suggested For You</span></h3>
                            <div class="horizontal-slider-container">
                                <div class="horizontal-slider-wrapper" id="suggested-users-slider"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>
                            <span><i class="fas fa-video" style="margin-right: 8px; color: var(--secondary-color);"></i> Recorded Livestreams</span>
                        </h3>
                        <div class="horizontal-slider-container">
                            <div class="horizontal-slider-wrapper" id="livestream-wrapper">
                                <!-- Recorded streams will be prepended here -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="my-wallet" class="content-section">
                <div class="header"><h1>My Wallet</h1></div>
                <div class="card"><div class="card-content"><h3>Wallet Overview</h3><div class="grid-1"><div class="wallet-card"><p>EMPY Token Balance</p><h3 class="empy-balance" id="wallet-empy-balance"><i class="fa-solid fa-coins"></i> 85,550.75</h3><p id="wallet-usd-equivalent" style="color: #666; font-size: 1rem; margin-top: 5px;">~ $8,555.07</p><button class="btn btn-accent" id="buy-empy-wallet-btn" style="margin-top: 15px;"><i class="fas fa-coins"></i> Buy EMPY Tokens</button></div></div></div></div>

                <!-- STAKING SECTION -->
                <div class="card">
                    <div class="card-content">
                        <h3><i class="fas fa-layer-group"></i> Stake Your EMPY Tokens</h3>
                        <p style="font-size: 0.9rem; margin-bottom: 15px;">Lock your EMPY tokens to earn rewards and support the ecosystem. You can unstake at any time.</p>
                        
                        <div class="analytics-grid" style="margin-bottom: 25px;">
                            <div class="stat-card">
                                <h4>Staking APY</h4>
                                <div class="stat-value" id="staking-apy">~15.7%</div>
                                <p>Annual Percentage Yield (est.)</p>
                            </div>
                            <div class="stat-card">
                                <h4>My Staked Balance</h4>
                                <div class="stat-value" id="user-staked-balance">0.00</div>
                                <p>EMPY</p>
                            </div>
                            <div class="stat-card">
                                <h4>My Earned Rewards</h4>
                                <div class="stat-value" id="user-earned-rewards">0.00</div>
                                <p>EMPY</p>
                            </div>
                        </div>

                        <!-- Staking Form -->
                        <form id="stake-form" class="wallet-form">
                            <div class="form-group">
                                <label for="stake-amount">Amount to Stake</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="stake-amount" placeholder="e.g., 1000" required>
                                    <button type="submit" class="btn btn-accent">Stake</button>
                                </div>
                                <p style="font-size: 0.8rem; margin-top: 5px;">You have <span id="stake-available-balance">0.00</span> EMPY available to stake.</p>
                            </div>
                        </form>

                        <hr style="border: 1px solid #eee; margin: 20px 0;">
                        
                        <!-- Unstaking & Claiming Form -->
                        <div class="grid-2">
                            <form id="unstake-form" class="wallet-form">
                                 <div class="form-group">
                                    <label for="unstake-amount">Amount to Unstake</label>
                                    <div style="display: flex; gap: 10px;">
                                        <input type="number" id="unstake-amount" placeholder="e.g., 500" required>
                                        <button type="submit" class="btn">Unstake</button>
                                    </div>
                                </div>
                            </form>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--primary-color);">Claim Your Rewards</label>
                                <button id="claim-reward-btn" class="btn btn-success" style="width:100%;"><i class="fas fa-gift"></i> Claim Now</button>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Wallet to Wallet Transfer -->
                <div class="card">
                    <div class="card-content">
                        <h3><i class="fas fa-exchange-alt"></i> Internal Transfer (Wallet to Wallet)</h3>
                        <p style="font-size: 0.9rem; margin-bottom: 15px;">Send EMPY tokens to another user on the Empyrean platform. This is a low-fee transaction on the Polygon network.</p>
                        <form id="p2p-transfer-form" novalidate>
                            <div class="form-group">
                                <label for="transfer-address">Recipient's Polygon Wallet Address</label>
                                <input type="text" id="transfer-address" name="transfer-address" placeholder="0x..." required>
                            </div>
                            <div class="form-group">
                                <label for="transfer-amount">Amount to Send (EMPY)</label>
                                <input type="number" id="transfer-amount" name="transfer-amount" placeholder="e.g., 100" min="1" required>
                            </div>
                            <div id="transfer-preview">
                                <p>Enter an amount to see transaction details.</p>
                            </div>
                            <button type="submit" class="btn btn-accent" style="margin-top: 20px;"><i class="fas fa-paper-plane"></i> Send EMPY</button>
                        </form>
                    </div>
                </div>

                <!-- Cross-chain Transfer -->
                <div class="card">
                    <div class="card-content">
                         <h3><i class="fas fa-random"></i> Transfer to Other Blockchains (Bridge)</h3>
                         <p style="font-size: 0.9rem; margin-bottom: 15px; background: #fff8e1; padding: 10px; border-radius: 5px; border-left: 4px solid #f57c00;"><strong>Warning:</strong> Cross-chain transfers are complex and involve higher fees. Ensure the recipient address is correct for the selected network.</p>
                         <form id="cross-chain-transfer-form" novalidate>
                            <div class="form-group">
                                <label for="cross-chain-network">1. Select Destination Network</label>
                                <select id="cross-chain-network" name="cross-chain-network" required>
                                    <option value="eth" data-fee="25" data-placeholder="0x...">Ethereum (ERC-20) (Fee: 25 EMPY)</option>
                                    <option value="bnb" data-fee="8" data-placeholder="0x...">BNB Chain (BEP-20) (Fee: 8 EMPY)</option>
                                    <option value="tron" data-fee="5" data-placeholder="T...">TRON (TRC-20) (Fee: 5 EMPY)</option>
                                    <option value="ton" data-fee="10" data-placeholder="EQ...">Telegram Open Network (TON) (Fee: 10 EMPY)</option>
                                    <option value="solana" data-fee="7" data-placeholder="SoL...">Solana (Fee: 7 EMPY)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="cross-chain-address">2. Recipient's Wallet Address</label>
                                <input type="text" id="cross-chain-address" name="cross-chain-address" placeholder="0x..." required>
                            </div>
                            <div class="form-group">
                                <label for="cross-chain-amount">3. Amount to Send (EMPY)</label>
                                <input type="number" id="cross-chain-amount" name="cross-chain-amount" placeholder="e.g., 500" min="1" required>
                            </div>
                             <div id="cross-chain-transfer-preview">
                                <p>Enter an amount to see transaction details.</p>
                            </div>
                            <button type="submit" class="btn btn-accent" style="margin-top: 20px;"><i class="fas fa-paper-plane"></i> Bridge Tokens</button>
                        </form>
                    </div>
                </div>


                <div class="card"><div class="card-content"><h3><i class="fas fa-university"></i> Withdraw to Fiat</h3><form id="withdrawal-form" novalidate><div class="form-group"><label for="withdrawal-amount" id="withdrawal-amount-label">1. Amount to Withdraw (EMPY)</label><input type="number" id="withdrawal-amount" name="withdrawal-amount" placeholder="Minimum 5 EMPY" min="5" required></div><div class="form-group"><label for="withdrawal-method">2. Withdrawal Method</label><select id="withdrawal-method" name="withdrawal-method" required><option value="" disabled selected>-- Select Method --</option><option value="empyrean-card">Empyrean Crypto Debit Card</option><option value="bank">Bank Transfer (Naira)</option><option value="usdt">USDT Transfer</option></select></div><div id="withdrawal-method-fields"><div id="empyrean-card-fields" class="form-group"><label for="empyrean-card-number">16-Digit Empyrean Card Number</label><input type="text" id="empyrean-card-number" name="empyrean-card-number" placeholder="XXXX XXXX XXXX XXXX"><p class="security-note" style="text-align: left; margin-top: 10px;"><i class="fas fa-check-circle"></i> Funds will be available instantly on your card balance.</p></div><div id="usdt-fields" class="form-group"><label for="usdt-address">USDT Wallet Address (TRC-20)</label><input type="text" id="usdt-address" name="usdt-address" placeholder="T..."></div><div id="bank-fields"><div class="form-group"><label for="bank-name">Bank Name</label><input type="text" id="bank-name" name="bank-name" placeholder="e.g., Guaranty Trust Bank"></div><div class="form-group"><label for="account-number">Account Number</label><input type="text" id="account-number" name="account-number" placeholder="e.g., 0123456789"></div></div></div><div id="withdrawal-preview"><p>Enter an amount and select a method to see preview.</p></div><button type="submit" class="btn btn-accent" style="margin-top: 20px;"><i class="fas fa-hand-holding-usd"></i> Submit Withdrawal</button></form></div></div>
            </section>
            
            <section id="messages" class="content-section">
                <div class="header"><h1><i class="fas fa-envelope"></i> Direct Messages</h1></div>
                <div id="messages-view">
                    <div class="contact-list" id="contact-list-container"></div>
                    <div class="chat-view" id="chat-view-container" style="display:none;">
                        <div class="chat-header" id="chat-header-info"></div>
                        <div class="chat-messages" id="chat-messages-container"></div>
                        <form id="message-form" class="message-input-area">
                            <input type="file" id="message-file-input" style="display:none;" accept="image/*,video/*,application/pdf,.doc,.docx,.xls,.xlsx">
                            <button type="button" class="btn btn-media-upload" id="message-attach-btn"><i class="fas fa-paperclip"></i></button>
                            <input type="text" id="message-text-input" placeholder="Type a message..." required>
                            <button type="submit" class="btn btn-accent"><i class="fas fa-paper-plane"></i></button>
                        </form>
                    </div>
                    <div id="chat-placeholder" style="display:flex; flex-direction:column; align-items:center; justify-content:center; flex-grow:1; text-align:center; color:#888;">
                        <i class="fas fa-comments fa-4x"></i>
                        <h3 style="margin-top:20px;">Select a conversation</h3>
                        <p>Start messaging your followed contacts.</p>
                    </div>
                </div>
            </section>
            
            <section id="go-live" class="content-section">
                <div class="header"><h1>Go Live: Share Your Impact</h1></div>
                <div class="card">
                    <div class="card-content">
                        <h3>Start a Live Stream</h3>
                        <p>Showcase your talent, host a workshop, or raise awareness. All impactful content is welcome!</p>
                        <form id="go-live-form" novalidate>
                            <div class="form-group"><label for="live-title">Stream Title</label><input type="text" id="live-title" name="live-title" placeholder="e.g., Live Art for Charity" required></div>
                            <div class="form-group"><label for="live-description">What's your stream about?</label><textarea id="live-description" name="live-description" placeholder="Briefly describe what you will be discussing..." required></textarea></div>
                            <div class="form-group">
                                <label>Choose a Background</label>
                                <div id="live-bg-selector"></div>
                            </div>
                            <button type="submit" class="btn btn-accent"><i class="fas fa-broadcast-tower"></i> Start Streaming</button>
                        </form>
                    </div>
                </div>
            </section>

			<section id="request-help" class="content-section">
                <div class="header"><h1>Request Help (SOS)</h1></div>
                <div class="card">
                    <div class="card-content">
                        <h3>Personal Help Request</h3>
                        <p>All requests are verified by the community and our team to ensure donor trust.</p>
                        <form id="help-form" novalidate>
                            <div class="form-group"><label for="request-category">Category of Need</label><select id="request-category" name="request-category" required><option value="" disabled selected>-- Select Category --</option><option value="medical">Medical Bills</option><option value="tuition">Tuition / School Fees</option><option value="business_support">Small Business Support</option><option value="disaster_relief">Disaster Relief</option><option value="other">Other</option></select></div>
                            <div class="form-group"><label for="request-story">Your Story</label><textarea id="request-story" name="request-story" rows="4" placeholder="e.g., I need help with my final year tuition..." required></textarea></div>
                            <div class="grid-2">
                                <div class="form-group"><label for="request-amount">Amount Requested</label><input type="number" id="request-amount" name="request-amount" placeholder="e.g., 50000" min="1" required></div>
                                <div class="form-group"><label for="request-currency">Currency</label><select id="request-currency" name="request-currency" required><option value="NGN">Nigerian Naira (₦)</option><option value="USD">US Dollar ($)</option><option value="GHS">Ghanaian Cedi (₵)</option><option value="USDT">USDT (Crypto)</option><option value="EMPY">EMPY Token</option></select></div>
                            </div>
                            <div class="form-group">
                                <label for="sos-media-input">Add Evidence (Images/Videos)</label>
                                <input type="file" id="sos-media-input" name="sos-media-input" accept="image/*,video/*" multiple style="display:none;">
                                <label for="sos-media-input" class="btn btn-media-upload" title="Add evidence files"><i class="fas fa-paperclip"></i> Select Files</label>
                                <div id="sos-media-preview"></div>
                            </div>
                            <button type="submit" class="btn btn-accent"><i class="fas fa-hand-holding-heart"></i> Submit Request</button>
                        </form>
                    </div>
                </div>
            </section>
            <section id="report-crisis" class="content-section">
                <div class="header"><h1>Report Crisis</h1></div>
                <div class="card">
                    <div class="card-content">
                        <h3>Community Crisis Report</h3>
                        <p>Verified reports are rewarded with EMPY tokens. Help us identify needs on the ground.</p>
                        <form id="crisis-form" novalidate>
                            <div class="form-group"><label for="crisis-type">Type of Crisis</label><select id="crisis-type" name="crisis-type" required><option value="" disabled selected>-- Select Type --</option><optgroup label="Natural Disasters"><option value="flood">Flood</option><option value="fire">Wildfire</option><option value="drought">Drought</option></optgroup><optgroup label="Community Health"><option value="health_emergency">Health Emergency / Outbreak</option><option value="food_shortage">Food Shortage</option><option value="water_crisis">Water Contamination/Shortage</option></optgroup><optgroup label="Infrastructure"><option value="building_collapse">Building Collapse</option><option value="power_outage">Prolonged Power Outage</option></optgroup><option value="other">Other (Please specify below)</option></select></div>
                            <div class="form-group"><label for="crisis-description">Brief Description</label><textarea id="crisis-description" name="crisis-description" rows="3" placeholder="Describe the situation, who is affected, and what is urgently needed..." required></textarea></div>
                            <div class="form-group"><label for="crisis-location">Location (Town, State)</label><input type="text" id="crisis-location" name="crisis-location" placeholder="e.g., Makoko Community, Lagos, Nigeria" required></div>
                            <div class="form-group"><label>Geological Map</label><div class="map-placeholder"><i class="fas fa-map-marked-alt fa-2x"></i></div><button type="button" class="btn btn-small" id="pin-location-btn" style="width:100%"><i class="fas fa-thumbtack"></i> Pin Location on Map (Simulation)</button><p id="crisis-location-coords"></p></div>
                            <div class="form-group">
                                <label for="crisis-media-input">Add Media (Images/Videos)</label>
                                <input type="file" id="crisis-media-input" name="crisis-media-input" accept="image/*,video/*" multiple style="display:none;">
                                <label for="crisis-media-input" class="btn btn-media-upload" title="Add media files"><i class="fas fa-paperclip"></i> Select Files</label>
                                <div id="crisis-media-preview"></div>
                            </div>
                            <button type="submit" class="btn btn-accent"><i class="fas fa-paper-plane"></i> Submit Report</button>
                        </form>
                    </div>
                </div>
            </section>
            
            <section id="reels" class="content-section">
                <div class="header"><h1><i class="fas fa-film" style="color: var(--danger-color)"></i> Reels (Shorts)</h1></div>
                <div class="card">
                    <div class="card-content">
                        <h3>Upload a New Reel</h3>
                        <form id="reel-upload-form">
                            <div class="form-group"><label for="reel-video-file">Video File (Max 1:30)</label><input type="file" id="reel-video-file" name="reel-video-file" accept="video/*" required></div>
                            <div class="form-group"><label for="reel-caption">Caption</label><input type="text" id="reel-caption" name="reel-caption" placeholder="Describe your reel... You can use *bold* and _italic_."></div>
                            <button type="submit" class="btn btn-accent">Upload Reel</button>
                        </form>
                    </div>
                </div>
                <div class="reels-grid" id="reels-grid-container">
                    <div class="reel-card" data-post-id="reel-1" data-video-url="https://www.w3schools.com/html/mov_bbb.mp4"><video src="https://www.w3schools.com/html/mov_bbb.mp4" poster="https://source.unsplash.com/random/400x600/?farmer-africa" alt="Reel of farmer in Africa" loop muted playsinline></video><div class="reel-content"><div class="reel-user-info"><div class="avatar-placeholder"><img src="https://source.unsplash.com/random/35x35/?man-portrait" alt="User avatar"></div><span>@AgriConnect</span></div><p>New irrigation helping farmers in _rural Ghana_.</p></div><span class="sponsored-badge" style="display: none; position: absolute; top: 15px; left: 15px; z-index: 4;">Sponsored</span><div class="post-options" style="position: absolute; top: 15px; right: 15px;"><button class="options-btn" style="color:white; text-shadow: 1px 1px 2px black;"><i class="fas fa-ellipsis-v"></i></button><div class="options-menu"><a href="#" class="promote-post-btn"><i class="fas fa-rocket"></i> Promote</a></div></div></div>
                    <div class="reel-card" data-post-id="reel-2" data-video-url="https://www.w3schools.com/html/mov_bbb.mp4"><video src="https://www.w3schools.com/html/mov_bbb.mp4" poster="https://source.unsplash.com/random/400x600/?artist-kenya" alt="Reel of an artist in Kenya" loop muted playsinline></video><div class="reel-content"><div class="reel-user-info"><div class="avatar-placeholder"><img src="https://source.unsplash.com/random/35x35/?woman-portrait" alt="User avatar"></div><span>@NairobiVibes</span></div><p>Meet the *incredible* street artists of Nairobi.</p></div><span class="sponsored-badge" style="display: none; position: absolute; top: 15px; left: 15px; z-index: 4;">Sponsored</span><div class="post-options" style="position: absolute; top: 15px; right: 15px;"><button class="options-btn" style="color:white; text-shadow: 1px 1px 2px black;"><i class="fas fa-ellipsis-v"></i></button><div class="options-menu"><a href="#" class="promote-post-btn"><i class="fas fa-rocket"></i> Promote</a></div></div></div>
                </div>
            </section>

			<section id="marketplace" class="content-section">
                <div class="header"><h1>Marketplace</h1></div>
                <div class="card">
                    <div class="card-content">
                        <h3>List a New Item for Sale</h3>
                        <form id="marketplace-form">
                            <div class="form-group">
                                <label for="item-media">Images & Videos (Up to 10 images, 5 videos)</label>
                                <input type="file" id="item-media" name="item-media" accept="image/*,video/*" multiple style="display: none;">
                                <label for="item-media" class="btn btn-media-upload"><i class="fas fa-upload"></i> Upload Media First</label>
                                <div id="marketplace-media-preview"></div>
                            </div>
                            
                            <div id="marketplace-text-fields">
                                <div class="form-group"><label for="item-name">Item Name</label><input type="text" id="item-name" name="item-name" required placeholder="e.g., 4-Bedroom Duplex"></div>
                                
                                <div class="form-group">
                                    <label for="sales-type">Sales Type</label>
                                    <select id="sales-type" name="sales-type" required>
                                        <option value="escrow" selected>Escrow Service (Supervised)</option>
                                        <option value="direct">Direct Sales (Unsupervised)</option>
                                    </select>
                                    <p style="font-size:0.8rem; color:#666; margin-top:5px;">Escrow is recommended for safety. Direct sales are for local, in-person trades.</p>
                                </div>
                                <div id="direct-sales-fields" style="display: none; border-left: 3px solid var(--accent-color); padding-left: 15px; margin-bottom: 20px;">
                                    <h4 style="margin-bottom: 15px; color: var(--primary-color);">Contact Info for Direct Sale (Optional)</h4>
                                    <div class="form-group">
                                        <label for="item-seller-name">Your Full Name (for buyers)</label>
                                        <input type="text" id="item-seller-name" name="item-seller-name" placeholder="e.g., John Doe">
                                    </div>
                                    <div class="form-group">
                                        <label for="item-seller-phone">Your Phone Number (for buyers)</label>
                                        <input type="tel" id="item-seller-phone" name="item-seller-phone" placeholder="e.g., +2348012345678">
                                    </div>
                                    <div class="form-group">
                                        <label for="item-seller-email">Your Contact Email (for buyers)</label>
                                        <input type="email" id="item-seller-email" name="item-seller-email" placeholder="e.g., contact@email.com">
                                    </div>
                                    <div class="form-group">
                                        <label for="item-seller-address">Your Address / Pickup Location</label>
                                        <input type="text" id="item-seller-address" name="item-seller-address" placeholder="e.g., 123 Allen Avenue, Ikeja, Lagos">
                                    </div>
                                </div>
                                <div class="grid-2">
                                    <div class="form-group"><label for="item-price">Price</label><input type="number" id="item-price" name="item-price" required placeholder="e.g., 250000"></div>
                                    <div class="form-group">
                                        <label for="item-currency">Currency</label>
                                        <select id="item-currency" name="item-currency">
                                            <option value="NGN">NGN</option>
                                            <option value="USD" selected>USD</option>
                                            <option value="EUR">EUR</option>
                                            <option value="GBP">GBP</option>
                                            <option value="EMPY">EMPY</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group"><label for="item-location">Location</label><input type="text" id="item-location" name="item-location" required placeholder="e.g., Lekki, Lagos"></div>
                                <div class="form-group inspection-report">
                                    <label for="inspection-report-files">Upload Inspection Report (Optional)</label>
                                    <input type="file" id="inspection-report-files" name="inspection-report-files" accept=".pdf,image/*" multiple style="display:none;">
                                    <label for="inspection-report-files" class="btn btn-media-upload"><i class="fas fa-file-alt"></i> Select Report Files</label>
                                </div>
                                <button type="submit" class="btn btn-accent">Add to Marketplace</button>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="property-grid" id="property-grid-container">
                    <div class="property-card" data-id="prop-3" data-sales-type="escrow" data-name="3 Bedroom Flat, Lekki" data-price="250000" data-location="Lekki Phase 1, Lagos" data-media='["https://source.unsplash.com/random/800x600/?apartment-lagos", "https://source.unsplash.com/random/800x600/?living-room-modern", "https://source.unsplash.com/random/800x600/?kitchen-modern"]' data-description="A *beautifully finished* 3-bedroom flat in the heart of Lekki. Comes fully furnished. _Perfect for a family_. ~Price is non-negotiable~.">
                        <img src="https://source.unsplash.com/random/800x600/?apartment-lagos" alt="Lagos Apartment">
                        <div class="property-info"><h4>3 Bedroom Flat for Sale</h4><p><i class="fas fa-map-marker-alt"></i> Lekki Phase 1, Lagos</p><div>$250,000</div></div>
                        <div class="property-seller-info"><span>by @ade_adebayo <i class="fas fa-check-circle verified-badge-small" title="Escrow Protected"></i></span><span class="star-rating">4.8 <i class="fas fa-star"></i></span></div>
                        <div class="property-actions"><span class="sponsored-badge" style="display: none; position: absolute; top: 10px; left: 10px;">Sponsored</span><button class="btn btn-accent add-to-cart-btn"><i class="fas fa-cart-plus"></i> Add to Cart (Escrow)</button><button class="btn promote-item-btn promote-post-btn"><i class="fas fa-rocket"></i> Promote</button></div>
                    </div>
                    <div class="property-card" data-id="prop-4" data-sales-type="direct" data-name="Toyota Camry 2018" data-price="18000" data-location="Ikeja, Lagos" data-media='["https://source.unsplash.com/random/800x600/?car-sedan", "https://www.w3schools.com/html/mov_bbb.mp4"]' data-contact-name="Mr. Ciroma" data-contact-phone="+2348098765432" data-contact-email="ciroma.cars@email.com" data-contact-address="123 Allen Avenue, Ikeja, Lagos" data-description="*Direct sales only!* A very clean, foreign-used 2018 Toyota Camry. _First body_, no issues.">
                        <img src="https://source.unsplash.com/random/800x600/?car-sedan" alt="Toyota Camry">
                        <div class="property-info"><h4>Toyota Camry 2018</h4><p><i class="fas fa-map-marker-alt"></i> Ikeja, Lagos</p><div>$18,000</div></div>
                        <div class="property-seller-info"><span>by @CiromaCars <i class="fas fa-exclamation-circle unverified-badge-small" title="Direct Sales – No Escrow"></i></span><span class="star-rating">New <i class="fas fa-star"></i></span></div>
                        <div class="direct-trade-warning"><p><strong><i class="fas fa-exclamation-triangle"></i> Direct Sales (Unsupervised):</strong> This is a direct sale. Please conduct due diligence before making payment. The platform is not responsible for disputes in direct sales.</p></div>
                        <div class="direct-contact-info"></div>
                        <div class="property-actions"><span class="sponsored-badge" style="display: none; position: absolute; top: 10px; left: 10px;">Sponsored</span><button class="btn btn-danger contact-seller-btn"><i class="fas fa-phone"></i> Contact Seller Directly</button><button class="btn promote-item-btn promote-post-btn"><i class="fas fa-rocket"></i> Promote</button></div>
                    </div>
                </div>
            </section>
            
            <section id="profile" class="content-section">
                <!-- Profile content is now dynamically rendered by renderUserProfile() -->
            </section>
            
            <section id="news" class="content-section">
                <div class="header"><h1>News & Updates</h1></div>
                <div class="card">
                    <div class="card-content">
                        <h3>Publish a News Article</h3>
                        <form id="create-news-post-form" novalidate>
                            <div class="form-group"><label for="news-title">Title</label><input type="text" id="news-title" name="news-title" placeholder="Enter article title" required></div>
                            <div class="form-group"><label for="news-content">Content</label><textarea id="news-content" name="news-content" rows="5" placeholder="Write your news article here..." required></textarea></div>
                            <div class="form-group">
                                <label for="news-media-file">Add Image or Video</label>
                                <input type="file" id="news-media-file" name="news-media-file" accept="image/*,video/*" style="display:none;">
                                <label for="news-media-file" class="btn btn-media-upload"><i class="fas fa-upload"></i> Select Media</label>
                                <div id="news-media-preview"></div>
                            </div>
                            <button type="submit" class="btn btn-accent">Publish News</button>
                        </form>
                    </div>
                </div>
                <div class="card">
                    <div class="news-list" id="news-list-container">
                        <div class="news-list-item" data-post-id="news-1">
                            <div class="news-item-image"><img src="https://images.unsplash.com/photo-1639755491196-8576d05979a0?q=80&w=400" alt="Blockchain and globe graphic"></div>
                            <div class="news-item-content-wrapper">
                                <div class="news-item-content"><h4>Empyrean Partners with EFCC to Launch Blockchain-Based Grant Tracking</h4><span class="news-meta"><i class="fas fa-calendar-alt"></i> August 05, 2025</span><p>To combat corruption and ensure aid reaches its intended recipients, Empyrean is pioneering a new transparent system in collaboration with Nigeria's anti-graft agency. This move promises to revolutionize grant distribution...</p></div>
                                <div class="story-actions" style="margin-top: 15px;"><a class="action-btn like-btn"><i class="far fa-heart"></i><span class="like-count">128</span></a><a class="action-btn comment-btn"><i class="far fa-comment"></i><span class="comment-count">12</span></a><a class="action-btn share-btn"><i class="fas fa-share"></i><span>Share</span></a><a class="action-btn retweet-btn"><i class="fas fa-retweet"></i><span class="retweet-count">15</span></a></div>
                                <div class="comment-section"><div class="comment-list"></div><form class="comment-form" novalidate><input type="text" name="comment-text" placeholder="Add a comment..." required><button type="submit"><i class="fas fa-paper-plane"></i></button></form></div>
                            </div>
                        </div>
                        <div class="news-list-item" data-post-id="news-2">
                            <div class="news-item-image"><img src="https://source.unsplash.com/random/400x400/?agriculture-tech-africa" alt="Agri-tech in Africa"></div>
                            <div class="news-item-content-wrapper">
                                <div class="news-item-content"><h4>Agri-Tech Initiative Lifts 1,000 Farmers Out of Poverty in Kaduna</h4><span class="news-meta"><i class="fas fa-calendar-alt"></i> August 02, 2025</span><p>A new initiative funded through the Empyrean platform has provided over 1,000 smallholder farmers in Kaduna with advanced tools and training, boosting crop yields by an average of 60%.</p></div>
                                <div class="story-actions" style="margin-top: 15px;"><a class="action-btn like-btn"><i class="far fa-heart"></i><span class="like-count">450</span></a><a class="action-btn comment-btn"><i class="far fa-comment"></i><span class="comment-count">35</span></a><a class="action-btn share-btn"><i class="fas fa-share"></i><span>Share</span></a><a class="action-btn retweet-btn"><i class="fas fa-retweet"></i><span class="retweet-count">42</span></a></div>
                                <div class="comment-section"><div class="comment-list"></div><form class="comment-form" novalidate><input type="text" name="comment-text" placeholder="Add a comment..." required><button type="submit"><i class="fas fa-paper-plane"></i></button></form></div>
                            </div>
                        </div>
                        <div class="news-list-item" data-post-id="news-3">
                            <div class="news-item-image"><video style="width:100%; height:100%; object-fit:cover;" controls loop poster="https://source.unsplash.com/random/400x400/?community-meeting-ghana"><source src="https://www.w3schools.com/html/mov_bbb.mp4" type="video/mp4">Your browser does not support the video tag.</video></div>
                            <div class="news-item-content-wrapper">
                                <div class="news-item-content"><h4>Live Town Hall: Discussing Community Impact and Future Projects</h4><span class="news-meta"><i class="fas fa-calendar-alt"></i> July 28, 2025</span><p>Join us for a recap of our recent live town hall where we discussed the incredible impact of community-funded projects and outlined our roadmap for the next quarter. Watch the full recording now.</p></div>
                                <div class="story-actions" style="margin-top: 15px;"><a class="action-btn like-btn"><i class="far fa-heart"></i><span class="like-count">88</span></a><a class="action-btn comment-btn"><i class="far fa-comment"></i><span class="comment-count">9</span></a><a class="action-btn share-btn"><i class="fas fa-share"></i><span>Share</span></a><a class="action-btn retweet-btn"><i class="fas fa-retweet"></i><span class="retweet-count">5</span></a></div>
                                <div class="comment-section"><div class="comment-list"></div><form class="comment-form" novalidate><input type="text" name="comment-text" placeholder="Add a comment..." required><button type="submit"><i class="fas fa-paper-plane"></i></button></form></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="settings" class="content-section">
                <div class="header"><h1>Settings</h1></div>
                <div class="card">
                    <div class="settings-tabs">
                        <div class="settings-tab active" data-target="settings-profile"><i class="fas fa-user-edit"></i> Profile</div>
                        <div class="settings-tab" data-target="settings-security"><i class="fas fa-shield-alt"></i> Security</div>
                        <div class="settings-tab" data-target="settings-privacy"><i class="fas fa-user-secret"></i> Privacy Policy</div>
                        <div class="settings-tab" data-target="settings-terms"><i class="fas fa-file-contract"></i> Terms</div>
                        <div class="settings-tab" data-target="settings-ecommerce"><i class="fas fa-gavel"></i> E-Commerce Policy</div>
                    </div>
                    <div class="card-content">
                        <div id="settings-profile" class="settings-content active">
                            <h3>Edit Your Information</h3>
                            <form id="profile-info-form" novalidate>
                                <div class="grid-2">
                                    <div class="form-group"><label for="profile-fullname">Full Name</label><input type="text" id="profile-fullname" name="profile-fullname" required></div>
                                    <div class="form-group"><label for="profile-username">Username</label><input type="text" id="profile-username" name="profile-username" required></div>
                                </div>
                                <div class="form-group"><label for="profile-email">Email Address</label><input type="email" id="profile-email" name="profile-email" value="adewale@example.com" required></div>
                                <div class="grid-2">
                                    <div class="form-group"><label for="profile-phone">Phone Number</label><input type="tel" id="profile-phone" name="profile-phone" value="+2348012345678" required></div>
                                    <div class="form-group"><label for="profile-location">State of Origin / Residence</label><input type="text" id="profile-location" name="profile-location" placeholder="e.g., Lagos, Nigeria"></div>
                                </div>
                                 <div class="form-group bio-container">
                                    <label for="profile-bio">Bio / Tagline</label>
                                    <textarea id="profile-bio" name="profile-bio" rows="3"></textarea>
                                </div>
                                <button type="submit" class="btn btn-accent"><i class="fas fa-save"></i> Save All Changes</button>
                            </form>
                        </div>
                        <div id="settings-security" class="settings-content">
                            <h3>Security Settings</h3>
                            <form id="password-reset-form">
                                <h4>Change Password</h4>
                                <div class="form-group"><label for="current-password">Current Password</label><input type="password" id="current-password"></div>
                                <div class="form-group"><label for="new-password">New Password</label><input type="password" id="new-password"></div>
                                <div class="form-group"><label for="confirm-password">Confirm New Password</label><input type="password" id="confirm-password"></div>
                                <button type="submit" class="btn btn-accent">Update Password</button>
                            </form>
                            <hr style="border: 1px solid #eee; margin: 30px 0;">
                            <h4>Active Sessions</h4>
                            <div class="session-item"><div><i class="fas fa-desktop"></i> Chrome on Windows</div><button class="btn btn-small btn-danger">Log Out</button></div>
                            <div class="session-item"><div><i class="fas fa-mobile-alt"></i> Safari on iOS</div><button class="btn btn-small btn-danger">Log Out</button></div>
                        </div>
                        <div id="settings-privacy" class="settings-content static-content">
                            <h3>1. Privacy Policy</h3>
                            <strong>Last Updated:</strong> 13, August, 2025
                            <p>The Empyrean Humanitarian Foundation (“EHF”, “we”, “our”, “us”) is committed to protecting the privacy, security, and dignity of our members, donors, partners, and users of the EMPYREAN Token ecosystem.</p>
                            <p>By accessing our website, mobile applications, or blockchain-powered services, you agree to the practices described below.</p>
                            <h4>1.1 Information We Collect</h4>
                            <p>We may collect the following categories of information:</p>
                            <ul>
                                <li><strong>Personal Information:</strong> Name, email, phone number, date of birth, government-issued identification (for KYC purposes), and profile details.</li>
                                <li><strong>Financial Information:</strong> Bank details, EMPYREAN Token wallet address, transaction history, and linked payment methods.</li>
                                <li><strong>Technical Information:</strong> Device type, IP address, browser type, operating system, and usage patterns.</li>
                                <li><strong>Content Data:</strong> Photos, videos, marketplace listings, posts, and messages you upload or share on our platform.</li>
                            </ul>
                            <h4>1.2 How We Use Your Information</h4>
                            <p>We may use your data to:</p>
                            <ol>
                                <li>Facilitate humanitarian aid and community development projects.</li>
                                <li>Enable secure EMPYREAN Token transactions, including crypto-to-fiat conversions.</li>
                                <li>Process donations, grants, and reward distributions.</li>
                                <li>Provide marketplace and live-stream gifting services.</li>
                                <li>Ensure compliance with anti-money laundering (AML) and counter-terrorist financing (CTF) regulations.</li>
                                <li>Improve user experience, develop new features, and maintain security.</li>
                            </ol>
                            <h4>1.3 Data Sharing</h4>
                            <p>We will never sell your personal information. However, we may share your information:</p>
                            <ul>
                                <li>With verified partners for project execution.</li>
                                <li>With regulators and authorities as required by law.</li>
                                <li>With blockchain networks where necessary for transaction verification.</li>
                            </ul>
                            <h4>1.4 Data Security</h4>
                            <p>We implement encryption, secure socket layer (SSL) protocols, and blockchain security measures to protect your data. While we strive for absolute security, no digital system is 100% immune from breaches.</p>
                            <h4>1.5 Your Rights</h4>
                            <p>You have the right to:</p>
                            <ul>
                                <li>Access, update, or delete your personal data.</li>
                                <li>Withdraw consent for specific data processing activities.</li>
                                <li>File a complaint with your local data protection authority.</li>
                            </ul>
                        </div>
                        <div id="settings-terms" class="settings-content static-content">
                             <h3>2. Terms & Conditions</h3>
                            <h4>2.1 Acceptance of Terms</h4>
                            <p>By using our services, you agree to these Terms & Conditions. If you do not agree, please discontinue use immediately.</p>
                            <h4>2.2 Services Provided</h4>
                            <p>EHF offers:</p>
                            <ul>
                                <li>Humanitarian aid facilitation.</li>
                                <li>EMPYREAN Token cryptocurrency services.</li>
                                <li>Marketplace for goods and services.</li>
                                <li>Live-stream gifting and social engagement platform.</li>
                                <li>Blockchain-integrated mobile banking features.</li>
                            </ul>
                            <h4>2.3 User Obligations</h4>
                            <p>You agree to:</p>
                            <ol>
                                <li>Provide accurate and truthful information.</li>
                                <li>Use the platform lawfully and ethically.</li>
                                <li>Respect community guidelines, avoiding hate speech, fraud, or exploitation.</li>
                                <li>Not use EMPYREAN Token for illegal or unapproved financial activities.</li>
                            </ol>
                            <h4>2.4 Limitation of Liability</h4>
                            <p>EHF will not be liable for:</p>
                            <ul>
                                <li>Losses due to market volatility of EMPYREAN Token.</li>
                                <li>Third-party fraud or hacking incidents outside our control.</li>
                                <li>Service interruptions caused by external factors.</li>
                            </ul>
                             <h3>3. Disclaimer</h3>
                            <p><strong>No Financial Advice:</strong> Content and tools provided by EHF are for informational and humanitarian purposes only, not as investment advice.</p>
                            <p><strong>Token Volatility:</strong> EMPYREAN Token prices may fluctuate due to market forces.</p>
                            <p><strong>Regulatory Compliance:</strong> All crypto transactions are subject to local and international regulations. Users are responsible for ensuring compliance.</p>
                            <p><strong>Third-Party Services:</strong> We are not responsible for the content, policies, or operations of external websites or partners linked from our platform.</p>
                             <h3>4. Governing Law</h3>
                            <p>This agreement is governed by the laws of the Federal Republic of Nigeria, without regard to its conflict of law principles.</p>
                        </div>
                        <div id="settings-ecommerce" class="settings-content static-content">
                            <h3>🛒 E-Commerce Transaction Policy</h3>
                            <p>Our marketplace operates on a dual system designed to offer both maximum security and user flexibility. Please read the following carefully to understand how to transact safely.</p>
                        
                            <hr style="margin: 20px 0;">

                            <h3>1. 🛡️ Secure Escrow Transactions (Recommended)</h3>
                            <p>The escrow system is our recommended method for most transactions, especially when buying from a seller you don't know or cannot meet in person. It protects both the buyer and the seller.</p>
                            <h4>Eligibility:</h4>
                            <ul>
                                <li>Both the Buyer and the Seller <strong>must be KYC-verified</strong> to use the escrow service.</li>
                                <li>Listings eligible for escrow are clearly marked with an "Add to Cart (Escrow)" button and a "✅ Verified Seller" badge.</li>
                            </ul>
                            <h4>Transaction Flow:</h4>
                            <ol>
                                <li>Buyer adds the item to the cart and proceeds to checkout.</li>
                                <li>Buyer pays the full amount into the <strong>Empyrean secure escrow wallet</strong>. The funds are held in trust by us.</li>
                                <li>We notify the Seller to ship the item.</li>
                                <li>The Buyer receives the item and has <strong>48 hours</strong> to inspect it and click <strong>“Confirm Delivery”</strong> on the platform.</li>
                                <li>Once confirmed, we release the funds from escrow to the Seller's wallet.</li>
                            </ol>
                            <h4>Dispute Resolution:</h4>
                            <p>If the item is not as described, the Buyer can click <strong>“Raise a Dispute”</strong> within the 48-hour window. An admin will mediate to arrange a return and refund. If the Buyer does not confirm or raise a dispute within the timeframe, funds are automatically released to the Seller.</p>
                            
                            <hr style="margin: 20px 0;">

                            <h3>2. 🤝 Direct Local Trades (Use with Caution)</h3>
                            <p>This option is for users who can meet physically to inspect an item before buying (e.g., cars, real estate). This method bypasses the platform's checkout and escrow protection.</p>
                             <h4>Eligibility:</h4>
                            <ul>
                                <li>Available to <strong>all users</strong>, including those who are not yet KYC-verified.</li>
                                <li>Listings from unverified sellers will <strong>only</strong> be available for Direct Trade.</li>
                                <li>These listings are marked with a "Contact Seller Directly" button and an "🔶 Unverified Seller" badge.</li>
                            </ul>
                            <h4>Transaction Flow:</h4>
                            <ol>
                                <li>Buyer finds an item and clicks "Contact Seller Directly".</li>
                                <li>The platform reveals the seller's contact information (phone, email, address).</li>
                                <li>The Buyer and Seller arrange a meeting to inspect the item <strong>in person</strong>.</li>
                                <li>Payment is made <strong>directly from the Buyer to the Seller</strong> (e.g., via cash, bank transfer) completely outside of the Empyrean platform.</li>
                            </ol>
                            
                            <h4 style="color: var(--danger-color);">⚠️ IMPORTANT RISK DISCLAIMER ⚠️</h4>
                            <blockquote>
                                <strong>Empyrean is NOT involved in and DOES NOT protect Direct Trade transactions.</strong> We will not be held responsible for any loss, fraud, or disputes arising from these trades.
                                <br><br>
                                <strong>For Your Safety:</strong>
                                <ul>
                                    <li><strong>Always meet in a public, safe place.</strong></li>
                                    <li><strong>NEVER pay for an item before you have physically inspected it</strong> and are satisfied with its condition.</li>
                                    <li>Be wary of deals that seem too good to be true.</li>
                                    <li>Conduct all necessary due diligence. For high-value items like property, we strongly recommend involving legal counsel.</li>
                                </ul>
                                By choosing to "Contact Seller Directly," you acknowledge and accept these risks.
                            </blockquote>
                        </div>
                    </div>
                </div>
            </section>
        
            <section id="business-page" class="content-section">
                <!-- Business Page Content will be rendered here by JS -->
            </section>
            
            <section id="admin" class="content-section">
                <div class="header"><h1><i class="fas fa-user-shield"></i> Admin Panel</h1></div>
                <div class="card">
                    <h3><span><i class="fas fa-check-circle" style="color:var(--success-color)"></i> Pending Withdrawal Approvals</span></h3>
                    <div id="admin-withdrawal-queue" class="card-content" style="padding:0;"></div>
                </div>
                <div class="card">
                    <h3><span><i class="fas fa-exclamation-circle" style="color:var(--danger-color)"></i> SOS Request Verification</span></h3>
                    <div id="admin-sos-queue" class="card-content" style="padding:0;"></div>
                </div>
                <div class="card">
                    <h3><span><i class="fas fa-gavel" style="color:var(--danger-color)"></i> Marketplace Disputes</span></h3>
                     <div id="admin-dispute-queue" class="card-content" style="padding:0;">
                        <div class="admin-queue-item">
                            <div class="admin-queue-info">
                                <p><strong>Dispute ID:</strong> #DP-123</p><p><strong>Item:</strong> 3 Bedroom Flat for Sale</p>
                                <p><strong>Buyer:</strong> @buyer123 | <strong>Seller:</strong> @ade_adebayo</p>
                            </div>
                            <div class="admin-queue-actions">
                                <button class="btn btn-small">Review</button>
                            </div>
                        </div>
                     </div>
                </div>
            </section>
            
            <!-- NEW SECTION: Grant Portal -->
            <section id="grant-portal" class="content-section">
                <div class="header"><h1><i class="fas fa-file-invoice-dollar"></i> Grant Transparency Portal</h1></div>
                <div class="card">
                    <div class="card-content">
                        <h3>Immutable Disbursement Ledger</h3>
                        <p>This public ledger provides a transparent, unchangeable record of all grants disbursed by the Empyrean Foundation to our partners, powered by blockchain principles.</p>
                        <div class="table-container">
                            <table class="styled-table">
                                <thead>
                                    <tr>
                                        <th>Grant ID</th>
                                        <th>Recipient NGO</th>
                                        <th>Project</th>
                                        <th>Amount (EMPY)</th>
                                        <th>Transaction Hash</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody id="grant-ledger-body">
                                    <!-- Rows will be injected by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- NEW SECTION: Community Tasks -->
            <section id="community-tasks" class="content-section">
                <div class="header"><h1><i class="fas fa-tasks"></i> Community Tasks & Rewards</h1></div>
                <div class="card">
                    <div class="card-content">
                        <h3>Complete Tasks, Earn EMPY</h3>
                        <p>Help our community grow and get rewarded for your efforts! Complete the tasks below.</p>
                        <ul class="task-list" id="community-tasks-list" style="margin-top: 20px;">
                           <!-- Tasks will be injected by JS -->
                        </ul>
                    </div>
                </div>
            </section>
            
            <!-- NEW SECTION: NGO Partners -->
            <section id="ngo-partners" class="content-section">
                 <div class="header"><h1><i class="fas fa-hands-helping"></i> Our NGO Partners</h1><button class="btn" id="back-to-ngo-grid" style="display:none;"><i class="fas fa-arrow-left"></i> Back to All NGOs</button></div>
                 <div id="ngo-grid-view">
                    <div class="card">
                        <div class="card-content">
                            <h3>Vetted & Verified Partners</h3>
                            <p>We partner with incredible organizations making a real impact on the ground. Explore their work and support their projects directly.</p>
                            <!-- FIX 3: NGO SLIDER IMPLEMENTATION -->
                            <div class="horizontal-slider-container">
                                <div class="horizontal-slider-wrapper" id="ngo-grid-container">
                                    <!-- NGO cards will be injected here by JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                 </div>
                 <div id="ngo-profile-view">
                    <!-- NGO Profile will be built here by JS -->
                 </div>
            </section>

            <!-- === WHITEPAPER SECTION (NEW) === -->
            <section id="whitepaper" class="content-section">
                <div id="whitepaper-container">
                     <header>
                        <div id="logo-frame" class="logo-uploader" title="Click to upload your logo">
                            <img id="logo-placeholder" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9InRyYW5zcGFyZW50IiAvPjxwYXRoIGQ9Ik01MCAxMCBDMzAgMTAgMTUgMjUgMTUgNDUgQzE1IDY1IDMwIDg1IDUwIDg1IEM3MCA4NSA4NSA2NSA4NSA0NSBDODUgMjUgNzAgMTAgNTAgMTAgWiBNNTAgMjAgQzY1IDIwIDc1IDMwIDc1IDQ1IEM3NSA2MCA2NSAgeDcwIDUwIDcwIEMzNSAgeDcwIDI1IDYwIDI1IDQ1IEMyNSAzMCAzNSAyMCA1MCAyMCBaIiBmaWxsPSIjRkZGRkZGIiAvPjxwYXRoIGQ9Ik01MCAzMCBMNDAgNDAgTDUwIDYwIEw2MCA0MCBaIiBmaWxsPSIjRkZGRkZGIiAvPjwvc3ZnPg==" alt="Organization Logo">
                            <span class="upload-text">Upload Logo</span>
                        </div>
                        <input type="file" id="logo-upload-input" accept="image/*">
                        <h1>THE EMPYREAN MANIFESTO</h1>
                        <p>Whitepaper V6.0</p>
                        <button id="preview-pdf-btn" class="action-button">Preview & Download PDF</button>
                    </header>

                    <nav id="navbar">
                        <a href="#abstract">Abstract</a><a href="#problem">Problem</a><a href="#token">Token</a>
                        <a href="#tokenomics">Tokenomics</a><a href="#architecture">Architecture</a><a href="#strategy">Strategy</a><a href="#roadmap">Roadmap</a>
                    </nav>

                    <div class="container">
                        <div id="content-to-pdf">
                            <section id="abstract"><h2>ABSTRACT</h2><p>The Empyrean Humanitarian Foundation is developing a decentralized ecosystem designed to correct the inefficiencies and lack of transparency that plague traditional finance and philanthropy. We are building a comprehensive platform on the Polygon PoS blockchain that merges a robust financial system with tangible, real-world humanitarian impact. The cornerstone of this ecosystem is the <strong>Empyrean Token (EMPY)</strong>, a capped, deflationary utility token engineered to fuel a self-sustaining circular economy.</p><p>EMPY powers every interaction within our ecosystem—from transparent donations and P2P commerce to creator monetization and a unique social rewards system called Impact Mining. This whitepaper details the architectural design, tokenomic model, multi-sectoral strategy, and development roadmap for a platform built to empower individuals, foster youth empowerment through skills acquisition and innovation hubs, and restore trust in the social contract for the digital age.</p></section>
                            <section id="key-features"><h2>Key Pillars of Empyrean</h2><div class="features-grid"><div class="feature-card"><div class="feature-icon"></div><h3>Social Rewards</h3><p>Rewarding users for actions that strengthen the community through Impact Mining.</p></div><div class="feature-card"><div class="feature-icon"></div><h3>Decentralized Commerce</h3><p>A secure peer-to-peer marketplace for goods and services using EMPY.</p></div><div class="feature-card"><div class="feature-icon"></div><h3>Transparent Aid</h3><p>An immutable donor portal that provides a publicly auditable trail of all funds.</p></div><div class="feature-card"><div class="feature-icon"></div><h3>Creator Economy</h3><p>Empowering creators with livestreaming and video features for "proof of impact."</p></div></div></section>
                            <section id="problem"><h2>1. The Problem & The Empyrean Solution</h2><p>The modern world faces a crisis of trust. Centralized systems, from financial institutions to aid organizations, are often opaque, inefficient, and exclusionary. This results in critical failures:</p><ul><li><strong>Inefficient Aid:</strong> A significant portion of humanitarian aid is lost to administrative overhead, corruption, and logistical friction.</li><li><strong>Financial Exclusion:</strong> Billions of people lack access to basic financial services.</li><li><strong>Opaque Philanthropy & Donor Disconnect:</strong> Donors have no verifiable way to track how their funds are used.</li><li><strong>Exploitative Creator Economies:</strong> Centralized platforms often extract disproportionate value from content creators.</li><li><strong>Youth Disenfranchisement & Skills Gap:</strong> Young populations in developing regions often lack access to modern skills training and opportunities, leading to unemployment and stifled innovation.</li><li><strong>Broken Trust:</strong> A lack of verifiable transparency leads to skepticism and donor fatigue.</li></ul><h3>Empyrean is the solution.</h3><p>We leverage blockchain technology to build a new paradigm founded on the four interconnected pillars detailed above.</p></section>
                            <section id="token"><h2>2. The EMPY Token: Fuel for a Regenerative Economy</h2><ul><li><strong>Token Name:</strong> Empyrean Token (EMPY)</li><li><strong>Blockchain:</strong> Polygon (PoS)</li><li><strong>Maximum Supply:</strong> 150,000,000 EMPY</li><li><strong>Standard:</strong> ERC-20</li></ul><h4>Contract Features:</h4><p><strong>Capped Supply 🔒:</strong> Guarantees provable scarcity.<br><strong>Mintable Functionality ➕:</strong> Allows for the controlled release of rewards.<br><strong>Burnable Standard 🔥:</strong> A deflationary mechanism to increase long-term value.</p><h4>Core Utilities of EMPY</h4><ul><li><strong>Governance:</strong> Grants voting rights within the future Empyrean DAO.</li><li><strong>Medium of Exchange:</strong> The primary currency for all marketplace transactions.</li><li><strong>Donations & Crowdfunding:</strong> The core mechanism for funding humanitarian requests.</li><li><strong>Staking & Mining:</strong> Users can stake EMPY to secure the network and generate yield.</li><li><strong>Access to Services:</strong> Used to pay for promotions and premium features.</li><li><strong>Rewards:</strong> Distributed to users for their positive contributions.</li></ul></section>
                            <section id="tokenomics"><h2>3. Tokenomics: A Blueprint for Sustainable Growth</h2><p>The EMPY token allocation is strategically designed to foster long-term growth and incentivize community participation.</p><h4>Allocation Breakdown (150,000,000 EMPY):</h4><ul><li><strong>25% – Impact Mining & Community Rewards</strong></li><li><strong>10% – Staking Pool</strong></li><li><strong>25% – Grants & Impact Fund</strong></li><li><strong>15% – Treasury & Liquidity</strong></li><li><strong>15% – Partnerships & Ecosystem Growth</strong></li><li><strong>10% – Team & Advisors</strong></li></ul><h4>Vesting Schedules & Trust</h4><p>All Team & Advisor tokens will be locked in a smart contract with a 4-year vesting period and a 12-month cliff.</p><h4>Deflationary Mechanism: The Burn</h4><p>A percentage of fees generated by the platform will be permanently burned. This mechanism is transparent and verifiable on-chain.</p></section>
                            <section id="architecture"><h2>4. The Empyrean Ecosystem Architecture</h2><p>The ecosystem is delivered through a single, powerful decentralized application (dApp).</p><h4>Core Modules of the Empyrean dApp:</h4><ol><li><strong>Humanitarian & Aid Portal:</strong> General Requests and an SOS Request Section.</li><li><strong>Community Intelligence Hub:</strong> A Crisis Reporting Module and a Broadcast News Section.</li><li><strong>Social & Creator Economy:</strong> A Reels & Stories Section and Empyrean Live for fundraising.</li><li><strong>Economic Engine:</strong> A P2P Marketplace and an Integrated Wallet.</li></ol></section>
                            <section id="strategy"><h2>5. Multi-Sectoral Strategy for Tangible Impact</h2><p>Empyrean is designed to be a bridge to the real world, focusing on initiatives that create sustainable, long-term value.</p><p>🌱 <strong>Youth Empowerment & Economic Opportunity</strong><br>Our primary real-world initiative focuses on <strong>youth empowerment</strong>. We will establish <strong>innovation hubs</strong> that serve as centers for <strong>skills acquisition</strong>, offering targeted training to prepare youth for the future economy. Key areas of focus will include:</p><ul><li>Sustainable Agriculture</li><li>Entrepreneurship</li></ul><p>By connecting skilled youth with global opportunities through our P2P marketplace, we aim to <strong>boost diverse employment opportunities</strong> and cultivate a new generation of innovators.</p><p>🏠 <strong>Real Estate & Infrastructure</strong><br>🛡️ <strong>Fraud Awareness & Financial Literacy</strong><br>🌍 <strong>Diaspora Engagement</strong></p></section>
                            <section id="roadmap"><h2>6. Roadmap: A Phased Approach</h2><h3>Phase 0: Foundational Development (2025)</h3><ul><li><strong>Q1-Q2:</strong> Core Smart Contract Development.</li><li><strong>Q3:</strong> Security Audits & Testnet Deployment.</li><li><strong>Q4:</strong> Iteration & Community Building.</li></ul><h3>Phase 1: Public Launch (Q1–Q2 2026)</h3><ul><li>Mainnet Deployment, TGE & IDL.</li><li>DApp V1 Launch.</li></ul><h3>Phase 2: Ecosystem Expansion (Q3–Q4 2026)</h3><ul><li>Launch of Marketplace, SOS Request, and Reels.</li><li>Onboarding partners and applying for CEX Listings.</li></ul><h3>Phase 3: Mass Adoption (2027 Onward)</h3><ul><li>DAO rollout and Empyrean Live launch.</li><li>Development of the Empyrean crypto debit card.</li></ul></section>
                            <section id="conclusion"><h2>7. Conclusion</h2><p>The Empyrean Humanitarian Foundation is not just launching a cryptocurrency; we are architecting a new economic and social paradigm focused on tangible outcomes like youth employment and skills development.</p><h3>Join us. Let’s build a more transparent, rewarding, and impactful world together.</h3></section>
                            <section id="disclaimer"><h2>8. Disclaimer</h2><p class="disclaimer">This whitepaper is for informational purposes only and is not investment advice. Investing in cryptocurrencies involves a high degree of risk. Please conduct your own thorough research.</p></section>
                        </div>
                    </div>
                    <div id="pdf-modal" class="pdf-modal">
                        <div class="modal-content">
                            <div class="modal-header"><h2>PDF Preview</h2><span id="close-modal-btn" class="close-button">×</span></div>
                            <div class="pdf-preview-area"><iframe id="pdf-embed" frameborder="0"></iframe></div>
                            <div class="modal-footer"><button id="cancel-btn" class="action-button" style="background-color: #aaa; border-color: #777;">Cancel</button><button id="confirm-download-btn" class="action-button">Confirm Download</button></div>
                        </div>
                    </div>
                    <footer><p>© 2025 Empyrean Humanitarian Foundation. All Rights Reserved.</p></footer>
                </div>
            </section>


        </main>
    </div>

    <div class="modal-overlay" id="cart-modal-overlay">
        <div class="cart-modal" id="cart-modal-container">
            <div id="cart-view">
                <h2><i class="fas fa-shopping-cart"></i> Your Cart</h2>
                <div id="cart-items-container"><p>Your cart is empty.</p></div>
                <div id="cart-total">Total: $0.00</div>
                <div style="text-align: right; margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn close-modal-btn" style="background-color: #666;">Close</button>
                    <button class="btn btn-accent checkout-btn">Proceed to Checkout</button>
                </div>
            </div>
            <div id="checkout-view">
                <h2><i class="fas fa-shield-alt"></i> Checkout</h2>
                <form id="checkout-form">
                    <h4>Shipping Information</h4>
                    <div class="form-group"><label for="checkout-name">Full Name</label><input type="text" id="checkout-name" required></div>
                    <div class="form-group"><label for="checkout-address">Delivery Address</label><input type="text" id="checkout-address" required></div>
                    <hr style="border: 1px solid #eee; margin: 20px 0;">
                    <h4>Payment Details</h4>
                    <div class="payment-tabs">
                        <div class="payment-tab active" data-target="escrow-payment"><i class="fas fa-shield-alt"></i> Secure Escrow</div>
                        <div class="payment-tab" data-target="direct-payment"><i class="fas fa-credit-card"></i> Direct Payment</div>
                    </div>
                    <div id="escrow-payment" class="payment-method-content active">
                        <p style="font-size: 0.9rem; margin-bottom: 15px; background: #e3f2fd; padding:10px; border-radius: 5px;">Your payment will be held securely by Empyrean and only released to the seller after you confirm delivery. Available for verified sellers only.</p>
                    </div>
                    <div id="direct-payment" class="payment-method-content">
                         <p style="font-size: 0.9rem; margin-bottom: 15px; background: #fff8e1; padding:10px; border-radius: 5px;"><strong>Warning:</strong> You are paying the seller directly. Empyrean cannot protect you against fraud in this transaction.</p>
                    </div>

                    <div class="form-group"><label for="checkout-card-number">Card Number</label><input type="text" required placeholder="0000 0000 0000 0000"></div>
                     <div class="grid-2">
                        <div class="form-group"><label for="checkout-expiry">Expiry</label><input type="text" required placeholder="MM/YY"></div>
                        <div class="form-group"><label for="checkout-cvv">CVV</label><input type="text" required placeholder="123"></div>
                    </div>
                    <div class="dispute-section" id="dispute-resolution-section" style="display:none;">
                       <h4><i class="fas fa-exclamation-triangle"></i> Raise a Dispute</h4>
                       <p>If the item is not as described, you can raise a dispute within 48 hours of delivery.</p>
                       <div class="form-group"><label for="dispute-reason">Reason:</label><textarea id="dispute-reason" rows="3"></textarea></div>
                       <div class="form-group"><label for="dispute-proof">Upload Proof:</label><input type="file" id="dispute-proof"></div>
                       <button type="button" class="btn btn-danger">Submit Dispute</button>
                    </div>
                    <div style="text-align: right; margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" class="btn back-to-cart-btn" style="background-color: #666;">Back to Cart</button>
                        <button type="submit" class="btn btn-success finalize-purchase-btn">Finalize Purchase</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script async src="https://cse.google.com/cse.js?cx=c161781316eff4024"></script>

    <!-- Ethers.js library for blockchain interaction -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- SMART CONTRACT CONFIGURATION ---
            const contractAddresses = {
                EmpyreanToken: "0x624ca3Db53adb41944EbF2BcB015f68C7BAB0c02",
                EmpyDistribution: "0xf48ee3c90c9183fb4acd0d9e1ef8b49accfc470e",
                NgoAndGrantRegistry: "0xc861e3ae9a35336c9735692d788065c4a0e37ebb",
                EmpyreanStaking: "0xba368a7b31f61748aef714ef779dd8086d38a1fc"
            };

            const contractABIs = {
                EmpyreanToken: [/* The full ABI for EmpyreanToken.sol goes here */],
                EmpyDistribution: [{"inputs":[{"internalType":"address","name":"_empyTokenAddress","type":"address"},{"internalType":"address","name":"_initialOwner","type":"address"},{"internalType":"uint256","name":"_minimumWithdrawal","type":"uint256"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"OwnableInvalidOwner","type":"error"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"OwnableUnauthorizedAccount","type":"error"},{"inputs":[{"internalType":"address","name":"token","type":"address"}],"name":"SafeERC20FailedOperation","type":"error"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newMinimum","type":"uint256"}],"name":"MinimumWithdrawalUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"RewardsClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"RewardsRecorded","type":"event"},{"inputs":[],"name":"claimRewards","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"empyToken","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getClaimableBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"minimumWithdrawal","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"recordRewards","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"rewards","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalClaimed","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"newMinimum","type":"uint256"}],"name":"updateMinimumWithdrawal","outputs":[],"stateMutability":"nonpayable","type":"function"}],
                NgoAndGrantRegistry: [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"OwnableInvalidOwner","type":"error"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"OwnableUnauthorizedAccount","type":"error"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"ngoAddress","type":"address"},{"indexed":false,"internalType":"string","name":"name","type":"string"}],"name":"NgoAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"ngoAddress","type":"address"}],"name":"NgoDelisted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"ngoAddress","type":"address"}],"name":"NgoUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"grantId","type":"uint256"},{"indexed":true,"internalType":"address","name":"recipient","type":"address"},{"indexed":false,"internalType":"string","name":"currency","type":"string"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"string","name":"projectId","type":"string"},{"indexed":false,"internalType":"string","name":"transactionReference","type":"string"}],"name":"OffChainGrantDisbursed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"grantId","type":"uint256"},{"indexed":true,"internalType":"address","name":"recipient","type":"address"},{"indexed":true,"internalType":"address","name":"tokenAddress","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"string","name":"projectId","type":"string"}],"name":"OnChainGrantDisbursed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"inputs":[{"internalType":"address","name":"_ngoAddress","type":"address"},{"internalType":"string","name":"_name","type":"string"},{"internalType":"string","name":"_detailsUrl","type":"string"}],"name":"addNgo","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_ngoAddress","type":"address"}],"name":"delistNgo","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"getOffChainGrantCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getOnChainGrantCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getVerifiedNgoCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_offset","type":"uint256"},{"internalType":"uint256","name":"_limit","type":"uint256"}],"name":"getVerifiedNgos","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"ngoAddressList","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"ngos","outputs":[{"internalType":"string","name":"name","type":"string"},{"internalType":"string","name":"detailsUrl","type":"string"},{"internalType":"bool","name":"isVerified","type":"bool"},{"internalType":"uint256","name":"listIndex","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"offChainGrants","outputs":[{"internalType":"address","name":"recipient","type":"address"},{"internalType":"string","name":"currency","type":"string"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"string","name":"projectId","type":"string"},{"internalType":"string","name":"transactionReference","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"onChainGrants","outputs":[{"internalType":"address","name":"recipient","type":"address"},{"internalType":"address","name":"tokenAddress","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"string","name":"projectId","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_recipient","type":"address"},{"internalType":"uint256","name":"_amount","type":"uint256"},{"internalType":"string","name":"_currency","type":"string"},{"internalType":"string","name":"_projectId","type":"string"},{"internalType":"string","name":"_transactionReference","type":"string"}],"name":"recordOffChainGrant","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_recipient","type":"address"},{"internalType":"address","name":"_tokenAddress","type":"address"},{"internalType":"uint256","name":"_amount","type":"uint256"},{"internalType":"string","name":"_projectId","type":"string"}],"name":"recordOnChainGrant","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_ngoAddress","type":"address"},{"internalType":"string","name":"_name","type":"string"},{"internalType":"string","name":"_detailsUrl","type":"string"}],"name":"updateNgoDetails","outputs":[],"stateMutability":"nonpayable","type":"function"}],
                EmpyreanStaking: [{"inputs":[{"internalType":"address","name":"_empyTokenAddress","type":"address"},{"internalType":"address","name":"_rewardsDistributionAddress","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"OwnableInvalidOwner","type":"error"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"OwnableUnauthorizedAccount","type":"error"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"reward","type":"uint256"}],"name":"RewardPaid","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newRate","type":"uint256"}],"name":"RewardRateUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"Staked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"Unstaked","type":"event"},{"inputs":[],"name":"claimReward","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_account","type":"address"}],"name":"earned","outputs":[{"internalType":"uint256","name":""}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_newRate","type":"uint256"}],"name":"setRewardRate","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"stake","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"unstake","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":""}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"empyToken","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"lastUpdateTime","outputs":[{"internalType":"uint256","name":""}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"rewardPerToken","outputs":[{"internalType":"uint256","name":""}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"rewardPerTokenStored","outputs":[{"internalType":"uint256","name":""}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"rewardRate","outputs":[{"internalType":"uint256","name":""}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"rewards","outputs":[{"internalType":"uint256","name":""}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"rewardsDistributionContract","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":""}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"userRewardPerTokenPaid","outputs":[{"internalType":"uint256","name":""}],"stateMutability":"view","type":"function"}]
            };
            
            // --- STATE & CONFIG ---
            let provider, signer, contracts = {};
            let isGuest = true;
            let isAdmin = false;
            let cart = [];
            const EMPY_RATE_USD = 0.10;
            const USD_TO_NGN_RATE = 1500;
            const CRYPTO_FEE_PERCENT = 1.5;
            let userState = {};
            let captchaCode = '';
            let postMediaFiles = [], sosMediaFiles = [], crisisMediaFiles = [], businessPostMediaFiles = [];
            let marketplaceMediaFiles = [];
            let statusMediaFile = null;
            let newsMediaFile = null;
            let newAvatarFile = null;
            let newCoverFile = null;
            let newPageProfileFile = null, newPageCoverFile = null;
            let liveStreamData = { isRecording: false, title: '', startTime: null, streamId: null, background: '', rewardInterval: null };
            let liveLikeCount = 0;
            let statusTimer;
            
            let registeredUsers = {};

            // Staking and Impact Mining Simulation State
            let userStakedBalance = 0;
            let userEarnedRewards = 0;
            const STAKING_APY_ESTIMATE = 0.157; // 15.7%
            
            // From EmpyDistribution contract: 25% of 150M is 37.5M for Impact Mining
            const IMPACT_MINING_TOTAL_POOL = 37500000; 
            // 10% of that 25% is allocated for Ranking Rewards
            const RANKING_REWARDS_POOL = IMPACT_MINING_TOTAL_POOL * 0.10; // 3,750,000 EMPY
            let impactMiningState = {
                dailyBudget: (IMPACT_MINING_TOTAL_POOL * 0.90) / (10 * 365.25), // Daily budget from the remaining 90%
                dailySpent: 0,
                rankingPoolSpent: 0,
                lastReset: new Date().setHours(0,0,0,0) // Set to the beginning of the current day
            };

            const empyGiftCatalog = [
                { name: 'Rose', symbol: '🌹', price: 1 }, { name: 'Like', symbol: '👍', price: 2 }, { name: 'Heart', symbol: '❤️', price: 3 }, { name: 'Coffee', symbol: '☕', price: 5 }, { name: 'Star', symbol: '⭐', price: 7 }, { name: 'Chocolate', symbol: '🍫', price: 10 }, { name: 'Ice Cream', symbol: '🍦', price: 12 }, { name: 'Balloon', symbol: '🎈', price: 15 }, { name: 'Cupcake', symbol: '🧁', price: 18 }, { name: 'Candy', symbol: '🍬', price: 20 },
                { name: 'Teddy Bear', symbol: '🧸', price: 25 }, { name: 'Pizza Slice', symbol: '🍕', price: 30 }, { name: 'Popcorn', symbol: '🍿', price: 35 }, { name: 'Music Note', symbol: '🎵', price: 40 }, { name: 'Flower Bouquet', symbol: '💐', price: 50 }, { name: 'Football', symbol: '⚽', price: 60 }, { name: 'Sunglasses', symbol: '😎', price: 70 }, { name: 'Perfume', symbol: '💄', price: 80 }, { name: 'Cat', symbol: '🐱', price: 90 }, { name: 'Dog', symbol: '🐶', price: 100 },
                { name: 'Diamond Ring', symbol: '💍', price: 120 }, { name: 'Camera', symbol: '📷', price: 150 }, { name: 'Champagne', symbol: '🍾', price: 180 }, { name: 'Guitar', symbol: '🎸', price: 200 }, { name: 'Laptop', symbol: '💻', price: 250 }, { name: 'Gold Medal', symbol: '🥇', price: 300 }, { name: 'Airplane', symbol: '✈️', price: 350 }, { name: 'Luxury Watch', symbol: '⌚', price: 400 }, { name: 'Car', symbol: '🚗', price: 450 }, { name: 'Yacht', symbol: '🛥️', price: 500 },
                { name: 'Mansion', symbol: '🏠', price: 1000 }, { name: 'Helicopter', symbol: '🚁', price: 2000 }, { name: 'Private Jet', symbol: '🛫', price: 3500 }, { name: 'Crown', symbol: '👑', price: 5000 }, { name: 'Island', symbol: '🏝️', price: 7500 }, { name: 'Diamond Trophy', symbol: '🏆💎', price: 10000 }
            ];

            const liveBackgrounds = [
                'https://source.unsplash.com/random/450x700/?studio,lights', 'https://source.unsplash.com/random/450x700/?nature,calm', 'https://source.unsplash.com/random/450x700/?city,night', 'https://source.unsplash.com/random/450x700/?library,books', 'https://source.unsplash.com/random/450x700/?art,gallery',
                'https://source.unsplash.com/random/450x700/?tech,abstract', 'https://source.unsplash.com/random/450x700/?music,concert', 'https://source.unsplash.com/random/450x700/?galaxy', 'linear-gradient(45deg, #8E2DE2, #4A00E0)', 'linear-gradient(to right, #00b09b, #96c93d)', 'linear-gradient(135deg, #ff7e5f, #feb47b)',
                'linear-gradient(to top, #c471f5 0%, #fa71cd 100%)', 'linear-gradient(120deg, #f6d365 0%, #fda085 100%)', 'linear-gradient(to right, #4facfe 0%, #00f2fe 100%)'
            ];
            
            const textStatusColors = [
                '#F44336', '#2196F3', '#4CAF50', '#FFC107', '#9C27B0', '#009688', '#E91E63', 
                'linear-gradient(45deg, #ff9a9e 0%, #fad0c4 100%)', 'linear-gradient(to right, #6a11cb 0%, #2575fc 100%)',
                'linear-gradient(to right, #ff7e5f, #feb47b)', 'linear-gradient(to right, #00c9ff, #92fe9d)'
            ];

            // --- MOCK DATA ---
            let mockUsers = {
                'user-1': { id: 'user-1', username: 'KanoConnect', fullName: 'Kano Connect', avatar: 'https://source.unsplash.com/random/150x150/?water-well', coverPhoto: 'https://source.unsplash.com/random/1200x400/?kano', followerCount: 520, statuses: [], awardedRanks: new Set(), retweetedPostIds: new Set() },
                'user-2': { id: 'user-2', username: 'samuel_okoro', fullName: 'Samuel Okoro', avatar: 'https://source.unsplash.com/random/150x150/?student-nigeria', coverPhoto: 'https://source.unsplash.com/random/1200x400/?university', followerCount: 88, statuses: [ { type: 'text', content: 'Almost there! Just one final push needed for my graduation. #Hopeful', color: textStatusColors[1], duration: 5000 }, { type: 'image', url: 'https://source.unsplash.com/random/600x800/?university', caption: 'My university campus', duration: 5000 }], awardedRanks: new Set(), retweetedPostIds: new Set() },
                'user-3': { id: 'user-3', username: 'NairobiVibes', fullName: 'Nairobi Vibes', avatar: 'https://source.unsplash.com/random/150x150/?kenya', coverPhoto: 'https://source.unsplash.com/random/1200x400/?nairobi', followerCount: 2500, statuses: [ { type: 'video', url: 'https://www.w3schools.com/html/mov_bbb.mp4', caption: 'The vibrant market today!', duration: 10000 }], awardedRanks: new Set(), retweetedPostIds: new Set() }
            };

            let mockAdminWithdrawalQueue = [
                { id: 'wd-1', userId: 'user-2', username: 'samuel_okoro', amount: '1,500 EMPY', method: 'Bank Transfer' },
                { id: 'wd-2', userId: 'user-3', username: 'NairobiVibes', amount: '5,000 EMPY', method: 'USDT Transfer' }
            ];
            let mockAdminSosQueue = [
                { id: 'sos-1', userId: 'user-2', username: 'samuel_okoro', title: "Final Year Tuition Fees", story: "I'm a final year Computer Science student at the University of Ibadan. I urgently need funds to cover my outstanding tuition fees. Your support will help me graduate. Thank you!", amount: "250000", currency: "NGN", media: [], avatar: 'https://source.unsplash.com/random/150x150/?student-nigeria' },
            ];

            const mockGrantLedger = [
                { id: 'G-001', ngo: 'Hope for Africa Initiative', project: 'Clean Water Borehole - Kano', amount: 150000, txHash: '0x1a2b...', status: 'Completed', date: '2025-08-01' },
                { id: 'G-002', ngo: 'Edu-First Nigeria', project: 'School Supplies Drive - Lagos', amount: 75000, txHash: '0x3c4d...', status: 'Completed', date: '2025-07-25' },
                { id: 'G-003', ngo: 'Agri-Grow Cooperative', project: 'Seed Funding for Maize Farmers', amount: 250000, txHash: '0x5e6f...', status: 'Completed', date: '2025-07-18' }
            ];

            const mockCommunityTasks  = [
                { id: 'task-1', text: 'Follow on X (Twitter)', icon: 'fab fa-twitter', url: 'https://x.com/EmpyToken?t=1dXjQMtmz4y2ZSm_v7S52w&s=09', reward: 5 },
                { id: 'task-2', text: 'Follow on Instagram', icon: 'fab fa-instagram', url: 'https://www.instagram.com/empyreantoken_empy?igsh=MXBpcWl3Y3Jkc3ljag==', reward: 5 },
                { id: 'task-3', text: 'Subscribe on YouTube', icon: 'fab fa-youtube', url: 'https://www.youtube.com/@EmpyreanHFNewsTV', reward: 10 },
                { id: 'task-4', text: 'Connect on LinkedIn', icon: 'fab fa-linkedin', url: 'https://www.linkedin.com/company/108660039/admin/', reward: 8 },
                { id: 'task-5', text: 'Join our Telegram', icon: 'fab fa-telegram-plane', url: 'https://t.me/EmpyreanToken', reward: 10 },
                { id: 'task-6', text: 'Join our WhatsApp Channel', icon: 'fab fa-whatsapp', url: 'https://whatsapp.com/channel/0029VbAyfxaAzNc45vhje92j', reward: 10 }
            ];
            
            const mockNgoPartners = {
                'ngo-1': { 
                    id: 'ngo-1', 
                    name: 'Hope for Africa Initiative', 
                    logo: 'https://source.unsplash.com/random/150x150/?logo-hope', 
                    description: "Dedicated to providing sustainable solutions for clean water and sanitation in rural communities across Africa.",
                    stats: { raised: 250000, projects: 5, peopleHelped: 8000 },
                    posts: [
                        { postId: 'ngo-post-1', userId: 'ngo-1', content: 'Our *latest borehole project* is complete! Thanks to your support, the village of Rimin Gado now has access to clean drinking water. _This changes everything._', media: [{ type: 'image', url: 'https://source.unsplash.com/random/800x600/?water-pump-africa' }] }
                    ]
                },
                'ngo-2': { 
                    id: 'ngo-2', 
                    name: 'Edu-First Nigeria', 
                    logo: 'https://source.unsplash.com/random/150x150/?logo-education', 
                    description: "Ensuring every child in underserved Nigerian communities has access to quality education and school supplies.",
                    stats: { raised: 120000, projects: 12, peopleHelped: 5000 },
                    posts: [
                         { postId: 'ngo-post-2', userId: 'ngo-2', content: 'Distributing over 2,000 backpacks filled with books and stationery to students in Makoko. Their smiles say it all!', media: [{ type: 'image', url: 'https://source.unsplash.com/random/800x600/?children-school-supplies' }] }
                    ]
                 }
            };
            
            // --- DOM REFERENCES ---
            const sidebar = document.querySelector('.sidebar');
            const feedContainer = document.getElementById('feed-container');
            const authModal = document.getElementById('auth-modal-overlay');
            const goLiveModal = document.getElementById('go-live-modal-overlay');
            const contentOverlay = document.getElementById('content-overlay');

            // --- HELPER FUNCTIONS ---
            const formatNgnPrice = (price) => new Intl.NumberFormat('en-NG', { style: 'currency', currency: 'NGN', minimumFractionDigits: 2 }).format(price);
            const formatUsdPrice = (price) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2 }).format(price);
            
            function showNotification(message, type = 'success') {
                const el = document.getElementById('reward-notification');
                el.textContent = message;
                el.style.backgroundColor = `var(--${type}-color)`;

                if (type === 'warning') {
                    el.style.color = 'var(--text-color)';
                } else {
                    el.style.color = 'var(--white-color)';
                }

                el.classList.add('show');
                setTimeout(() => el.classList.remove('show'), 3500);
            }

            function rewardUserForAction(action, targetUserId = null) {
                if (isGuest) return;

                const now = new Date().setHours(0,0,0,0);
                if(now > impactMiningState.lastReset) {
                    impactMiningState.dailySpent = 0;
                    impactMiningState.lastReset = now;
                }
                
                if (impactMiningState.dailySpent >= impactMiningState.dailyBudget) {
                    return; // Daily budget exhausted
                }

                const rewardsTable = {
                    VERIFIED_CRISIS_REPORT: 50, VERIFIED_SOS_REQUEST: 25,
                    SUCCESSFUL_ESCROW_SELLER: 15, SUCCESSFUL_ESCROW_BUYER: 5,
                    CREATE_REEL: 2.0, CREATE_POST: 1.0, PUBLISH_NEWS: 10,
                    LIVE_STREAM_INTERVAL: 2.0, // Per 5 minutes
                    RECEIVE_COMMENT: 0.2, RECEIVE_LIKE: 0.1,
                    ENGAGE_COMMENT: 0.05, ENGAGE_LIKE: 0.02,
                    SUCCESSFUL_REFERRAL: 20,
                    SHARE_POST: 0.5,
                    RETWEET_POST: 0.5
                };

                const rewardAmount = rewardsTable[action] || 0;
                if (rewardAmount === 0 || (impactMiningState.dailySpent + rewardAmount > impactMiningState.dailyBudget)) {
                    return;
                }
                
                let recipient = userState;
                if (targetUserId && mockUsers[targetUserId]) {
                    recipient = mockUsers[targetUserId];
                }

                if (!recipient.empyBalance) recipient.empyBalance = 0;
                recipient.empyBalance += rewardAmount;
                impactMiningState.dailySpent += rewardAmount;

                // For actions that reward the current user, show a notification
                if (!targetUserId && action !== 'RECEIVE_LIKE' && action !== 'RECEIVE_COMMENT') {
                    showNotification(`+${rewardAmount.toFixed(2)} EMPY for your contribution!`, 'success');
                }

                updateWalletUI(); // Always update wallet UI after any balance change
            }

            
            function showFormFeedback(formId, message, type = 'error') {
                const feedbackEl = document.getElementById(`${formId}-feedback`);
                if (!feedbackEl) return;
                feedbackEl.textContent = message;
                feedbackEl.className = `form-feedback ${type}`;
                feedbackEl.style.display = 'block';
            }

            function generateCaptcha() {
                const captchaCodeEl = document.getElementById('captcha-code');
                if (!captchaCodeEl) return;
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                captchaCode = Array.from({ length: 6 }, () => chars.charAt(Math.floor(Math.random() * chars.length))).join('');
                captchaCodeEl.textContent = captchaCode;
                const loginCaptchaInput = document.getElementById('login-captcha-input');
                if(loginCaptchaInput) loginCaptchaInput.value = '';
            }

            function formatWhatsAppText(text) {
                if (!text) return '';
                return text
                    .replace(/</g, "&lt;").replace(/>/g, "&gt;") 
                    .replace(/\*(.*?)\*/g, '<strong>$1</strong>')    
                    .replace(/_(.*?)_/g, '<em>$1</em>')        
                    .replace(/~(.*?)~/g, '<s>$1</s>');         
            }

            function handleYoutubeEmbed(text) {
                const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu.be\/)([a-zA-Z0-9_-]{11})/;
                const match = text.match(youtubeRegex);
                if (match && match[1]) {
                    const videoId = match[1];
                    const embedHTML = `<div class="story-youtube-embed"><iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>`;
                    return { html: text.replace(youtubeRegex, embedHTML), found: true };
                }
                return { html: `<p>${formatWhatsAppText(text)}</p>`, found: false };
            }

            function resizeAndCropImage(file, width, height, callback) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = width;
                        canvas.height = height;

                        let sourceX, sourceY, sourceWidth, sourceHeight;
                        const imgRatio = img.width / img.height;
                        const targetRatio = width / height;

                        if (imgRatio > targetRatio) {
                            sourceHeight = img.height;
                            sourceWidth = sourceHeight * targetRatio;
                            sourceX = (img.width - sourceWidth) / 2;
                            sourceY = 0;
                        } else {
                            sourceWidth = img.width;
                            sourceHeight = sourceWidth / targetRatio;
                            sourceY = (img.height - sourceHeight) / 2;
                            sourceX = 0;
                        }
                        
                        ctx.drawImage(img, sourceX, sourceY, sourceWidth, sourceHeight, 0, 0, width, height);
                        callback(canvas.toDataURL('image/jpeg'));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }

            function handleAvatarUpload(file, previewId, isProfilePic = false) {
                const preview = document.getElementById(previewId);
                if (!preview) return;

                if (!file) { 
                    preview.src = '';
                    preview.classList.remove('active');
                    return;
                }

                const displayImage = (dataUrl) => {
                    preview.src = dataUrl;
                    if (!preview.classList.contains('active')) preview.classList.add('active');
                     if (previewId === 'main-logo-preview') {
                        document.getElementById('main-logo-link').style.display = 'block';
                        document.querySelector('.main-logo-uploader .upload-placeholder').style.display = 'none';
                    }
                };
                
                if (isProfilePic) {
                    resizeAndCropImage(file, 150, 150, (dataUrl) => {
                        newAvatarFile = dataUrl; 
                        displayImage(dataUrl);
                    });
                } else {
                     const reader = new FileReader();
                    reader.onload = (e) => displayImage(e.target.result);
                    reader.readAsDataURL(file);
                }
            }
            
            function handleMediaPreview(files, previewContainerId) {
                const previewContainer = document.getElementById(previewContainerId);
                if (!previewContainer) return;
                previewContainer.innerHTML = '';
                
                Array.from(files).forEach(file => {
                    const url = URL.createObjectURL(file);
                    let mediaElement;
                    if (file.type.startsWith('image/')) {
                        mediaElement = document.createElement('img');
                    } else if (file.type.startsWith('video/')) {
                        mediaElement = document.createElement('video');
                        mediaElement.controls = true;
                    }
                    if (mediaElement) {
                        mediaElement.src = url;
                        previewContainer.appendChild(mediaElement);
                    }
                });
            }
            
            function handleMarketplacePreview(filesArray, previewContainer) {
                previewContainer.innerHTML = '';
                
                filesArray.forEach((file, index) => {
                    const url = URL.createObjectURL(file);
                    const thumb = document.createElement('div');
                    thumb.className = 'media-thumbnail';

                    let mediaElement;
                    if (file.type.startsWith('image/')) {
                        mediaElement = document.createElement('img');
                    } else if (file.type.startsWith('video/')) {
                        mediaElement = document.createElement('video');
                        mediaElement.muted = true;
                    }

                    if (mediaElement) {
                        mediaElement.src = url;
                        
                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'remove-media-btn';
                        removeBtn.dataset.index = index;
                        removeBtn.type = "button";
                        removeBtn.innerHTML = '&times;';
                        
                        thumb.appendChild(mediaElement);
                        thumb.appendChild(removeBtn);
                        previewContainer.appendChild(thumb);
                    }
                });
            }

            function createMessageElement(text, isSent, isFile = false, fileUrl = '', fileType = '') {
                const messageEl = document.createElement('div');
                messageEl.className = `message ${isSent ? 'sent' : 'received'}`;
                
                let contentHTML = '';
                if (isFile) {
                    if (fileType.startsWith('image/')) {
                        contentHTML = `<p>${text}</p><img src="${fileUrl}" class="message-media" alt="Sent image">`;
                    } else if (fileType.startsWith('video/')) {
                        contentHTML = `<p>${text}</p><video src="${fileUrl}" class="message-media" controls></video>`;
                    } else {
                         contentHTML = `<p><i class="fas fa-file-alt"></i> Sent a file: <a href="${fileUrl}" target="_blank">${text}</a></p>`;
                    }
                } else {
                    contentHTML = formatWhatsAppText(text);
                }
                
                messageEl.innerHTML = contentHTML;
                return messageEl;
            }

            function createNewPostElement(text, mediaFiles, authorData = null, isBusinessPost = false, retweetData = null) {
                const author = authorData || userState;
                const postElement = document.createElement('div');
                postElement.className = 'impact-story';
                const postId = `post-${new Date().getTime()}`;
                postElement.dataset.postId = postId;
                postElement.dataset.userId = author.id;
                
                const avatar = isBusinessPost ? author.businessPage.profilePhoto : (author.avatar || author.logo);
                const name = isBusinessPost ? author.businessPage.name : (author.fullName || author.name);
                const avatarClass = 'avatar-placeholder square';
                const avatarStyle = isBusinessPost ? 'border-radius: 8px;' : '';


                const { html: formattedText, found: youtubeFound } = handleYoutubeEmbed(text);

                let mediaHTML = '';
                if (mediaFiles && mediaFiles.length > 0) {
                    mediaHTML += `<div class="story-media-container" data-count="${mediaFiles.length}">`;
                    mediaFiles.forEach(file => {
                        const url = (file instanceof File) ? URL.createObjectURL(file) : file.url;
                        if (file.type.startsWith('image/')) {
                            mediaHTML += `<img src="${url}" class="story-main-image" alt="User posted image content">`;
                        } else if (file.type.startsWith('video/')) {
                            mediaHTML += `<video src="${url}" class="story-video" controls alt="User posted video content"></video>`;
                        }
                    });
                    mediaHTML += '</div>';
                }

                 const retweetHeaderHTML = retweetData ? `<div class="retweet-header"><i class="fas fa-retweet"></i> ${retweetData.retweeterName} Retweeted</div>` : '';

                postElement.innerHTML = `
                    ${retweetHeaderHTML}
                    <div class="story-header">
                        <div class="${avatarClass}" style="${avatarStyle}"><img src="${avatar}" alt="${name}'s Avatar"></div>
                        <div class="story-user-info"><strong>${name}</strong><span>Just now</span></div>
                        <div class="post-options">
                            <button class="options-btn"><i class="fas fa-ellipsis-h"></i></button>
                            <div class="options-menu">
                                <a href="#" class="edit-post-btn"><i class="fas fa-edit"></i> Edit</a>
                                <a href="#" class="delete-post-btn"><i class="fas fa-trash"></i> Delete</a>
                                <a href="#" class="promote-post-btn"><i class="fas fa-rocket"></i> Promote</a>
                            </div>
                        </div>
                    </div>
                    <div class="story-content">${formattedText}</div>
                    ${!youtubeFound ? mediaHTML : ''}
                    <div class="story-actions">
                        <a class="action-btn like-btn"><i class="far fa-heart"></i><span class="like-count">0</span></a>
                        <a class="action-btn comment-btn"><i class="far fa-comment"></i><span class="comment-count">0</span></a>
                        <a class="action-btn share-btn"><i class="fas fa-share"></i><span>Share</span></a>
                        <a class="action-btn retweet-btn"><i class="fas fa-retweet"></i><span class="retweet-count">0</span></a>
                        ${authorData && !isBusinessPost ? '<button class="btn btn-success btn-small help-now-btn" style="margin-left: auto;"><i class="fas fa-hand-holding-heart"></i> Solicit Support</button>' : ''}
                        <span class="sponsored-badge" style="display: none; margin-left: auto;">Sponsored</span>
                    </div>
                    <div class="comment-section">
                         <div class="comment-list"></div>
                         <form class="comment-form" novalidate>
                            <input type="text" name="comment-text" placeholder="Add a comment..." required>
                            <button type="submit"><i class="fas fa-paper-plane"></i></button>
                         </form>
                    </div>
                `;
                return postElement;
            }

            function promptForPromotion(postId) {
                if (isGuest) return;
                setTimeout(() => {
                    if (confirm("Your content is live! Would you like to promote it now to reach a wider audience?")) {
                        const promotionModal = document.getElementById('promotion-modal-overlay');
                        document.getElementById('promotion-setup-view').style.display = 'block';
                        document.getElementById('promotion-payment-details').style.display = 'none';
                        document.getElementById('promotion-setup-form').reset();
                        updatePromoReachPreview();
                        
                        promotionModal.querySelector('#promote-post-id').value = postId;
                        promotionModal.classList.add('show');
                        document.body.classList.add('modal-open');
                    }
                }, 500);
            }

            // --- LIVE STREAM FUNCTIONS ---
            function populateBackgroundSelector() {
                const container = document.getElementById('live-bg-selector');
                if (!container) return;
                container.innerHTML = liveBackgrounds.map((bg, index) => {
                    const isImage = bg.startsWith('http');
                    const style = isImage ? `background-image: url(${bg})` : `background: ${bg}`;
                    return `<div class="bg-thumb ${index === 0 ? 'active' : ''}" data-bg="${bg}" style="${style}"></div>`;
                }).join('');
            }

            function populateGiftCatalog() {
                const container = document.getElementById('gift-grid-container');
                if (!container) return;
                container.innerHTML = '';
                empyGiftCatalog.forEach(gift => {
                    const giftEl = document.createElement('div');
                    giftEl.className = 'gift-item';
                    giftEl.dataset.name = gift.name;
                    giftEl.dataset.symbol = gift.symbol;
                    giftEl.dataset.price = gift.price;
                    giftEl.innerHTML = `<div class="symbol">${gift.symbol}</div><div class="name">${gift.name}</div><div class="price"><i class="fa-solid fa-coins"></i> ${gift.price}</div>`;
                    container.appendChild(giftEl);
                });
            }
            
            function showGiftAnimation(symbol) {
                const layer = document.getElementById('gift-animation-layer');
                const animationEl = document.createElement('div');
                animationEl.className = 'gift-animation';
                animationEl.textContent = symbol;
                animationEl.style.left = `${Math.random() * 80 + 10}%`;
                layer.appendChild(animationEl);
                setTimeout(() => animationEl.remove(), 3000);
            }

            function createLiveComment(username, text) {
                const list = document.getElementById('live-comments-list');
                const commentEl = document.createElement('div');
                commentEl.className = 'live-comment';
                commentEl.innerHTML = `<strong>${username}</strong><p>${formatWhatsAppText(text)}</p>`;
                list.prepend(commentEl);
            }

            function createDashboardLiveCard(streamId, title, hostName, avatarSrc, bg) {
                const slider = document.getElementById('dashboard-live-slider');
                const card = document.createElement('div');
                card.className = 'live-stream-preview-card join-live-btn';
                card.dataset.streamId = streamId;
                const isImage = bg.startsWith('http');
                card.style[isImage ? 'backgroundImage' : 'background'] = isImage ? `url(${bg})` : bg;
                card.dataset.background = bg;
                card.dataset.hostName = hostName;
                card.dataset.streamTitle = title;
                card.dataset.hostAvatar = avatarSrc;
                card.innerHTML = `<div class="live-preview-header"><span class="live-tag"><i class="fas fa-circle fa-beat" style="font-size: 0.7rem; margin-right: 4px;"></i> LIVE</span></div><div class="live-preview-footer"><strong class="host-name">${hostName}</strong><p class="stream-title">${title}</p></div>`;
                slider.prepend(card);
            }
            
            function addRecordedLiveStream(title, hostName) {
                const wrapper = document.getElementById('livestream-wrapper');
                const newCard = document.createElement('div');
                newCard.className = 'livestream-card';
                newCard.innerHTML = `
                    <div class="livestream-video-container">
                        <video poster="https://source.unsplash.com/random/400x300/?live-recording" controls>
                            <source src="https://www.w3schools.com/html/mov_bbb.mp4" type="video/mp4">
                        </video>
                    </div>
                    <div class="livestream-info">
                        <strong>${title}</strong>
                        <span>By: ${hostName}</span>
                    </div>
                `;
                wrapper.prepend(newCard);
            }


            // --- ADMIN & POSTING FUNCTIONS ---
            function renderAdminQueues() {
                const withdrawalQueueEl = document.getElementById('admin-withdrawal-queue');
                const sosQueueEl = document.getElementById('admin-sos-queue');
                if(!withdrawalQueueEl || !sosQueueEl) return;
                
                withdrawalQueueEl.innerHTML = mockAdminWithdrawalQueue.length ? mockAdminWithdrawalQueue.map(item => `
                    <div class="admin-queue-item" data-id="${item.id}">
                        <div class="admin-queue-info">
                            <p><strong>User:</strong> ${item.username}</p>
                            <p><strong>Amount:</strong> ${item.amount}</p>
                            <p><strong>Method:</strong> ${item.method}</p>
                        </div>
                        <div class="admin-queue-actions">
                            <button class="btn btn-small btn-success approve-withdrawal-btn">Approve</button>
                            <button class="btn btn-small btn-danger reject-withdrawal-btn">Reject</button>
                        </div>
                    </div>`).join('') : '<p style="text-align:center; padding: 20px;">No pending withdrawals.</p>';

                sosQueueEl.innerHTML = mockAdminSosQueue.length ? mockAdminSosQueue.map(item => `
                     <div class="admin-queue-item" data-id="${item.id}">
                        <div class="admin-queue-info">
                            <p><strong>User:</strong> ${item.username}</p>
                            <p><strong>Title:</strong> ${item.title}</p>
                        </div>
                        <div class="admin-queue-actions">
                            <button class="btn btn-small btn-success approve-sos-btn">Verify & Publish</button>
                            <button class="btn btn-small btn-danger reject-sos-btn">Reject</button>
                        </div>
                    </div>`).join('') : '<p style="text-align:center; padding: 20px;">No pending SOS requests.</p>';
            }

            function createSosPostOnFeed(sosData) {
                const postElement = document.createElement('div');
                postElement.className = 'impact-story sos-request';
                postElement.dataset.postId = sosData.id;
                postElement.dataset.userId = sosData.userId;
                postElement.dataset.amount = sosData.amount;
                postElement.dataset.currency = sosData.currency;
                postElement.dataset.username = sosData.username;
                
                const pText = document.createElement('p');
                pText.innerHTML = formatWhatsAppText(sosData.story);

                let mediaHTML = '';
                if (sosData.media && sosData.media.length > 0) {
                    mediaHTML += `<div class="story-media-container" data-count="${sosData.media.length}">`;
                    sosData.media.forEach(mediaItem => {
                        if (mediaItem.type.startsWith('image/')) {
                            mediaHTML += `<img src="${mediaItem.url}" class="story-main-image" alt="SOS Evidence">`;
                        } else if (mediaItem.type.startsWith('video/')) {
                            // --- FIX 4: Added 'controls' to SOS video ---
                            mediaHTML += `<video src="${mediaItem.url}" class="story-video" controls alt="SOS Evidence"></video>`;
                        }
                    });
                    mediaHTML += '</div>';
                }
                
                const currencyFormatter = new Intl.NumberFormat('en-US', { 
                    style: 'currency', 
                    currency: sosData.currency, 
                    minimumFractionDigits: (sosData.currency === 'EMPY' || sosData.currency === 'USDT') ? 2 : 0 
                });

                postElement.innerHTML = `
                    <div class="story-header">
                        <div class="avatar-placeholder square"><img src="${sosData.avatar}" alt="${sosData.username}'s Avatar"></div>
                        <div class="story-user-info"><strong>SOS: ${sosData.title}</strong><span>Request by ${sosData.username}</span></div>
                        <span class="sos-badge">SOS</span>
                    </div>
                    <div class="story-content">
                        ${pText.outerHTML}
                        <p>I urgently need <b class="amount-needed">${currencyFormatter.format(parseFloat(sosData.amount))}</b> to cover my needs.</p>
                    </div>
                    ${mediaHTML}
                    <div class="story-actions">
                        <a class="action-btn like-btn"><i class="far fa-heart"></i><span class="like-count">0</span></a>
                        <a class="action-btn comment-btn"><i class="far fa-comment"></i><span class="comment-count">0</span></a>
                        <a class="action-btn share-btn"><i class="fas fa-share"></i><span>Share</span></a>
                        <a class="action-btn retweet-btn"><i class="fas fa-retweet"></i><span class="retweet-count">0</span></a>
                        <button class="gift-button sos-button help-now-btn"><i class="fas fa-hand-holding-dollar"></i> Help Now</button>
                    </div>
                    <div class="comment-section"><div class="comment-list"></div><form class="comment-form" novalidate><input type="text" name="comment-text" placeholder="Add a comment..." required><button type="submit"><i class="fas fa-paper-plane"></i></button></form></div>
                `;
                feedContainer.prepend(postElement);
            }

            function createCrisisPostOnFeed(crisisData) {
                const postElement = document.createElement('div');
                postElement.className = 'impact-story crisis-report';
                const postId = `crisis-${Date.now()}`;
                postElement.dataset.postId = postId;
                postElement.dataset.userId = crisisData.userId;

                let mediaHTML = '';
                if (crisisData.media && crisisData.media.length > 0) {
                    mediaHTML += `<div class="story-media-container" data-count="${crisisData.media.length}">`;
                    crisisData.media.forEach(mediaItem => {
                         if (mediaItem.type.startsWith('image/')) {
                            mediaHTML += `<img src="${mediaItem.url}" class="story-main-image" alt="Crisis Report Evidence">`;
                        } else if (mediaItem.type.startsWith('video/')) {
                            mediaHTML += `<video src="${mediaItem.url}" class="story-video" controls alt="Crisis Report Evidence"></video>`;
                        }
                    });
                    mediaHTML += '</div>';
                }
                
                postElement.innerHTML = `
                    <div class="story-header">
                        <div class="avatar-placeholder square"><img src="${crisisData.avatar}" alt="${crisisData.username}'s Avatar"></div>
                        <div class="story-user-info"><strong>Crisis Report: ${crisisData.type}</strong><span>Reported by ${crisisData.username}</span></div>
                        <div class="post-options">
                            <button class="options-btn"><i class="fas fa-ellipsis-h"></i></button><div class="options-menu"><a href="#" class="promote-post-btn"><i class="fas fa-rocket"></i> Promote</a></div></div>
                    </div>
                    <div class="story-content">
                        <p>${formatWhatsAppText(crisisData.description)}</p>
                        <p style="font-size:0.9rem; color:#666; margin-top:10px;"><i class="fas fa-map-marker-alt"></i> <strong>Location:</strong> ${crisisData.location}</p>
                    </div>
                    ${mediaHTML}
                    <div class="story-actions">
                        <a class="action-btn like-btn"><i class="far fa-heart"></i><span class="like-count">0</span></a>
                        <a class="action-btn comment-btn"><i class="far fa-comment"></i><span class="comment-count">0</span></a>
                        <a class="action-btn share-btn"><i class="fas fa-share"></i><span>Share</span></a>
                        <a class="action-btn retweet-btn"><i class="fas fa-retweet"></i><span class="retweet-count">0</span></a>
                        <span class="sponsored-badge" style="display: none; margin-left: auto;">Sponsored</span>
                    </div>
                    <div class="comment-section"><div class="comment-list"></div><form class="comment-form" novalidate><input type="text" name="comment-text" placeholder="Add a comment..." required><button type="submit"><i class="fas fa-paper-plane"></i></button></form></div>
                `;
                feedContainer.prepend(postElement);
                promptForPromotion(postId);
            }

            // --- MESSAGING FUNCTIONS ---
            function renderContactList() {
                const container = document.getElementById('contact-list-container');
                if (!container) return;
                container.innerHTML = '';
                const allUsersToDisplay = new Set(userState.followedUserIds);
                Object.values(mockUsers).forEach(u => allUsersToDisplay.add(u.id));

                allUsersToDisplay.forEach(userId => {
                    const user = mockUsers[userId];
                    if (user && user.id !== userState.id) {
                        const contactEl = document.createElement('div');
                        contactEl.className = 'contact-item';
                        contactEl.dataset.userId = userId;
                        contactEl.innerHTML = `<div class="avatar-placeholder"><img src="${user.avatar}" alt="${user.fullName}"></div><div class="contact-info"><strong>${user.fullName}</strong><p>@${user.username}</p></div>`;
                        container.appendChild(contactEl);
                    }
                });
            }
            
            function openChat(userId) {
                const user = mockUsers[userId];
                if (!user) return;
                document.querySelectorAll('.contact-item.active').forEach(c => c.classList.remove('active'));
                document.querySelector(`.contact-item[data-user-id="${userId}"]`).classList.add('active');

                document.getElementById('chat-view-container').style.display = 'flex';
                document.getElementById('chat-placeholder').style.display = 'none';
                
                const chatHeader = document.getElementById('chat-header-info');
                chatHeader.innerHTML = `<div class="avatar-placeholder"><img src="${user.avatar}" alt="${user.fullName}"></div><div><strong>${user.fullName}</strong><p>@${user.username}</p></div>`;
                chatHeader.dataset.userId = userId;

                const messagesContainer = document.getElementById('chat-messages-container');
                messagesContainer.innerHTML = `<div class="message received">Hey! How are you doing?</div><div class="message sent">I'm doing *great*, thanks for asking! How about _you_?</div>`;
                messagesContainer.dataset.activeChat = userId;
            }

            // --- STATUS FUNCTIONS ---
            let currentStatusUser, currentStatusIndex;

            function renderStatusSlider() {
                const container = document.getElementById('status-slider');
                if(!container) return;
                
                // Add "Create" button for logged-in users
                container.innerHTML = isGuest ? '' : `
                    <div class="status-item" id="add-status-placeholder">
                        <div class="status-avatar" style="border: 2px dashed var(--primary-color);">
                             <i class="fas fa-plus" style="font-size: 1.5rem; color: var(--primary-color);"></i>
                        </div>
                        <span>Add Status</span>
                    </div>
                `;

                let usersWithStatus = Object.values(mockUsers).filter(u => u.statuses && u.statuses.length > 0);
                
                usersWithStatus.sort((a,b) => {
                    const aViewed = userState.viewedStatusUserIds.has(a.id);
                    const bViewed = userState.viewedStatusUserIds.has(b.id);
                    if (aViewed === bViewed) return 0;
                    return aViewed ? 1 : -1; 
                });

                usersWithStatus.forEach(user => {
                    const isViewed = userState.viewedStatusUserIds.has(user.id);
                    const hasMultiple = user.statuses.length > 1;
                    const itemEl = document.createElement('div');
                    itemEl.className = `status-item ${isViewed ? 'viewed' : 'new'}`;
                    itemEl.dataset.userId = user.id;
                    itemEl.innerHTML = `
                        <div class="status-avatar">
                            <img src="${user.avatar}" alt="${user.fullName}">
                            ${hasMultiple ? '<div class="multi-status-indicator"><i class="fas fa-layer-group"></i></div>' : ''}
                        </div>
                        <span>${user.fullName.split(' ')[0]}</span>`;
                    container.appendChild(itemEl);
                });
            }
            
            function playStatus(userId) {
                const user = mockUsers[userId];
                if (!user || !user.statuses || user.statuses.length === 0) return;
                currentStatusUser = user;
                currentStatusIndex = 0;
                document.getElementById('status-modal-overlay').classList.add('show');
                document.body.classList.add('modal-open');
                document.getElementById('status-user-info').querySelector('img').src = user.avatar;
                document.getElementById('status-user-info').querySelector('strong').textContent = user.fullName;
                renderStatusView();
                userState.viewedStatusUserIds.add(userId);
                renderStatusSlider();
            }

            function setNextStatusTimer(duration) {
                clearTimeout(statusTimer);
                statusTimer = setTimeout(nextStatus, duration);
            }

            function renderStatusView() {
                clearTimeout(statusTimer);
                const status = currentStatusUser.statuses[currentStatusIndex];
                const progressContainer = document.getElementById('status-progress-bar-container');
                progressContainer.innerHTML = currentStatusUser.statuses.map((s, idx) => `<div class="progress-bar"><div class="progress ${idx < currentStatusIndex ? 'full' : ''}"></div></div>`).join('');

                const mediaContainer = document.getElementById('status-media-container');
                const textContainer = document.getElementById('status-text-container');
                const captionEl = document.querySelector('.status-caption');
                const soundToggle = document.getElementById('status-sound-toggle');

                mediaContainer.innerHTML = '';
                textContainer.innerHTML = '';
                soundToggle.style.display = 'none';
                captionEl.textContent = '';
                mediaContainer.style.background = 'none';
                textContainer.style.background = 'none';

                let duration = status.duration; 

                if (status.type === 'text') {
                    textContainer.textContent = status.content;
                    textContainer.style.background = status.color;
                    textContainer.style.display = 'flex';
                    mediaContainer.style.display = 'none';
                } else {
                    mediaContainer.style.display = 'flex';
                    textContainer.style.display = 'none';
                    captionEl.textContent = status.caption || '';
                    
                    if (status.type === 'image') {
                        const img = document.createElement('img');
                        img.src = status.url;
                        mediaContainer.appendChild(img);
                    } else if (status.type === 'video') {
                        const video = document.createElement('video');
                        video.src = status.url;
                        video.autoplay = true;
                        video.playsInline = true;
                        video.muted = true;
                        
                        soundToggle.style.display = 'flex';
                        soundToggle.innerHTML = '<i class="fas fa-volume-mute"></i>';
                        
                        video.addEventListener('loadedmetadata', () => {
                            duration = video.duration * 1000;
                            const currentProgressBar = progressContainer.children[currentStatusIndex]?.querySelector('.progress');
                            if (currentProgressBar) {
                                requestAnimationFrame(() => {
                                    currentProgressBar.style.transition = `width ${duration / 1000}s linear`;
                                    currentProgressBar.style.width = '100%';
                                });
                                setNextStatusTimer(duration);
                            }
                        });
                        video.addEventListener('ended', nextStatus);
                        mediaContainer.appendChild(video);
                    }
                }

                if (status.type !== 'video') {
                    const currentProgressBar = progressContainer.children[currentStatusIndex]?.querySelector('.progress');
                    if(currentProgressBar) {
                        requestAnimationFrame(() => {
                            currentProgressBar.style.transition = `width ${duration/1000}s linear`;
                            currentProgressBar.style.width = '100%';
                        });
                        setNextStatusTimer(duration);
                    }
                }
            }


            function nextStatus() {
                clearTimeout(statusTimer);
                if (currentStatusIndex < currentStatusUser.statuses.length - 1) {
                    currentStatusIndex++;
                    renderStatusView();
                } else {
                    closeStatusModal();
                }
            }
            
            function prevStatus() {
                 clearTimeout(statusTimer);
                 if (currentStatusIndex > 0) {
                    currentStatusIndex--;
                    renderStatusView();
                }
            }

            function closeStatusModal() {
                clearTimeout(statusTimer);
                document.getElementById('status-modal-overlay').classList.remove('show');
                document.body.classList.remove('modal-open');
                const video = document.querySelector('#status-media-container video');
                if (video) video.pause();
            }
            
            function populateColorPalette() {
                const palette = document.getElementById('color-palette');
                if(!palette) return;
                palette.innerHTML = textStatusColors.map(color => `<div class="color-swatch" style="background: ${color};" data-color='${color}'></div>`).join('');
                
                const textInput = document.getElementById('status-text-input');
                if (textInput && textStatusColors.length > 0) {
                    textInput.style.background = textStatusColors[0];
                    if (palette.children.length > 0) {
                        palette.children[0].classList.add('active');
                    }
                }
            }

            function populateDobSelectors() {
                const daySelect = document.querySelector('#individual-kyc-form .date-select-group select:nth-child(1)');
                const monthSelect = document.querySelector('#individual-kyc-form .date-select-group select:nth-child(2)');
                const yearSelect = document.querySelector('#individual-kyc-form .date-select-group select:nth-child(3)');
                
                if(!daySelect || !monthSelect || !yearSelect) return;

                for(let i = 1; i <= 31; i++) { daySelect.innerHTML += `<option value="${i}">${i}</option>`; }
                const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                months.forEach((month, i) => { monthSelect.innerHTML += `<option value="${i+1}">${month}</option>`; });
                const currentYear = new Date().getFullYear();
                for(let i = currentYear - 18; i >= currentYear - 100; i--) { yearSelect.innerHTML += `<option value="${i}">${i}</option>`; }
            }
            
            function renderUserProfile(userId) {
                const user = mockUsers[userId];
                if (!user) {
                    console.error("User not found:", userId);
                    return;
                }
                
                const profileSection = document.getElementById('profile');
                const isMyProfile = !isGuest && user.id === userState.id;
                
                // --- FIX 2: Added full KYC Form HTML here ---
                const kycFormHTML = `
                <div class="card"><div class="card-content">
                    <h3><i class="fas fa-shield-alt"></i> Account Verification (KYC)</h3>
                    <p>Complete verification to access all platform features, including withdrawals.</p>
                    <hr style="border: 1px solid #eee; margin: 20px 0;">
                    
                    <div id="kyc-entity-selector-container">
                        <h4>Step 1: Select Entity Type</h4>
                        <div id="kyc-entity-selector" style="margin-top: 20px;">
                            <div class="kyc-entity-btn" data-form="individual-kyc-form"><i class="fas fa-user"></i><span>Individual</span></div>
                            <div class="kyc-entity-btn" data-form="ngo-kyc-form"><i class="fas fa-sitemap"></i><span>NGO</span></div>
                            <div class="kyc-entity-btn" data-form="company-kyc-form"><i class="fas fa-building"></i><span>Company</span></div>
                            <div class="kyc-entity-btn" data-form="cooperative-kyc-form"><i class="fas fa-users"></i><span>Cooperative</span></div>
                        </div>
                    </div>

                    <div id="kyc-forms-container" style="margin-top: 30px;">
                        <form id="individual-kyc-form" class="kyc-form" novalidate>
                            <h4>Step 2: Individual Verification</h4>
                            <div class="grid-2"><div class="form-group"><label for="kyc-ind-fname">First Name</label><input type="text" id="kyc-ind-fname" required></div><div class="form-group"><label for="kyc-ind-lname">Last Name</label><input type="text" id="kyc-ind-lname" required></div></div>
                            <div class="form-group"><label for="kyc-ind-dob">Date of Birth</label><div class="date-select-group"><select required><option>Day</option></select><select required><option>Month</option></select><select required><option>Year</option></select></div></div>
                            <div class="form-group"><label for="kyc-ind-gender">Gender</label><select id="kyc-ind-gender" required><option value="">--Select--</option><option>Male</option><option>Female</option></select></div>
                            <div class="form-group"><label for="kyc-ind-phone">Phone</label><input type="tel" id="kyc-ind-phone" required></div>
                            <div class="form-group"><label for="kyc-ind-email">Email</label><input type="email" id="kyc-ind-email" required></div>
                            <div class="form-group"><label for="kyc-ind-address">Residential Address</label><input type="text" id="kyc-ind-address" required></div>
                            <div class="form-group"><label for="kyc-ind-id-type">ID Type</label><select id="kyc-ind-id-type" required><option value="">--Select--</option><option>Passport</option><option>National ID</option><option>Driver's License</option><option>Voter's Card</option></select></div>
                            <div class="form-group"><label for="kyc-ind-id-number">ID Number</label><input type="text" id="kyc-ind-id-number" required></div>
                            <div class="form-group"><label>Upload ID (Front & Back)</label><div class="upload-area"><i class="fas fa-id-card"></i><span>Click to upload</span></div></div>
                            <div class="form-group"><label>Selfie Verification</label><button type="button" class="btn btn-small live-capture-btn"><i class="fas fa-camera"></i> Capture Live Selfie</button></div>
                            <button type="submit" class="btn btn-accent">Submit Verification</button>
                        </form>
                        <form id="company-kyc-form" class="kyc-form" novalidate>
                            <h4>Step 2: Company Verification</h4>
                            <div class="form-group"><label for="kyc-com-name">Organisation Name</label><input type="text" id="kyc-com-name" required></div>
                            <div class="form-group"><label for="kyc-com-cac">CAC Registration Number</label><input type="text" id="kyc-com-cac" required></div>
                            <div class="form-group"><label for="kyc-com-scuml">SCUML Certificate Number</label><input type="text" id="kyc-com-scuml" required></div>
                            <div class="form-group"><label for="kyc-com-rep-name">CEO/Representative Name</label><input type="text" id="kyc-com-rep-name" required></div>
                            <div class="form-group"><label for="kyc-com-phone">Official Phone</label><input type="tel" id="kyc-com-phone" required></div>
                            <div class="form-group"><label for="kyc-com-email">Official Email</label><input type="email" id="kyc-com-email" required></div>
                            <div class="form-group"><label for="kyc-com-address">Office Address</label><input type="text" id="kyc-com-address" required></div>
                            <div class="form-group"><label>Upload CAC Certificate</label><div class="upload-area"><i class="fas fa-file-alt"></i><span>Click to upload</span></div></div>
                            <div class="form-group"><label>Upload SCUML Certificate</label><div class="upload-area"><i class="fas fa-file-alt"></i><span>Click to upload</span></div></div>
                            <div class="form-group"><label>Representative's ID</label><div class="upload-area"><i class="fas fa-id-card"></i><span>Click to upload</span></div></div>
                            <div class="form-group"><label>Representative's Selfie</label><button type="button" class="btn btn-small live-capture-btn"><i class="fas fa-camera"></i> Capture Live Selfie</button></div>
                            <button type="submit" class="btn btn-accent">Submit Verification</button>
                        </form>
                        <form id="ngo-kyc-form" class="kyc-form" novalidate>
                             <h4>Step 2: NGO Verification</h4>
                            <div class="form-group"><label for="kyc-ngo-name">Organisation Name</label><input type="text" id="kyc-ngo-name" required></div>
                            <div class="form-group"><label for="kyc-ngo-cac">CAC Registration Number</label><input type="text" id="kyc-ngo-cac" required></div>
                            <div class="form-group"><label for="kyc-ngo-scuml">SCUML Certificate Number</label><input type="text" id="kyc-ngo-scuml" required></div>
                            <div class="form-group"><label for="kyc-ngo-rep-name">President/Representative Name</label><input type="text" id="kyc-ngo-rep-name" required></div>
                            <div class="form-group"><label for="kyc-ngo-phone">Official Phone</label><input type="tel" id="kyc-ngo-phone" required></div>
                            <div class="form-group"><label for="kyc-ngo-email">Official Email</label><input type="email" id="kyc-ngo-email" required></div>
                            <div class="form-group"><label for="kyc-ngo-address">Office Address</label><input type="text" id="kyc-ngo-address" required></div>
                            <div class="form-group"><label>Upload CAC Certificate</label><div class="upload-area"><i class="fas fa-file-alt"></i><span>Click to upload</span></div></div>
                            <div class="form-group"><label>Upload SCUML Certificate</label><div class="upload-area"><i class="fas fa-file-alt"></i><span>Click to upload</span></div></div>
                            <div class="form-group"><label>Representative's ID</label><div class="upload-area"><i class="fas fa-id-card"></i><span>Click to upload</span></div></div>
                            <div class="form-group"><label>Representative's Selfie</label><button type="button" class="btn btn-small live-capture-btn"><i class="fas fa-camera"></i> Capture Live Selfie</button></div>
                            <button type="submit" class="btn btn-accent">Submit Verification</button>
                        </form>
                        <form id="cooperative-kyc-form" class="kyc-form" novalidate>
                            <h4>Step 2: Cooperative Society Verification</h4>
                            <div class="form-group"><label for="kyc-coop-name">Organisation Name</label><input type="text" id="kyc-coop-name" required></div>
                            <div class="form-group"><label for="kyc-coop-cert">Certificate Number</label><input type="text" id="kyc-coop-cert" required></div>
                            <div class="form-group"><label for="kyc-coop-tin">TIN Number</label><input type="text" id="kyc-coop-tin" required></div>
                            <div class="form-group"><label for="kyc-coop-rep-name">President/Representative Name</label><input type="text" id="kyc-coop-rep-name" required></div>
                            <div class="form-group"><label for="kyc-coop-phone">Official Phone</label><input type="tel" id="kyc-coop-phone" required></div>
                            <div class="form-group"><label for="kyc-coop-email">Official Email</label><input type="email" id="kyc-coop-email" required></div>
                            <div class="form-group"><label for="kyc-coop-address">Office Address</label><input type="text" id="kyc-coop-address" required></div>
                            <div class="form-group"><label>Upload Registration Certificate</label><div class="upload-area"><i class="fas fa-file-alt"></i><span>Click to upload</span></div></div>
                            <div class="form-group"><label>Upload TIN Document</label><div class="upload-area"><i class="fas fa-file-alt"></i><span>Click to upload</span></div></div>
                            <div class="form-group"><label>Representative's ID</label><div class="upload-area"><i class="fas fa-id-card"></i><span>Click to upload</span></div></div>
                            <div class="form-group"><label>Representative's Selfie</label><button type="button" class="btn btn-small live-capture-btn"><i class="fas fa-camera"></i> Capture Live Selfie</button></div>
                            <button type="submit" class="btn btn-accent">Submit Verification</button>
                        </form>
                    </div>
                </div></div>`;

                profileSection.innerHTML = `
                    <div class="header"><h1>${isMyProfile ? "My Profile" : user.fullName}</h1></div>
                    <div class="card">
                        <div class="profile-header-container">
                            <div class="cover-photo-container" id="profile-cover-container" style="background-image: url('${user.coverPhoto}');">
                                ${isMyProfile ? `<label for="cover-photo-input" class="upload-overlay"><i class="fas fa-camera"></i> Change Cover</label><input type="file" id="cover-photo-input" accept="image/*" style="display:none;">` : ''}
                            </div>
                            <div class="profile-header">
                                <div class="profile-pic-container">
                                    <label for="profile-pic-input-main" class="avatar-placeholder" style="width: 150px; height: 150px; border-radius: 50%; ${!isMyProfile ? 'cursor:default;' : ''}">
                                        ${isMyProfile ? '<div class="upload-overlay"><i class="fas fa-camera fa-2x"></i></div>' : ''}
                                        <img src="${user.avatar}" id="profile-pic-img" class="profile-pic active" alt="User profile picture">
                                    </label>
                                    ${isMyProfile ? `<input type="file" id="profile-pic-input-main" class="avatar-input" accept="image/*" style="display: none;">` : ''}
                                </div>
                                <div class="profile-header-info">
                                    <h2 id="profile-display-name">${user.fullName} <span class="badge" style="display: ${user.isVerified ? 'inline-flex' : 'none'};"><i class="fas fa-check"></i> Verified</span></h2>
                                    <p id="profile-display-username">@${user.username}</p>
                                    <div class="profile-header-actions">
                                        ${isMyProfile ? `<button class="btn btn-small nav-link" data-target="settings"><i class="fas fa-edit"></i> Edit Profile</button>` : `<button class="btn btn-small" id="profile-message-btn"><i class="fas fa-envelope"></i> Message</button>`}
                                        <button class="btn btn-small share-profile-btn"><i class="fas fa-share"></i> Share</button>
                                        ${!isMyProfile ? `<button class="btn btn-small follow-btn" data-user-id="${user.id}">Follow</button>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="profile-tabs">
                            <div class="profile-tab active" data-target="profile-main-content">Posts</div>
                            ${isMyProfile ? `<div class="profile-tab" data-target="profile-monetization">Monetization</div>` : ''}
                        </div>
                        <div class="card-content">
                            <div id="profile-main-content" class="profile-tab-content active">
                                <h3><i class="fas fa-images"></i> Gallery (Photos & Videos)</h3>
                                <div id="profile-gallery"><p>This user's uploaded photos and videos will appear here.</p></div>
                            </div>
                            ${isMyProfile ? `<div id="profile-monetization" class="profile-tab-content"></div>` : ''}
                        </div>
                    </div>
                     ${isMyProfile ? kycFormHTML : ''}
                `;
                
                // After rendering, populate dynamic parts
                if (isMyProfile) {
                    renderMonetizationTab();
                    populateDobSelectors();
                }
                populateProfileGallery(user.id);
                renderDynamicUI(); // Re-apply dynamic classes like 'followed'
            }


             // Staking UI Update Function
            function updateStakingUI() {
                if (isGuest || !document.getElementById('staking-apy')) return;

                document.getElementById('staking-apy').textContent = `~${(STAKING_APY_ESTIMATE * 100).toFixed(1)}%`;
                document.getElementById('user-staked-balance').textContent = userStakedBalance.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                document.getElementById('user-earned-rewards').textContent = userEarnedRewards.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                document.getElementById('stake-available-balance').textContent = userState.empyBalance.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                document.getElementById('claim-reward-btn').disabled = userEarnedRewards <= 0;
            }

            // Function to simulate rewards accruing over time
            function simulateRewardAccrual() {
                if (!isGuest && userStakedBalance > 0) {
                    const rewardsPerSecond = userStakedBalance * (STAKING_APY_ESTIMATE / 31536000); // APY / seconds in a year
                    userEarnedRewards += rewardsPerSecond;
                    if(document.getElementById('my-wallet').classList.contains('active')) {
                        updateStakingUI();
                    }
                }
            }

            
            function renderGrantLedger() {
                const container = document.getElementById('grant-ledger-body');
                if (!container) return;
                container.innerHTML = mockGrantLedger.map(grant => `
                    <tr>
                        <td>${grant.id}</td>
                        <td>${grant.ngo}</td>
                        <td>${grant.project}</td>
                        <td><i class="fa-solid fa-coins"></i> ${grant.amount.toLocaleString()}</td>
                        <td><a href="#" class="tx-hash" title="View on PolygonScan (simulation)">${grant.txHash}..</a></td>
                        <td class="status-completed">${grant.status}</td>
                        <td>${grant.date}</td>
                    </tr>
                `).join('');
            }
            
            function renderCommunityTasks() {
                const container = document.getElementById('community-tasks-list');
                if (!container) return;
                container.innerHTML = mockCommunityTasks.map(task => `
                    <li class="task-item">
                        <div>
                            <i class="${task.icon}"></i>
                            <span>${task.text}</span>
                        </div>
                        <button class="btn btn-small btn-accent community-task-btn" data-url="${task.url}" data-reward="${task.reward}">
                            Go <i class="fas fa-external-link-alt"></i>
                        </button>
                    </li>
                `).join('');
            }

            function renderNgoGrid() {
                 const container = document.getElementById('ngo-grid-container');
                if (!container) return;
                container.innerHTML = Object.values(mockNgoPartners).map(ngo => `
                    <div class="ngo-card" data-ngo-id="${ngo.id}">
                        <div class="avatar-placeholder"><img src="${ngo.logo}" alt="${ngo.name} logo"></div>
                        <h4>${ngo.name}</h4>
                        <p>${ngo.description.substring(0, 80)}...</p>
                    </div>
                `).join('');
            }

            function renderNgoProfile(ngoId) {
                const ngo = mockNgoPartners[ngoId];
                if(!ngo) return;

                document.getElementById('ngo-grid-view').style.display = 'none';
                document.getElementById('back-to-ngo-grid').style.display = 'inline-flex';
                const profileView = document.getElementById('ngo-profile-view');
                profileView.style.display = 'block';

                profileView.innerHTML = `
                    <div class="card">
                        <div class="ngo-profile-header">
                            <div class="avatar-placeholder"><img src="${ngo.logo}" alt="${ngo.name} logo"></div>
                            <div>
                                <h2>${ngo.name}</h2>
                                <p>${ngo.description}</p>
                            </div>
                        </div>
                        <div class="card-content">
                            <h3>Impact At a Glance</h3>
                            <div class="ngo-impact-stats">
                                <div><h4>Total Raised</h4><span class="stat-value">${formatUsdPrice(ngo.stats.raised)}</span></div>
                                <div><h4>Projects Funded</h4><span class="stat-value">${ngo.stats.projects}</span></div>
                                <div><h4>People Helped</h4><span class="stat-value">${ngo.stats.peopleHelped.toLocaleString()}</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <h3><i class="fas fa-stream"></i> Project Reports & Updates</h3>
                        <div id="ngo-feed-container"></div>
                    </div>
                `;
                
                const ngoFeedContainer = document.getElementById('ngo-feed-container');
                ngo.posts.forEach(postData => {
                    const author = { id: ngo.id, name: ngo.name, logo: ngo.logo };
                    const postElement = createNewPostElement(postData.content, postData.media, author);
                    ngoFeedContainer.appendChild(postElement);
                });
            }

            // --- CORE APP FUNCTIONS ---
            function initializeApp(guestMode, isAdminUser = false, customUserData = null) {
                isGuest = guestMode;
                isAdmin = isAdminUser;
                cart = [];
                newAvatarFile = null;
                newCoverFile = null;
                statusMediaFile = null;
                newPageProfileFile = null;
                newPageCoverFile = null;
                newsMediaFile = null;
                
                const guestState = { id: null, fullName: 'Guest', username: 'guest', avatar: 'https://source.unsplash.com/random/150x150/?avatar', coverPhoto: 'https://source.unsplash.com/random/1200x400/?pattern', likedPostIds: new Set(), followedUserIds: new Set(), retweetedPostIds: new Set(), statuses: [], viewedStatusUserIds: new Set(), empyBalance: 0, isVerified: false, followerCount: 0, businessPage: null, awardedRanks: new Set() };
                const defaultUserState = { 
                        id: 'user-main',
                        fullName: 'Adewale Adebayo', 
                        username: 'ade_adebayo',
                        email: 'adewale@example.com',
                        password: 'password123',
                        avatar: 'https://images.unsplash.com/photo-1610482101487-790751923d38?q=80&w=200&auto=format&fit=crop',
                        coverPhoto: 'https://source.unsplash.com/random/1200x400/?nature,landscape',
                        bio: "Creator. Social activist. Tech enthusiast. Passionate about leveraging technology for social good across Africa. Let's connect and build a better future together!",
                        likedPostIds: new Set(['post-1']), 
                        followedUserIds: new Set(['user-3', 'user-2']),
                        retweetedPostIds: new Set(),
                        statuses: [ { type: 'text', content: 'Having a great day building community!', color: textStatusColors[0], duration: 5000 } ],
                        viewedStatusUserIds: new Set(),
                        empyBalance: 85550.75,
                        isVerified: true,
                        followerCount: 1204,
                        businessPage: {
                            id: 'business-page-1',
                            name: 'Adebayo Farms',
                            tagline: 'Sustainable Agriculture for Africa',
                            industry: 'Agriculture',
                            email: 'contact@adebayofarms.com',
                            phone: '+2348011223344',
                            address: '10, Farm Road, Ibadan',
                            profilePhoto: 'https://source.unsplash.com/random/150x150/?farm-logo',
                            coverPhoto: 'https://source.unsplash.com/random/1200x400/?farm-field',
                            followerCount: 5802
                        },
                        awardedRanks: new Set(['rank-1', 'rank-2']) // User has already achieved first two ranks
                    };
                const adminState = { ...defaultUserState, id: 'admin-user', fullName: 'Admin User', username: 'admin', email: 'admin@empyrean.com', password: 'adminpass' };
                
                if (isGuest) {
                    userState = guestState;
                } else if (customUserData) {
                    // --- FIX 1: Correctly merge new user data ---
                    // This ensures statuses and other arrays/sets are not lost
                    userState = { ...guestState, ...customUserData };
                    // Crucially, also update the main mockUsers database with this user's full data
                    mockUsers[customUserData.id] = userState;
                } else {
                    userState = isAdminUser ? adminState : defaultUserState;
                }
                
                if (userState.id && !mockUsers[userState.id]) {
                    mockUsers[userState.id] = userState;
                }

                buildSidebar();
                buildHeader();
                updateWalletUI();
                updateCartUI();
                renderDynamicUI();
                renderMarketplaceCards();
                populateBackgroundSelector();
                populateGiftCatalog();
                renderGrantLedger();
                renderNgoGrid();
                renderDashboardNews();
                if(!isGuest) {
                    renderUserProfile(userState.id); 
                    renderStatusSlider();
                    renderCommunityTasks();
                    renderSuggestedUsers();
                    renderBusinessPage();
                    updateStakingUI();
                }
                if(isAdmin) renderAdminQueues();
                if(!isGuest) renderContactList();
                navigateTo('dashboard');
                if(guestMode) generateCaptcha();
                // Initialize whitepaper-specific scripts
                initializeWhitepaperScripts();
            }
            
            function buildSidebar() {
                const navItems = [
                    { id: 'dashboard', icon: 'fa-tachometer-alt', text: 'Dashboard' },
                    { id: 'reels', icon: 'fa-film', text: 'Reels' },
                    { id: 'marketplace', icon: 'fa-store', text: 'Marketplace' },
                    { id: 'news', icon: 'fa-newspaper', text: 'News' },
                    { id: 'ngo-partners', icon: 'fa-hands-helping', text: 'NGO Partners'},
                    { id: 'grant-portal', icon: 'fa-file-invoice-dollar', text: 'Grant Portal'},
                    { id: 'whitepaper', icon: 'fa-file-alt', text: 'Whitepaper'},
                ];
                if (!isGuest) {
                    navItems.splice(1, 0, { id: 'my-wallet', icon: 'fa-wallet', text: 'My Wallet' });
                     navItems.splice(2, 0, { id: 'messages', icon: 'fa-envelope', text: 'Messages' });
                    navItems.push(
                        { id: 'go-live', icon: 'fa-video', text: 'Go Live' },
                        { id: 'business-page', icon: 'fa-briefcase', text: 'My Page' },
                        { id: 'community-tasks', icon: 'fa-tasks', text: 'Community Tasks' },
                        { id: 'request-help', icon: 'fa-hand-holding-heart', text: 'Request SOS' },
                        { id: 'report-crisis', icon: 'fa-bullhorn', text: 'Report Crisis' },
                        { id: 'profile', icon: 'fa-user-circle', text: 'Profile' },
                        { id: 'settings', icon: 'fa-cog', text: 'Settings' }
                    );
                }
                if (isAdmin) {
                    navItems.push({ id: 'admin', icon: 'fa-user-shield', text: 'Admin Panel' });
                }
                const footerHTML = `
                    <div class="sidebar-footer">
                        <div class="social-links">
                            <a href="https://www.youtube.com/@EmpyreanHFNewsTV" target="_blank" title="YouTube"><i class="fab fa-youtube"></i></a>
                            <a href="https://x.com/EmpyToken?t=1dXjQMtmz4y2ZSm_v7S52w&s=09" target="_blank" title="X (Twitter)"><i class="fab fa-twitter"></i></a>
                            <a href="https://www.instagram.com/empyreantoken_empy?igsh=MXBpcWl3Y3Jkc3ljag==" target="_blank" title="Instagram"><i class="fab fa-instagram"></i></a>
                            <a href="https://www.linkedin.com/company/108660039/admin/" target="_blank" title="LinkedIn"><i class="fab fa-linkedin"></i></a>
                            <a href="https://t.me/EmpyreanToken" target="_blank" title="Telegram"><i class="fab fa-telegram-plane"></i></a>
                            <a href="https://whatsapp.com/channel/0029VbAyfxaAzNc45vhje92j" target="_blank" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>
                        </div>
                        ${isGuest 
                            ? `<button id="login-signup-btn" class="btn btn-accent" style="width:100%"><i class="fas fa-sign-in-alt"></i> Login / Sign Up</button>`
    				        : `<a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a>`
                        }
                    </div>`;
                
                sidebar.innerHTML = `
    				<div class="sidebar-header"><h2>EMPYREAN</h2></div>
    				<ul class="sidebar-nav">${navItems.map(item => `<li><a href="#" class="nav-link" data-target="${item.id}"><i class="fas ${item.icon}"></i> ${item.text}</a></li>`).join('')}</ul>
    				${footerHTML}
    			`;
            }
            
            function buildHeader() {
                const headerActions = document.getElementById('main-header-actions');
                if(headerActions){
                    headerActions.innerHTML = isGuest ? '' : `<button class="btn cart-icon-button"><i class="fas fa-shopping-cart"></i> Cart <span class="cart-item-count">0</span></button>`;
                }
            }
            
            function renderDynamicUI() {
                 document.querySelectorAll('.follow-btn').forEach(btn => {
                    const userIdToFollow = btn.dataset.userId;
                    if (userIdToFollow === userState.id) {
                        btn.style.display = 'none';
                        return;
                    }
                     const pageFollow = btn.closest('.business-page-header');
                    if (pageFollow && userState.businessPage && userIdToFollow === userState.businessPage.id) {
                        btn.style.display = 'none';
                         return;
                    }

                    btn.style.display = 'inline-block';
                    const isFollowed = userState.followedUserIds.has(userIdToFollow);
                    btn.classList.toggle('followed', isFollowed);
                    btn.textContent = isFollowed ? 'Following' : 'Follow';
                });
                document.querySelectorAll('.like-btn').forEach(btn => {
                    const postElement = btn.closest('.impact-story, .reel-card, .news-list-item');
                    if(!postElement) return;
                    const postId = postElement.dataset.postId;
                    if (userState.likedPostIds.has(postId)) {
                        btn.querySelector('.fa-heart').classList.add('liked', 'fas');
                        btn.querySelector('.fa-heart').classList.remove('far');
                    } else {
                        btn.querySelector('.fa-heart').classList.remove('liked', 'fas');
                        btn.querySelector('.fa-heart').classList.add('far');
                    }
                });
                document.querySelectorAll('.retweet-btn').forEach(btn => {
                    const postElement = btn.closest('.impact-story, .news-list-item');
                    if (!postElement) return;
                    const postId = postElement.dataset.postId;
                     btn.querySelector('.fa-retweet').classList.toggle('retweeted', userState.retweetedPostIds.has(postId));
                });


                if(document.getElementById('profile').classList.contains('active')) {
                    const profileBadge = document.querySelector('#profile-display-name .badge');
                    if(profileBadge) profileBadge.style.display = userState.isVerified ? 'inline-flex' : 'none';

                    const followerCountEl = document.getElementById('profile-follower-count');
                    if(followerCountEl) followerCountEl.textContent = userState.followerCount.toLocaleString();
                }
            }
            
            function navigateTo(targetId, fromClick = false) {
                if (targetId === 'profile' && !isGuest && fromClick) {
                    renderUserProfile(userState.id);
                }

                document.querySelectorAll('.content-section.active').forEach(s => s.classList.remove('active'));
                const targetSection = document.getElementById(targetId);
                if (targetSection) {
                    targetSection.classList.add('active');
                    document.querySelector('.main-content').scrollTop = 0;
                }
                
                document.querySelectorAll('.nav-link.active').forEach(l => l.classList.remove('active'));
                const navLink = document.querySelector(`.nav-link[data-target="${targetId}"]`);
                if (navLink) navLink.classList.add('active');
                
                if (window.innerWidth <= 992 && sidebar.classList.contains('open')) {
                    sidebar.classList.remove('open');
                    contentOverlay.classList.remove('show');
                    document.body.classList.remove('modal-open');
                }
            }

            
            function updateWalletUI() {
                if(isGuest) return;
                const empyBalanceEl = document.getElementById('wallet-empy-balance');
                const usdEquivalentEl = document.getElementById('wallet-usd-equivalent');
                const liveBalanceEl = document.getElementById('live-user-empy-balance');

                const empyBalance = userState.empyBalance || 0;
                if(empyBalanceEl) {
                    empyBalanceEl.innerHTML = `<i class="fa-solid fa-coins"></i> ${empyBalance.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                }
                if(usdEquivalentEl) {
                    usdEquivalentEl.textContent = `~ ${formatUsdPrice(empyBalance * EMPY_RATE_USD)}`;
                }
                if (liveBalanceEl) {
                     liveBalanceEl.innerHTML = `(Your Balance: ${Math.floor(empyBalance).toLocaleString()} <i class="fa-solid fa-coins" style="font-size:0.8rem;"></i>)`;
                }
                renderMonetizationTab();
                updateStakingUI();
            }

            function updateCartUI() {
                const cartCountEl = document.querySelector('.cart-item-count');
                const cartItemsContainer = document.getElementById('cart-items-container');
                const cartTotalEl = document.getElementById('cart-total');
                const cartModalContainer = document.getElementById('cart-modal-container');
                
                if (!cartItemsContainer || !cartTotalEl || !cartModalContainer || !cartCountEl) return;
                
                cartCountEl.textContent = cart.length;

                const cartView = cartModalContainer.querySelector('#cart-view');
                const checkoutView = cartModalContainer.querySelector('#checkout-view');

                cartView.style.display = 'block';
                checkoutView.style.display = 'none';

                if (cart.length === 0) {
                    cartItemsContainer.innerHTML = '<p>Your cart is empty.</p>';
                    cartTotalEl.textContent = 'Total: $0.00';
                     cartModalContainer.querySelector('.checkout-btn').disabled = true;
                    return;
                }
                cartModalContainer.querySelector('.checkout-btn').disabled = false;
                let cartHTML = '';
                cart.forEach(item => {
                    cartHTML += `
                        <div class="cart-item" data-id="${item.id}">
                            <img src="${item.img}" alt="${item.name}">
                            <div class="cart-item-info"><h4>${item.name}</h4><p>${formatUsdPrice(parseFloat(item.price))}</p></div>
                        </div>`;
                });
                cartItemsContainer.innerHTML = cartHTML;
                const total = cart.reduce((sum, item) => sum + parseFloat(item.price), 0);
                cartTotalEl.textContent = `Total: ${formatUsdPrice(total)}`;
            }
                    
            function renderMarketplaceCards() {
                document.querySelectorAll('#marketplace .property-card').forEach(card => {
                    const priceEl = card.querySelector('.property-info div:last-child');
                    if (priceEl && card.dataset.price) {
                        priceEl.textContent = formatUsdPrice(parseFloat(card.dataset.price));
                    }
                    
                    const salesType = card.dataset.salesType;
                    const addToCartBtn = card.querySelector('.add-to-cart-btn');
                    const contactBtn = card.querySelector('.contact-seller-btn');
                    const warningEl = card.querySelector('.direct-trade-warning');

                    if(addToCartBtn) addToCartBtn.style.display = 'none';
                    if(contactBtn) contactBtn.style.display = 'none';
                    if(warningEl) warningEl.style.display = 'none';

                    if (salesType === 'escrow') {
                        if(addToCartBtn) addToCartBtn.style.display = 'block';
                    } else { // Direct sales
                        if(contactBtn) contactBtn.style.display = 'block';
                        if(warningEl) warningEl.style.display = 'block';
                    }
                });
            }

             function renderMonetizationTab() {
                const container = document.getElementById('profile-monetization');
                if (!container) return;

                const isEligible = userState.isVerified && userState.followerCount >= 500;
                
                if (isEligible) {
                    const empyBalance = userState.empyBalance || 0;
                    container.innerHTML = `
                        <h3><i class="fas fa-dollar-sign"></i> Your Monetization</h3>
                        <div class="wallet-card">
                            <p>Available for Withdrawal</p>
                            <h3 class="empy-balance"><i class="fa-solid fa-coins"></i> ${empyBalance.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</h3>
                            <p>~ ${formatUsdPrice(empyBalance * EMPY_RATE_USD)}</p>
                            <button class="btn btn-accent nav-link" data-target="my-wallet"><i class="fas fa-exchange-alt"></i> Go to Wallet</button>
                        </div>`;
                } else {
                    let nextRankInfo = '';
                    const nextRank = ranks.find(rank => rank.followers > userState.followerCount);
                    if (nextRank) {
                        nextRankInfo = `<p>Next Rank: <strong>${nextRank.name}</strong> (${userState.followerCount.toLocaleString()} / ${nextRank.followers.toLocaleString()} followers) for a <strong>${nextRank.reward} EMPY</strong> reward.</p>`;
                    }

                    let reasonsHTML = '<ul>';
                    if (!userState.isVerified) {
                        reasonsHTML += '<li><i class="fas fa-times-circle" style="color:var(--danger-color)"></i> Complete KYC verification. <a href="#" class="nav-link" data-target="profile">Verify Now</a></li>';
                    } else {
                         reasonsHTML += `<li><i class="fas fa-check-circle" style="color:var(--success-color)"></i> KYC Verified</li>`;
                    }

                    if (userState.followerCount < 500) {
                        reasonsHTML += `<li><i class="fas fa-times-circle" style="color:var(--danger-color)"></i> Reach 500 followers (Current: ${userState.followerCount})</li>`;
                    } else {
                        reasonsHTML += `<li><i class="fas fa-check-circle" style="color:var(--success-color)"></i> 500+ Followers</li>`;
                    }
                    reasonsHTML += '</ul>';

                    container.innerHTML = `
                        <h3><i class="fas fa-lock"></i> Monetization Locked</h3>
                        <div class="form-feedback info" style="display:block; text-align:left;">
                           <p>To unlock monetization features like withdrawals and direct payments, please meet the following criteria:</p>
                           ${reasonsHTML}
                           ${nextRankInfo}
                        </div>`;
                }
            }
            
            function renderBusinessPage() {
                const container = document.getElementById('business-page');
                if (!container) return;

                if (userState.businessPage) {
                    const page = userState.businessPage;
                     container.innerHTML = `
                        <div class="card business-page-header">
                            <div class="profile-header-container">
                                <div class="cover-photo-container" id="business-page-cover-photo" style="background-image: url('${page.coverPhoto}');">
                                    <label for="business-cover-photo-input" class="upload-overlay"><i class="fas fa-camera"></i></label>
                                    <input type="file" id="business-cover-photo-input" accept="image/*" style="display:none;">
                                </div>
                                <div class="profile-header">
                                    <div class="profile-pic-container">
                                        <label for="business-profile-photo-input" class="avatar-placeholder" style="width: 150px; height: 150px;">
                                            <div class="upload-overlay"><i class="fas fa-camera fa-2x"></i></div>
                                            <img src="${page.profilePhoto}" class="profile-pic" id="business-page-profile-pic">
                                        </label>
                                        <input type="file" id="business-profile-photo-input" accept="image/*" style="display:none;">
                                    </div>
                                    <div class="profile-header-info">
                                        <h2 id="business-page-name">${page.name} <i class="fas fa-pen edit-icon" data-field="name" title="Edit Name"></i></h2>
                                        <p id="business-page-tagline">${page.tagline} <i class="fas fa-pen edit-icon" data-field="tagline" title="Edit Tagline"></i></p>
                                        <div class="profile-header-actions">
                                            <button class="btn btn-small btn-accent promote-page-btn"><i class="fas fa-rocket"></i> Promote Page</button>
                                            <button class="btn btn-small follow-btn" data-user-id="${page.id || 'business-page-1'}">Follow</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="profile-tabs" id="business-page-tabs">
                                <div class="profile-tab active" data-target="business-page-feed-tab">Feed</div>
                                <div class="profile-tab" data-target="business-page-about-tab">About</div>
                                <div class="profile-tab" data-target="business-page-analytics-tab">Analytics</div>
                            </div>
                        </div>
                        <div id="business-page-feed-tab" class="profile-tab-content active">
                            <div class="card"><div class="card-content">
                                <form id="create-business-post-form">
                                    <div class="form-group"><textarea id="business-post-text" placeholder="Promote your products or services..."></textarea></div>
                                    <div id="business-post-media-preview"></div>
                                    <div class="post-actions-container">
                                        <label for="business-post-media-input" class="btn btn-media-upload"><i class="fas fa-photo-video"></i> Add Media</label>
                                        <input type="file" id="business-post-media-input" accept="image/*,video/*" multiple style="display:none;">
                                        <button type="submit" class="btn btn-accent">Post</button>
                                    </div>
                                </form>
                            </div></div>
                            <div id="business-page-feed-container"></div>
                        </div>
                         <div id="business-page-about-tab" class="profile-tab-content"><div class="card"><div class="card-content business-page-content">
                             <h4>Contact Information</h4>
                                <p><i class="fas fa-tag"></i> <strong>Industry:</strong> <span id="business-page-industry-span">${page.industry}</span> <i class="fas fa-pen edit-icon" data-field="industry" title="Edit Industry"></i></p>
                                <p><i class="fas fa-envelope"></i> <strong>Email:</strong> <span id="business-page-email-span">${page.email}</span> <i class="fas fa-pen edit-icon" data-field="email" title="Edit Email"></i></p>
                                <p><i class="fas fa-phone"></i> <strong>Phone:</strong> <span id="business-page-phone-span">${page.phone || 'N/A'}</span> <i class="fas fa-pen edit-icon" data-field="phone" title="Edit Phone"></i></p>
                                <p><i class="fas fa-map-marker-alt"></i> <strong>Address:</strong> <span id="business-page-address-span">${page.address || 'N/A'}</span> <i class="fas fa-pen edit-icon" data-field="address" title="Edit Address"></i></p>
                         </div></div></div>
                          <div id="business-page-analytics-tab" class="profile-tab-content"><div class="card"><div class="card-content">
                            <h3><i class="fas fa-chart-line"></i> Page Analytics</h3>
                            <div class="analytics-grid">
                                <div class="stat-card"><h4>Followers</h4><div class="stat-value" id="business-page-follower-count">${page.followerCount.toLocaleString()}</div></div>
                                <div class="stat-card"><h4>Post Reach (30d)</h4><div class="stat-value">56.4K</div></div>
                                <div class="stat-card"><h4>Engagement Rate</h4><div class="stat-value">8.2%</div></div>
                            </div>
                          </div></div></div>
                    `;
                } else {
                    container.innerHTML = `
                        <div id="create-page-prompt">
                            <i class="fas fa-briefcase fa-3x" style="color: var(--primary-color);"></i>
                            <h3 style="margin: 20px 0;">Promote Your Business</h3>
                            <p style="margin-bottom: 20px;">Create a professional page to showcase your brand, products, or services to the community.</p>
                            <button class="btn btn-accent" id="create-page-btn">Create a Page</button>
                        </div>
                    `;
                }
            }


            function handleWithdrawalMethodChange() {
                const method = document.getElementById('withdrawal-method').value;
                const fieldsContainer = document.getElementById('withdrawal-method-fields');
                Array.from(fieldsContainer.children).forEach(child => child.style.display = 'none');
                fieldsContainer.querySelectorAll('input').forEach(input => input.required = false);
                if (method) {
                    const fieldsToShow = document.getElementById(`${method}-fields`);
                    if (fieldsToShow) {
                        fieldsToShow.style.display = 'block';
                        fieldsToShow.querySelectorAll('input').forEach(input => input.required = true);
                    }
                }
            }

            function updateWithdrawalPreview() {
                const amountInput = document.getElementById('withdrawal-amount');
                if(!amountInput) return;
                const amountEmpy = parseFloat(amountInput.value);
                const method = document.getElementById('withdrawal-method').value;
                const previewEl = document.getElementById('withdrawal-preview');

                if (!amountEmpy || amountEmpy < 5 || !method) {
                    previewEl.innerHTML = '<p>Enter an amount (min 5 EMPY) and select a method.</p>';
                    return;
                }

                const amountUsd = amountEmpy * EMPY_RATE_USD;
                const feeInEmpy = amountEmpy * (CRYPTO_FEE_PERCENT / 100);
                const totalEmpyDeducted = amountEmpy + feeInEmpy;
                let finalReceiveAmount = (method === 'bank') ? amountUsd * USD_TO_NGN_RATE : amountUsd;
                
                let html = `<p>Withdrawal Amount: <strong>${amountEmpy.toLocaleString()} EMPY</strong> (${formatUsdPrice(amountUsd)})</p>`;
                html += `<p>Fee (${CRYPTO_FEE_PERCENT}%): <strong>${feeInEmpy.toLocaleString()} EMPY</strong></p>`;
                html += `<p>Total Deduction: <strong>${totalEmpyDeducted.toLocaleString()} EMPY</strong></p>`;
                if (method === 'bank') html += `<p>You will receive ~<strong>${formatNgnPrice(finalReceiveAmount)}</strong></p>`;
                else if (method === 'usdt') html += `<p>You will receive: <strong>${formatUsdPrice(finalReceiveAmount)} (USDT)</strong></p>`;
                else html += `<p>You will receive: <strong>${formatUsdPrice(finalReceiveAmount)}</strong> on your card</p>`;
                
                previewEl.innerHTML = html;
            }

            function updateTransferPreview() {
                const amountInput = document.getElementById('transfer-amount');
                if(!amountInput) return;
                const amountEmpy = parseFloat(amountInput.value) || 0;
                const networkFee = 1.0; // Fixed fee for internal transfers
                const previewEl = document.getElementById('transfer-preview');

                if (!amountEmpy || amountEmpy <= 0) {
                    previewEl.innerHTML = '<p>Enter an amount to see transaction details.</p>';
                    return;
                }
                
                const totalDeducted = amountEmpy + networkFee;

                let html = `<p>Amount to Send: <strong>${amountEmpy.toLocaleString()} EMPY</strong></p>`;
                html += `<p>Network Fee (Polygon): <strong>${networkFee.toLocaleString()} EMPY</strong></p>`;
                html += `<p>Total to be Deducted: <strong>${totalDeducted.toLocaleString()} EMPY</strong></p>`;
                
                previewEl.innerHTML = html;
            }

             function updateCrossChainTransferPreview() {
                const amountInput = document.getElementById('cross-chain-amount');
                if(!amountInput) return;
                const amountEmpy = parseFloat(amountInput.value) || 0;
                const networkSelect = document.getElementById('cross-chain-network');
                const selectedOption = networkSelect.options[networkSelect.selectedIndex];
                const networkFee = parseFloat(selectedOption.dataset.fee) || 0;
                const previewEl = document.getElementById('cross-chain-transfer-preview');

                if (!amountEmpy || amountEmpy <= 0) {
                    previewEl.innerHTML = '<p>Enter an amount to see transaction details.</p>';
                    return;
                }
                
                const totalDeducted = amountEmpy + networkFee;

                let html = `<p>Amount to Send: <strong>${amountEmpy.toLocaleString()} EMPY</strong></p>`;
                html += `<p>Network Fee (${selectedOption.textContent.split('(')[0].trim()}): <strong>${networkFee.toLocaleString()} EMPY</strong></p>`;
                html += `<p>Total to be Deducted: <strong>${totalDeducted.toLocaleString()} EMPY</strong></p>`;
                
                previewEl.innerHTML = html;
            }


            function populateProfileGallery(userId) {
                const gallery = document.getElementById('profile-gallery');
                if (!gallery) return;
                
                const allPosts = Array.from(document.querySelectorAll(`.impact-story[data-user-id="${userId}"]`));
                const mediaPosts = allPosts.filter(p => p.querySelector('.story-media-container'));

                if (mediaPosts.length === 0) {
                     gallery.innerHTML = '<p>No media posts yet.</p>';
                     return;
                }

                gallery.innerHTML = '';
                mediaPosts.forEach(post => {
                    const mediaNode = post.querySelector('.story-media-container').firstChild.cloneNode(true);
                    const galleryItem = document.createElement('div');
                    galleryItem.className = 'gallery-item';
                    galleryItem.appendChild(mediaNode);
                    gallery.appendChild(galleryItem);
                });
            }
            
            function addReelToDashboardSlider(reelData) {
                const container = document.getElementById('dashboard-reels-container');
                const slider = document.getElementById('dashboard-reels-slider');
                container.style.display = 'block';

                const card = document.createElement('div');
                card.className = 'dashboard-reel-card';
                card.dataset.navTarget = 'reels';
                card.innerHTML = `<video poster="${reelData.poster}" loop muted autoplay playsinline><source src="${reelData.url}" type="video/mp4"></video><div class="reel-content"><div class="reel-user-info"><div class="avatar-placeholder square" style="width:35px; height:35px;"><img src="${userState.avatar}" alt="User portrait"></div><span>@${userState.username}</span></div><p>${formatWhatsAppText(reelData.caption)}</p></div>`;
                slider.prepend(card);
            }
            
            function addMarketItemToDashboardSlider(marketData) {
                const container = document.getElementById('dashboard-market-container');
                const slider = document.getElementById('dashboard-market-slider');
                container.style.display = 'block';

                const card = document.createElement('div');
                card.className = 'dashboard-market-card';
                card.dataset.navTarget = 'marketplace';
                 if (marketData.videoSrc) {
                    card.innerHTML = `<video src="${marketData.videoSrc}" autoplay loop muted></video><div class="dashboard-market-card-info"><h5>${marketData.name}</h5><p>${formatUsdPrice(marketData.price)}</p></div>`;
                } else {
                    card.innerHTML = `<img src="${marketData.img}" alt="${marketData.name}"><div class="dashboard-market-card-info"><h5>${marketData.name}</h5><p>${formatUsdPrice(marketData.price)}</p></div>`;
                }
                slider.prepend(card);
            }
            
            function renderDashboardNews() {
                const container = document.getElementById('dashboard-news-container');
                const slider = document.getElementById('dashboard-news-slider');
                if (!container || !slider) return;

                slider.innerHTML = '';
                const newsItems = Array.from(document.querySelectorAll('#news .news-list-item'));
                newsItems.slice(0, 5).forEach(item => { // Show latest 5
                    const title = item.querySelector('h4').textContent;
                    const mediaEl = item.querySelector('.news-item-image img, .news-item-image video');
                    const src = mediaEl ? (mediaEl.src || mediaEl.poster) : 'https://source.unsplash.com/random/400x300/?news';
                    
                    const card = document.createElement('div');
                    card.className = 'dashboard-news-card';
                    card.dataset.navTarget = 'news';
                    
                    if (mediaEl && mediaEl.tagName === 'VIDEO') {
                        card.innerHTML = `<video src="${mediaEl.querySelector('source').src}" poster="${mediaEl.poster}" muted loop autoplay playsinline></video><div class="dashboard-news-card-info"><h5>${title}</h5></div>`;
                    } else {
                         card.innerHTML = `<img src="${src}" alt="${title}"><div class="dashboard-news-card-info"><h5>${title}</h5></div>`;
                    }

                    slider.prepend(card);
                });
                container.style.display = newsItems.length > 0 ? 'block' : 'none';
            }

            function renderSuggestedUsers() {
                const container = document.getElementById('suggested-users-container');
                const slider = document.getElementById('suggested-users-slider');
                if (isGuest || !container || !slider) return;

                slider.innerHTML = '';
                const usersToSuggest = Object.values(mockUsers).filter(u => u.id !== userState.id && !userState.followedUserIds.has(u.id));
                
                if (usersToSuggest.length > 0) {
                    usersToSuggest.forEach(user => {
                        const card = document.createElement('div');
                        card.className = 'suggested-user-card';
                        card.dataset.userId = user.id; // --- FIX 3: Added user ID for click handling ---
                        card.innerHTML = `
                            <div class="suggested-user-cover" style="background-image: url('${user.coverPhoto}')"></div>
                            <div class="avatar-placeholder"><img src="${user.avatar}" alt="${user.fullName}"></div>
                            <div class="suggested-user-card-info">
                                <strong>${user.fullName}</strong>
                                <p>@${user.username}</p>
                                <button class="btn btn-small follow-btn" data-user-id="${user.id}">Follow</button>
                            </div>
                        `;
                        slider.appendChild(card);
                    });
                    container.style.display = 'block';
                } else {
                    container.style.display = 'none';
                }
            }


            async function shareContent(shareData) {
                let copied = false;
                if (navigator.clipboard) {
                    try {
                        await navigator.clipboard.writeText(shareData.url);
                        showNotification('Link copied to clipboard!');
                        copied = true;
                    } catch (err) { console.error('Failed to copy link: ', err); }
                }

                if (navigator.share) {
                    try { await navigator.share(shareData); } 
                    catch (err) { if (err.name !== 'AbortError') { console.error('Web Share API Error:', err); } }
                } else if (!copied) {
                    showNotification('Sharing not supported on this browser.', 'error');
                }
                 rewardUserForAction('SHARE_POST');
            }
            
            function setupReelViewerObserver() {
                const reelViewerContainer = document.getElementById('reel-viewer-container');
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        const video = entry.target.querySelector('video');
                        if (entry.isIntersecting) {
                            video.play().catch(e => console.log("Autoplay was prevented."));
                        } else {
                            video.pause();
                        }
                    });
                }, { threshold: 0.5 });

                reelViewerContainer.querySelectorAll('.reel-viewer-item').forEach(item => {
                    observer.observe(item);
                });
            }

            function openReelViewer(clickedReelCard) {
                const reelViewerContainer = document.getElementById('reel-viewer-container');
                const allReelCards = Array.from(document.querySelectorAll('#reels .reel-card'));
                
                reelViewerContainer.innerHTML = '';
                
                allReelCards.forEach(card => {
                    const videoUrl = card.dataset.videoUrl;
                    const userInfoHTML = card.querySelector('.reel-user-info').innerHTML;
                    const captionText = card.querySelector('.reel-content p').textContent;
                    const postId = card.dataset.postId; 

                    const viewerItem = document.createElement('div');
                    viewerItem.className = 'reel-viewer-item';
                    viewerItem.dataset.postId = postId; 
                    viewerItem.innerHTML = `
                        <video src="${videoUrl}" loop playsinline preload="metadata"></video>
                        <div class="reel-viewer-info">
                            <div>
                                <div class="reel-user-info">${userInfoHTML}</div>
                                <p>${formatWhatsAppText(captionText)}</p>
                            </div>
                            <div class="reel-viewer-actions">
                                <a class="action-btn reel-like-btn" title="Like"><i class="far fa-heart"></i><span>1.2k</span></a>
                                <a class="action-btn reel-share-btn" title="Share"><i class="fas fa-share"></i><span>Share</span></a>
                                <a class="action-btn" title="Toggle Mute"><i class="fas fa-volume-up"></i></a>
                                <a href="${videoUrl}" download class="action-btn" title="Download Video"><i class="fas fa-download"></i></a>
                            </div>
                        </div>`;
                    reelViewerContainer.appendChild(viewerItem);
                });

                document.getElementById('reel-viewer-modal-overlay').style.display = 'block';
                document.body.style.overflow = 'hidden';
                
                setupReelViewerObserver();
                
                const clickedIndex = allReelCards.indexOf(clickedReelCard);
                if (clickedIndex > -1) {
                    reelViewerContainer.children[clickedIndex].scrollIntoView();
                }
            }
            
            let marketplaceGalleryState = {
                media: [],
                currentIndex: 0
            };

            function showMarketplaceGallery(media, startIndex = 0) {
                marketplaceGalleryState.media = media;
                marketplaceGalleryState.currentIndex = startIndex;
                
                document.getElementById('marketplace-gallery-modal').classList.add('show');
                document.body.classList.add('modal-open');
                renderMarketplaceGalleryView();
            }

            function renderMarketplaceGalleryView() {
                const mainContainer = document.querySelector('.gallery-main-image-container');
                const thumbsContainer = document.getElementById('gallery-thumbnails-container');
                
                const existingMedia = mainContainer.querySelector('img, video');
                if (existingMedia) existingMedia.remove();
                
                const currentMedia = marketplaceGalleryState.media[marketplaceGalleryState.currentIndex];
                 if (!currentMedia) return;

                const isVideo = typeof currentMedia === 'string' && (currentMedia.endsWith('.mp4') || currentMedia.startsWith('blob:'));

                let mainMediaHTML = isVideo
                    ? `<video src="${currentMedia}" controls autoplay loop></video>`
                    : `<img src="${currentMedia}" alt="Marketplace item image">`;

                mainContainer.insertAdjacentHTML('afterbegin', mainMediaHTML);
                
                thumbsContainer.innerHTML = marketplaceGalleryState.media.map((url, index) => {
                     const isThumbVideo = typeof url === 'string' && (url.endsWith('.mp4') || url.startsWith('blob:'));
                     return `
                    <div class="gallery-thumbnail ${index === marketplaceGalleryState.currentIndex ? 'active' : ''}" data-index="${index}">
                        ${isThumbVideo
                            ? `<video src="${url}#t=0.5" preload="metadata" muted></video>`
                            : `<img src="${url}" alt="Thumbnail">`
                        }
                    </div>`
                }).join('');
            }

            function navigateMarketplaceGallery(direction) {
                const newIndex = marketplaceGalleryState.currentIndex + direction;
                if (newIndex >= 0 && newIndex < marketplaceGalleryState.media.length) {
                    marketplaceGalleryState.currentIndex = newIndex;
                    renderMarketplaceGalleryView();
                }
            }
            
            function updatePromoReachPreview() {
                const budget = parseFloat(document.getElementById('promo-budget').value) || 0;
                const previewEl = document.getElementById('promo-reach-preview');

                if (budget < 1000) {
                    previewEl.textContent = 'Minimum budget is ₦1,000';
                    return;
                }

                let reach;
                if (budget <= 10000) reach = budget * 2; 
                else if (budget <= 50000) reach = 10000 * 2 + (budget - 10000) * 2.5; 
                else if (budget <= 200000) reach = 10000 * 2 + 40000 * 2.5 + (budget - 50000) * 3; 
                else if (budget <= 500000) reach = 10000 * 2 + 40000 * 2.5 + 150000 * 3 + (budget - 200000) * 4; 
                else reach = 10000 * 2 + 40000 * 2.5 + 150000 * 3 + 300000 * 4 + (budget - 500000) * 5; 
                
                previewEl.textContent = `Estimated Reach: ~${Math.floor(reach).toLocaleString()} people`;
            }

            // --- RANKING REWARDS LOGIC ---
            const ranks = [
                { id: 'rank-1', name: 'Rising Star', followers: 500, reward: 50 },
                { id: 'rank-2', name: 'Community Voice', followers: 1000, reward: 100 },
                { id: 'rank-3', name: 'Influencer', followers: 5000, reward: 250 },
                { id: 'rank-4', name: 'Advocate', followers: 10000, reward: 500 },
                { id: 'rank-5', name: 'Leader', followers: 50000, reward: 1000 },
                { id: 'rank-6', name: 'Beacon', followers: 100000, reward: 2500 },
                { id: 'rank-7', name: 'Champion', followers: 250000, reward: 5000 },
                { id: 'rank-8', name: 'Ambassador', followers: 500000, reward: 10000 },
                { id: 'rank-9', name: 'Legend', followers: 1000000, reward: 25000 }
            ];

            function checkAndAwardRank(user) {
                if (user.followerCount < 500) return; // Check eligibility first

                ranks.forEach(rank => {
                    if (user.followerCount >= rank.followers && !user.awardedRanks.has(rank.id)) {
                        // Check if the ranking pool has enough funds
                        if (impactMiningState.rankingPoolSpent + rank.reward <= RANKING_REWARDS_POOL) {
                            user.empyBalance += rank.reward;
                            user.awardedRanks.add(rank.id);
                            impactMiningState.rankingPoolSpent += rank.reward; // Deduct from ranking pool
                            
                            // If the ranked user is the current logged-in user, show notification and update UI
                            if (user.id === userState.id) {
                                showNotification(`🎉 Congratulations! You've reached the rank of ${rank.name} and earned ${rank.reward} EMPY!`, 'success');
                                updateWalletUI();
                            }
                        }
                    }
                });
            }

            // --- MASTER EVENT LISTENERS ---
            function setupMasterEventListeners() {
                document.body.addEventListener('click', function(e) {
                    const target = e.target;
                    const closest = (selector) => target.closest(selector);

                    // --- LIVE STREAM CLICKS ---
                    const joinLiveBtn = closest('.join-live-btn');
                    if (joinLiveBtn) {
                        const hostName = joinLiveBtn.dataset.hostName;
                        const hostAvatar = joinLiveBtn.dataset.hostAvatar;
                        const background = joinLiveBtn.dataset.background;
                        const isImage = background.startsWith('http');

                        const liveContainer = goLiveModal.querySelector('.live-stream-container');
                        liveContainer.style.background = isImage ? `url(${background})` : background;
                        liveContainer.style.backgroundSize = 'cover';
                        liveContainer.style.backgroundPosition = 'center';

                        document.getElementById('live-host-name').textContent = hostName;
                        document.getElementById('live-host-avatar').src = hostAvatar;
                        document.getElementById('live-stream-host-avatar').src = hostAvatar;
                        
                        const isCurrentUserHost = !isGuest && userState.fullName === hostName;
                        const closeButton = goLiveModal.querySelector('#live-close-btn');
                        if (closeButton) {
                            closeButton.innerHTML = isCurrentUserHost ? 'End' : '&times;';
                            closeButton.title = isCurrentUserHost ? 'End Stream' : 'Leave Stream';
                        }
                        
                        const hostControls = ['#live-record-btn', '#live-invite-btn'];
                        hostControls.forEach(sel => {
                            const el = document.querySelector(sel);
                            if(el) el.style.display = isCurrentUserHost ? 'flex' : 'none';
                        });

                        goLiveModal.style.display = 'flex';
                        goLiveModal.classList.add('show');
                        document.body.classList.add('modal-open');

                        // Start live stream reward interval
                        if (liveStreamData.rewardInterval) clearInterval(liveStreamData.rewardInterval);
                        liveStreamData.rewardInterval = setInterval(() => {
                            rewardUserForAction('LIVE_STREAM_INTERVAL');
                        }, 300000); // 300000 ms = 5 minutes

                        return; 
                    }

                    if (closest('.options-btn')) { 
                        e.preventDefault(); 
                        const menu = closest('.options-btn').nextElementSibling; 
                        if(menu) {
                            document.querySelectorAll('.options-menu.show').forEach(m => {
                                if (m !== menu) m.classList.remove('show');
                            });
                            menu.classList.toggle('show');
                        }
                        return;
                    }

                    if (!closest('.post-options')) {
                        document.querySelectorAll('.options-menu.show').forEach(menu => menu.classList.remove('show'));
                    }

                    const navLink = closest('.nav-link');
                    if (navLink) {
                        e.preventDefault();
                        navigateTo(navLink.dataset.target, true);
                        return;
                    }
                    
                    if (closest('.mobile-menu-toggle')) {
                         sidebar.classList.toggle('open');
                         contentOverlay.classList.toggle('show');
                         document.body.classList.toggle('modal-open', sidebar.classList.contains('open'));
                         return;
                    }

                    if (closest('#content-overlay')) {
                        sidebar.classList.remove('open');
                        contentOverlay.classList.remove('show');
                        document.body.classList.remove('modal-open');
                        return;
                    }
                    
                    const dashboardClickTarget = closest('.dashboard-market-card, .dashboard-reel-card, .dashboard-news-card');
                     if (dashboardClickTarget) {
                        const navTarget = dashboardClickTarget.dataset.navTarget;
                        if (navTarget) {
                             navigateTo(navTarget);
                        }
                        return;
                    }
                    
                    // --- FIX 1 & 2: Cart and Checkout Button Logic ---
                    if (closest('.back-to-cart-btn')) {
                        document.getElementById('cart-view').style.display = 'block';
                        document.getElementById('checkout-view').style.display = 'none';
                        return;
                    }
                    if (closest('.finalize-purchase-btn')) {
                        const checkoutForm = document.getElementById('checkout-form');
                        if (checkoutForm.checkValidity()) {
                            // In a real app, you'd process payment here.
                            showNotification("Purchase completed successfully! Your items will be shipped.", "success");
                            cart = []; // Clear the cart
                            updateCartUI();
                            document.getElementById('cart-modal-overlay').classList.remove('show');
                            document.body.classList.remove('modal-open');
                        } else {
                            showNotification("Please fill in all required shipping and payment details.", "error");
                            checkoutForm.reportValidity(); // Show native browser validation messages
                        }
                        return;
                    }

                    const modalAction = closest('#login-signup-btn, #show-signup, #show-login, #show-forgot-password, #back-to-login, .close-modal, #logout-btn, #buy-empy-btn, #buy-empy-wallet-btn, .close-modal-btn, .reel-viewer-close, #live-close-btn, #promo-back-btn, .btn-google');
                    if (modalAction) {
                        e.preventDefault();
                        const openModal = closest('.modal-overlay-container, #cart-modal-overlay');
                        
                        if (modalAction.classList.contains('btn-google')) {
                             const googleUser = {
                                id: `user-google-${Date.now()}`,
                                fullName: `Google User`,
                                username: `googleuser${Math.floor(Math.random() * 1000)}`,
                                email: 'google.user@example.com',
                                password: 'googlepassword',
                                avatar: 'https://source.unsplash.com/random/150x150/?g-logo',
                                coverPhoto: 'https://source.unsplash.com/random/1200x400/?abstract',
                                bio: "Just joined via Google!",
                                likedPostIds: new Set(),
                                followedUserIds: new Set(),
                                retweetedPostIds: new Set(),
                                statuses: [],
                                viewedStatusUserIds: new Set(),
                                empyBalance: 0,
                                isVerified: false,
                                followerCount: 0,
                                awardedRanks: new Set(),
                                businessPage: null
                            };
                            rewardUserForAction('SUCCESSFUL_REFERRAL'); // Give referrer a reward if applicable
                            if (!registeredUsers[googleUser.email]) {
                                registeredUsers[googleUser.email] = googleUser;
                                mockUsers[googleUser.id] = googleUser;
                            }
                            initializeApp(false, false, registeredUsers[googleUser.email]);
                            authModal.classList.remove('show');
                            showNotification('Successfully signed in with Google!');

                        } else if (modalAction.id === 'live-close-btn') {
                            const hostName = document.getElementById('live-host-name').textContent;
                            const isCurrentUserHost = !isGuest && userState.fullName === hostName;
                            if (isCurrentUserHost) {
                                if (liveStreamData.rewardInterval) clearInterval(liveStreamData.rewardInterval); // Stop rewards
                                if (confirm("Do you want to save this stream as a recorded video?")) {
                                    addRecordedLiveStream(liveStreamData.title, hostName);
                                }
                                const streamCard = document.querySelector(`.live-stream-preview-card[data-host-name="${hostName}"]`);
                                if (streamCard) streamCard.remove();
                                showNotification("Stream Ended.", "info");
                            }
                            goLiveModal.style.display = 'none';
                            goLiveModal.classList.remove('show');
                            document.body.classList.remove('modal-open');
                        } else if (openModal && closest('.close-modal, .close-modal-btn')) {
                            openModal.classList.remove('show');
                            document.body.classList.remove('modal-open');
                        }
                        
                        if (closest('#status-modal-overlay')) closeStatusModal();
                        if (closest('.reel-viewer-close')) {
                            document.getElementById('reel-viewer-modal-overlay').style.display = 'none';
                            document.querySelectorAll('#reel-viewer-modal-overlay video').forEach(v => v.pause());
                            document.body.style.overflow = '';
                        }
                        if (modalAction.id === 'promo-back-btn') {
                            document.getElementById('promotion-setup-view').style.display = 'block';
                            document.getElementById('promotion-payment-details').style.display = 'none';
                        }

                        ['login-view', 'signup-view', 'forgot-password-view'].forEach(v => { if(document.getElementById(v)) document.getElementById(v).style.display = 'none'});
                        switch (modalAction.id) {
                            case 'login-signup-btn': authModal.classList.add('show'); document.getElementById('login-view').style.display = 'block'; generateCaptcha(); break;
                            case 'logout-btn': initializeApp(true); showNotification('You have been logged out.'); break;
                            case 'show-signup': document.getElementById('signup-view').style.display = 'block'; showFormFeedback('signup', '', 'info'); document.getElementById('signup-feedback').style.display='none'; break;
                            case 'show-login': case 'back-to-login': document.getElementById('login-view').style.display = 'block'; generateCaptcha(); break;
                            case 'show-forgot-password': document.getElementById('forgot-password-view').style.display = 'block'; break;
                            case 'buy-empy-btn': case 'buy-empy-wallet-btn': document.getElementById('buy-empy-modal').classList.add('show'); break;
                        }

                        return;
                    }
                    
                    if (closest('.live-host-info')) {
                        goLiveModal.classList.remove('show');
                        goLiveModal.style.display = 'none';
                        document.body.classList.remove('modal-open');
                        if (liveStreamData.rewardInterval) clearInterval(liveStreamData.rewardInterval);
                        setTimeout(() => navigateTo('profile'), 100); 
                        showNotification("Navigating to host profile...", "info");
                        return;
                    }
                    if (closest('.share-live-btn')) {
                        shareContent({
                            title: `Live Stream: ${liveStreamData.title}`,
                            text: `Join ${document.getElementById('live-host-name').textContent}'s live stream on Empyrean!`,
                            url: `${window.location.href.split('#')[0]}#live/${liveStreamData.streamId || '123'}`
                        });
                        return;
                    }
                    if (closest('#live-record-btn')) {
                        liveStreamData.isRecording = !liveStreamData.isRecording;
                        target.closest('#live-record-btn').classList.toggle('recording', liveStreamData.isRecording);
                        showNotification(liveStreamData.isRecording ? "Recording started!" : "Recording stopped.", 'info');
                        return;
                    }
                     if (closest('#live-invite-btn')) { 
                        const guestName = prompt("Enter username of guest to invite:", "samuel_okoro");
                        if (guestName) {
                            const guestUser = Object.values(mockUsers).find(u => u.username === guestName);
                            const guestSlot = document.querySelector('#multi-guest-slots .guest-slot:not(:has(img))');
                            if (guestUser && guestSlot) {
                                guestSlot.innerHTML = `<div><img src="${guestUser.avatar}" title="Guest: ${guestUser.fullName}"></div>`;
                                showNotification(`Invitation sent to ${guestUser.fullName}.`);
                            } else if (!guestSlot) {
                                showNotification("All guest slots are full.", "warning");
                            } else {
                                showNotification("User not found.", 'error');
                            }
                        }
                        return;
                    }
                    if (closest('#status-media-container video') || closest('#status-sound-toggle')) {
                        const video = document.querySelector('#status-media-container video');
                        const soundToggle = document.getElementById('status-sound-toggle');
                        if (video) {
                            video.muted = !video.muted;
                            soundToggle.innerHTML = `<i class="fas fa-volume-${video.muted ? 'mute' : 'up'}"></i>`;
                        }
                        return;
                    }
                    if (closest('#live-stream-screen') && !closest('.live-action-btn') && !closest('#live-comment-form') && !closest('#live-gift-catalog-modal') && !closest('#live-viewers-modal') && !closest('.live-header') && !closest('#multi-guest-container') && !closest('#host-avatar-container')) {
                        liveLikeCount++;
                        document.getElementById('live-like-count').textContent = liveLikeCount.toLocaleString();
                        const bubble = document.createElement('i');
                        bubble.className = 'fas fa-heart like-bubble';
                        target.closest('.live-stream-container').appendChild(bubble);
                        setTimeout(() => bubble.remove(), 1500);
                    }
                    if (closest('#live-gift-btn')) { document.getElementById('live-gift-catalog-modal').classList.toggle('show'); document.getElementById('live-viewers-modal').classList.remove('show'); updateWalletUI(); return; }
                    if (closest('.live-viewers')) {
                        document.getElementById('live-viewers-modal').classList.toggle('show'); document.getElementById('live-gift-catalog-modal').classList.remove('show'); 
                        const viewerList = document.getElementById('viewer-list-container');
                        viewerList.innerHTML = '';
                        Object.values(mockUsers).slice(0, 5).forEach(u => { 
                            viewerList.innerHTML += `<div class="viewer-item"><img src="${u.avatar}" alt="${u.fullName}"> <div class="viewer-item-info"><strong>${u.fullName}</strong><span>@${u.username}</span></div></div>`;
                        });
                        return;
                    }
                    if (closest('.bg-thumb')) {
                        document.querySelectorAll('.bg-thumb.active').forEach(t => t.classList.remove('active'));
                        closest('.bg-thumb').classList.add('active');
                        return;
                    }
                    const giftItem = closest('.gift-item');
                    if (giftItem) {
                        if (isGuest) {
                            showNotification("Please log in to send gifts.", 'error');
                            authModal.classList.add('show');
                            document.getElementById('login-view').style.display = 'block';
                            generateCaptcha();
                            return;
                        }
                        const price = parseFloat(giftItem.dataset.price);
                        if (userState.empyBalance >= price) {
                            userState.empyBalance -= price;
                            updateWalletUI();
                            const giftName = giftItem.dataset.name;
                            const giftSymbol = giftItem.dataset.symbol;
                            showGiftAnimation(giftSymbol);
                            createLiveComment(userState.fullName, `sent a ${giftName}!`);
                            document.getElementById('live-gift-catalog-modal').classList.remove('show');
                        } else {
                            showNotification("Insufficient EMPY balance.", 'error');
                            document.getElementById('buy-empy-modal').classList.add('show');
                        }
                        return;
                    }
                    
                    const paymentTab = closest('.payment-tab');
                    if (paymentTab) {
                        const container = paymentTab.closest('.modal-card, #checkout-form');
                        const targetContentId = paymentTab.dataset.target;
                        container.querySelectorAll('.payment-tab').forEach(t => t.classList.remove('active'));
                        paymentTab.classList.add('active');
                        container.querySelectorAll('.payment-method-content').forEach(c => c.style.display = 'none');
                        document.getElementById(targetContentId).style.display = 'block';
                        return;
                    }
                    
                    const settingsTab = closest('.settings-tab');
                    if (settingsTab) {
                        const container = closest('.card');
                        container.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
                        settingsTab.classList.add('active');
                        container.querySelectorAll('.settings-content').forEach(c => c.classList.remove('active'));
                        document.getElementById(settingsTab.dataset.target).classList.add('active');
                        return;
                    }
                    const profileTab = closest('.profile-tab');
                    if (profileTab) {
                        const container = closest('.card, .business-page-header');
                        container.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
                        profileTab.classList.add('active');
                        document.querySelectorAll('.profile-tab-content').forEach(c => c.classList.remove('active'));
                        document.getElementById(profileTab.dataset.target).classList.add('active');
                        return;
                    }
                    
                    const kycEntityBtn = closest('.kyc-entity-btn');
                    if(kycEntityBtn) {
                        const formId = kycEntityBtn.dataset.form;
                        document.querySelectorAll('.kyc-entity-btn').forEach(btn => btn.classList.remove('active'));
                        kycEntityBtn.classList.add('active');
                        document.querySelectorAll('.kyc-form').forEach(form => form.classList.remove('active'));
                        const formToShow = document.getElementById(formId);
                        if (formToShow) formToShow.classList.add('active');
                        return;
                    }
                    
                    if (closest('#gallery-next-btn')) { navigateMarketplaceGallery(1); return; }
                    if (closest('#gallery-prev-btn')) { navigateMarketplaceGallery(-1); return; }
                    const galleryThumb = closest('.gallery-thumbnail');
                    if (galleryThumb) {
                        showMarketplaceGallery(marketplaceGalleryState.media, parseInt(galleryThumb.dataset.index));
                        return;
                    }
                    const propertyCard = closest('.property-card');
                    if (propertyCard && !closest('.add-to-cart-btn') && !closest('.contact-seller-btn') && !closest('.promote-post-btn')) {
                        const media = JSON.parse(propertyCard.dataset.media || '[]');
                        if (media.length > 0) showMarketplaceGallery(media);
                        return;
                    }
                    
                    const reelViewerActionBtn = closest('.reel-viewer-actions .action-btn');
                    if (reelViewerActionBtn) {
                        e.preventDefault();
                        const viewerItem = closest('.reel-viewer-item');
                        const video = viewerItem.querySelector('video');
                        
                        if (reelViewerActionBtn.classList.contains('reel-like-btn')) {
                            const icon = reelViewerActionBtn.querySelector('i');
                            icon.classList.toggle('far');
                            icon.classList.toggle('fas');
                            icon.classList.toggle('liked');
                        } else if (reelViewerActionBtn.classList.contains('reel-share-btn')) {
                            const postId = viewerItem.dataset.postId;
                            const caption = viewerItem.querySelector('.reel-viewer-info p')?.textContent || "Check out this Reel!";
                            shareContent({
                                title: "Empyrean Reel",
                                text: caption,
                                url: `${window.location.href.split('#')[0]}#reel/${postId}`
                            });
                        } else if (reelViewerActionBtn.title === 'Toggle Mute') {
                            video.muted = !video.muted;
                            reelViewerActionBtn.querySelector('i').className = `fas fa-volume-${video.muted ? 'mute' : 'up'}`;
                        }
                        return;
                    }

                    const removeMediaBtn = closest('.remove-media-btn');
                    if(removeMediaBtn) {
                        const indexToRemove = parseInt(removeMediaBtn.dataset.index, 10);
                        
                        marketplaceMediaFiles = marketplaceMediaFiles.filter((_, index) => index !== indexToRemove);
                        
                        const dataTransfer = new DataTransfer();
                        marketplaceMediaFiles.forEach(file => dataTransfer.items.add(file));
                        document.getElementById('item-media').files = dataTransfer.files;
                        
                        handleMarketplacePreview(marketplaceMediaFiles, document.getElementById('marketplace-media-preview'));
                        return;
                    }
                    
                    const contactSellerBtn = closest('.contact-seller-btn');
                    if (contactSellerBtn) {
                        const card = closest('.property-card');
                        const contactInfoEl = card.querySelector('.direct-contact-info');
                        if(contactInfoEl.style.display === 'block') {
                            contactInfoEl.style.display = 'none';
                        } else {
                            contactInfoEl.innerHTML = `
                                <p><strong>Full Name:</strong> ${card.dataset.contactName || 'N/A'}</p>
                                <p><i class="fas fa-phone"></i> <strong>Phone:</strong> <a href="tel:${card.dataset.contactPhone}">${card.dataset.contactPhone || 'N/A'}</a></p>
                                <p><i class="fas fa-envelope"></i> <strong>Email:</strong> <a href="mailto:${card.dataset.contactEmail}">${card.dataset.contactEmail || 'N/A'}</a></p>
                                <p><i class="fas fa-map-marker-alt"></i> <strong>Address:</strong> ${card.dataset.contactAddress || 'N/A'}</a></p>
                            `;
                            contactInfoEl.style.display = 'block';
                        }
                        return;
                    }

                    if (closest('#message-attach-btn')) {
                        document.getElementById('message-file-input').click();
                        return;
                    }

                    if (closest('.chat-header')) {
                        const userId = closest('.chat-header').dataset.userId;
                        if(userId) {
                            showNotification(`Navigating to profile of ${mockUsers[userId].username}...`, 'info');
                            navigateTo('profile'); 
                        }
                        return;
                    }
                    
                    const communityTaskBtn = closest('.community-task-btn');
                    if (communityTaskBtn) {
                        const reward = parseInt(communityTaskBtn.dataset.reward, 10);
                        userState.empyBalance += reward;
                        updateWalletUI();
                        showNotification(`+${reward} EMPY! Thanks for your support.`);
                        window.open(communityTaskBtn.dataset.url, '_blank');
                        communityTaskBtn.disabled = true;
                        communityTaskBtn.innerHTML = 'Completed <i class="fas fa-check"></i>';
                        return;
                    }

                    const ngoCard = closest('.ngo-card');
                    if(ngoCard) {
                        renderNgoProfile(ngoCard.dataset.ngoId);
                        return;
                    }

                    if(closest('#back-to-ngo-grid')) {
                        document.getElementById('ngo-grid-view').style.display = 'block';
                        document.getElementById('ngo-profile-view').style.display = 'none';
                        document.getElementById('back-to-ngo-grid').style.display = 'none';
                        return;
                    }
                    
                     const editIcon = closest('.business-page-content .edit-icon, .business-page-header .edit-icon');
                    if(editIcon) {
                        const field = editIcon.dataset.field;
                        let currentElement, currentValue, promptTitle;

                        if (field === 'name' || field === 'tagline') {
                            currentElement = document.getElementById(`business-page-${field}`);
                            currentValue = currentElement.textContent.trim();
                            promptTitle = `Update Page ${field.charAt(0).toUpperCase() + field.slice(1)}`;
                        } else {
                            currentElement = document.getElementById(`business-page-${field}-span`);
                            currentValue = currentElement.textContent.trim();
                             promptTitle = `Update ${field.charAt(0).toUpperCase() + field.slice(1)}`;
                        }
                        
                        const newValue = prompt(promptTitle, currentValue);

                        if (newValue && newValue.trim() !== '' && newValue.trim() !== currentValue) {
                            currentElement.textContent = newValue;
                            userState.businessPage[field] = newValue;
                            showNotification("Page updated!", "success");
                        }
                        return;
                    }
                    
                    // --- FIX 3: Click listener for suggested user cards ---
                    const suggestedUserCard = closest('.suggested-user-card');
                    if(suggestedUserCard && !closest('.follow-btn')) {
                        const userId = suggestedUserCard.dataset.userId;
                        renderUserProfile(userId);
                        navigateTo('profile');
                        return;
                    }
                    
                    const uiToggle = closest('#refresh-captcha, .news-list-item h4, .contact-item, #toggle-bio-btn, #toggle-profile-info-btn, #profile-message-btn, .help-now-btn, .share-profile-btn, #pin-location-btn, #create-page-btn, #add-status-placeholder, .status-item, #status-nav-next, #status-nav-prev, .color-swatch');
                     if (uiToggle) {
                        if (closest('#refresh-captcha')) generateCaptcha();
                        if (closest('.news-list-item h4')) closest('.news-list-item').classList.toggle('expanded');
                        if (closest('#profile-message-btn')) { e.preventDefault(); navigateTo('messages'); }
                        if (closest('.contact-item')) { e.preventDefault(); openChat(closest('.contact-item').dataset.userId); }
                        if (closest('#toggle-bio-btn')) {
                            const bio = document.getElementById('profile-bio');
                            const btn = closest('#toggle-bio-btn');
                            bio.classList.toggle('expanded');
                            btn.textContent = bio.classList.contains('expanded') ? 'Show Less' : 'Read More';
                        }
                        if (closest('#toggle-profile-info-btn')) {
                            const extendedInfo = document.getElementById('profile-extended-info');
                            const btn = closest('#toggle-profile-info-btn');
                            const isHidden = extendedInfo.style.display === 'none' || extendedInfo.style.display === '';
                            extendedInfo.style.display = isHidden ? 'block' : 'none';
                            btn.textContent = isHidden ? 'View Less' : 'View More';
                        }
                        if (closest('.help-now-btn')) {
                            const post = closest('.impact-story');
                            const username = post ? post.dataset.username : 'the cause';
                            document.getElementById('donation-modal-title').textContent = `Support ${username}`;
                            document.getElementById('sos-donation-modal').classList.add('show');
                        }
                        if (closest('.share-profile-btn')) {
                            shareContent({
                                title: `View ${userState.fullName}'s Profile on Empyrean`,
                                text: userState.bio || `Check out ${userState.fullName}'s profile on Empyrean.`,
                                url: `${window.location.href.split('#')[0]}#profile/${userState.username}`
                            });
                        }
                         if (closest('.share-status-btn')) {
                             shareContent({
                                title: `${currentStatusUser.fullName}'s Status`,
                                text: `Check out the latest status from ${currentStatusUser.fullName}.`,
                                url: `${window.location.href.split('#')[0]}#status/${currentStatusUser.id}`
                            });
                        }
                        if (closest('#pin-location-btn')) {
                            const lat = (Math.random() * (9.0 - 6.4) + 6.4).toFixed(6);
                            const lon = (Math.random() * (7.4 - 3.4) + 3.4).toFixed(6);
                            document.getElementById('crisis-location-coords').textContent = `Pinned at: ${lat}, ${lon}`;
                        }
                        if (closest('#create-page-btn')) {
                            document.getElementById('create-business-page-modal').classList.add('show');
                        }
                        if (closest('#add-status-placeholder')) {
                            e.preventDefault();
                            document.getElementById('create-status-modal').classList.add('show');
                            document.body.classList.add('modal-open');
                        }
                        if (closest('.status-item') && !closest('#add-status-placeholder')) { 
                            e.preventDefault(); 
                            playStatus(closest('.status-item').dataset.userId); 
                        }
                        if (closest('#status-nav-next')) { e.preventDefault(); nextStatus(); }
                        if (closest('#status-nav-prev')) { e.preventDefault(); prevStatus(); }
                        if (closest('.color-swatch')) { document.getElementById('status-text-input').style.background = closest('.color-swatch').dataset.color; }
                        return;
                    }

                    const adminAction = closest('.approve-withdrawal-btn, .reject-withdrawal-btn, .approve-sos-btn, .reject-sos-btn');
                    if(adminAction) {
                        e.preventDefault();
                        const itemEl = closest('.admin-queue-item');
                        const id = itemEl.dataset.id;
                        const actionType = itemEl.parentElement.id;
                        
                        if (closest('.approve-sos-btn')) {
                            const sosRequest = mockAdminSosQueue.find(i => i.id === id);
                            if(sosRequest) {
                                createSosPostOnFeed(sosRequest);
                                rewardUserForAction('VERIFIED_SOS_REQUEST', sosRequest.userId);
                            }
                        }
                        
                        if (actionType === 'admin-withdrawal-queue') mockAdminWithdrawalQueue = mockAdminWithdrawalQueue.filter(i => i.id !== id);
                        if (actionType === 'admin-sos-queue') mockAdminSosQueue = mockAdminSosQueue.filter(i => i.id !== id);
                        
                        itemEl.style.opacity = 0;
                        setTimeout(() => { 
                            itemEl.remove(); 
                            if (actionType === 'admin-withdrawal-queue' && mockAdminWithdrawalQueue.length === 0) renderAdminQueues(); 
                            if (actionType === 'admin-sos-queue' && mockAdminSosQueue.length === 0) renderAdminQueues();
                        }, 300);
                        showNotification("Action completed.");
                        return;
                    }

                    const reelCard = closest('#reels .reel-card');
                    if (reelCard && !closest('.options-btn')) {
                        e.preventDefault();
                        openReelViewer(reelCard);
                        return;
                    }
                    
                    const interactiveAction = closest('.add-to-cart-btn, .cart-icon-button, .checkout-btn, .like-btn, .follow-btn, .gift-button, .report-btn, .share-btn, .comment-btn, .edit-post-btn, .delete-post-btn, .promote-post-btn, #post-format-toolbar button, .retweet-btn, .promote-page-btn');
                    if(interactiveAction) {
                        e.preventDefault();
                        const postElement = closest('.impact-story, .reel-card, .property-card, .news-list-item');

                        if (isGuest && !closest('.share-btn') && !closest('.follow-btn')) {
                            showNotification("Please log in to perform this action.", 'error');
                            authModal.classList.add('show');
                            document.getElementById('login-view').style.display = 'block';
                            generateCaptcha();
                            return;
                        }

                        if(closest('.retweet-btn') && postElement) {
                            const originalPostId = postElement.dataset.postId;
                            const originalUserId = postElement.dataset.userId;

                            if (originalUserId === userState.id) {
                                showNotification("You cannot retweet your own post.", "warning");
                                return;
                            }
                             if (userState.retweetedPostIds.has(originalPostId)) {
                                showNotification("You have already retweeted this post.", "info");
                                return;
                            }
                            
                            const originalAuthor = mockUsers[originalUserId];
                            const originalText = postElement.querySelector('.story-content p')?.innerHTML;
                            const mediaContainerClone = postElement.querySelector('.story-media-container')?.cloneNode(true);
                            const mediaFiles = mediaContainerClone ? Array.from(mediaContainerClone.querySelectorAll('img, video')).map(el => ({ url: el.src, type: el.tagName === 'IMG' ? 'image/jpeg' : 'video/mp4' })) : [];

                            const retweet = createNewPostElement(originalText, mediaFiles, originalAuthor, false, { retweeterName: userState.fullName });
                            feedContainer.prepend(retweet);
                             userState.retweetedPostIds.add(originalPostId);
                            renderDynamicUI();
                            rewardUserForAction('RETWEET_POST');

                        } else if(closest('#post-format-toolbar button')) {
                            const textarea = document.getElementById('post-text');
                            const format = closest('#post-format-toolbar button').dataset.format;
                            const start = textarea.selectionStart;
                            const end = textarea.selectionEnd;
                            const selectedText = textarea.value.substring(start, end);
                            let wrapChar = '';
                            if (format === 'bold') wrapChar = '*';
                            else if (format === 'italic') wrapChar = '_';
                            else if (format === 'strike') wrapChar = '~';
                            
                            const newText = `${textarea.value.substring(0, start)}${wrapChar}${selectedText}${wrapChar}${textarea.value.substring(end)}`;
                            textarea.value = newText;
                            textarea.focus();

                        } else if(closest('.delete-post-btn') && postElement) {
                            if (confirm('Are you sure you want to delete this post?')) {
                                postElement.style.transition = 'opacity 0.3s ease';
                                postElement.style.opacity = '0';
                                setTimeout(() => { postElement.remove(); populateProfileGallery(userState.id); }, 300);
                            }
                        } else if (closest('.promote-post-btn') && postElement) {
                            promptForPromotion(postElement.dataset.postId || postElement.dataset.id);
                        } else if (closest('.promote-page-btn')) {
                             promptForPromotion(userState.businessPage.id);
                        } else if (closest('.edit-post-btn') && postElement) {
                            const postId = postElement.dataset.postId;
                            const postText = postElement.querySelector('.story-content p')?.textContent || '';
                            document.getElementById('edit-post-id').value = postId;
                            document.getElementById('edit-post-text').value = postText;
                            document.getElementById('edit-post-modal-overlay').classList.add('show');
                        } else if (closest('.share-btn') && postElement) {
                            const postId = postElement.dataset.postId;
                            shareContent({
                                title: "Check out this post on Empyrean!",
                                text: postElement.querySelector('.story-content p, .news-item-content p')?.textContent.substring(0, 100) + '...' || 'Humanitarian impact story',
                                url: `${window.location.href.split('#')[0]}#post/${postId}`
                            });
                        } else if(closest('.like-btn') && postElement) {
                            const likeBtn = closest('.like-btn');
                            const postId = postElement.dataset.postId;
                            const likeIcon = likeBtn.querySelector('.fa-heart');
                            const likeCountEl = likeBtn.querySelector('.like-count');
                            let likeCount = parseInt(likeCountEl.textContent.replace(/,/g, ''));
                            
                            rewardUserForAction('ENGAGE_LIKE');

                            if (userState.likedPostIds.has(postId)) {
                                userState.likedPostIds.delete(postId);
                                likeIcon.classList.remove('liked', 'fas');
                                likeIcon.classList.add('far');
                                likeCount--;
                            } else {
                                userState.likedPostIds.add(postId);
                                likeIcon.classList.add('liked', 'fas');
                                likeIcon.classList.remove('far');
                                likeCount++;
                                rewardUserForAction('RECEIVE_LIKE', postElement.dataset.userId);
                            }
                            likeCountEl.textContent = new Intl.NumberFormat().format(likeCount);
                        } else if (closest('.follow-btn')) {
                            const followBtn = closest('.follow-btn');
                            const userIdToFollow = followBtn.dataset.userId;
                            
                            // Handle page follows
                            const isPageFollow = !!closest('.business-page-header');
                            if (isPageFollow && userState.businessPage.id === userIdToFollow) {
                                if (userState.followedUserIds.has(userIdToFollow)) {
                                    userState.followedUserIds.delete(userIdToFollow);
                                    userState.businessPage.followerCount--;
                                } else {
                                    userState.followedUserIds.add(userIdToFollow);
                                    userState.businessPage.followerCount++;
                                }
                                document.getElementById('business-page-follower-count').textContent = userState.businessPage.followerCount.toLocaleString();
                            } else {
                                // Handle user follows
                                const userToFollow = mockUsers[userIdToFollow];
                                if (!userToFollow) return;
        
                                if (userState.followedUserIds.has(userIdToFollow)) {
                                    userState.followedUserIds.delete(userIdToFollow);
                                    userToFollow.followerCount--;
                                } else {
                                    userState.followedUserIds.add(userIdToFollow);
                                    userToFollow.followerCount++;
                                    checkAndAwardRank(userToFollow); // Check for rank up on new follow
                                }
                            }
                            renderDynamicUI();
                            renderSuggestedUsers();
                        } else if (closest('.comment-btn') && postElement) {
                            const commentSection = postElement.querySelector('.comment-section');
                            const isVisible = window.getComputedStyle(commentSection).display === 'block';
                            commentSection.style.display = isVisible ? 'none' : 'block';
                        } else if (closest('.add-to-cart-btn')) {
                            e.stopPropagation();
                            const card = closest('.property-card');
                            const item = { id: card.dataset.id, name: card.dataset.name, price: card.dataset.price, img: card.querySelector('img, video').src };
                            if (cart.find(cartItem => cartItem.id === item.id)) {
                                showNotification("This item is already in your cart.", 'warning');
                            } else {
                                cart.push(item);
                                updateCartUI();
                                showNotification(`${item.name} added to cart!`);
                            }
                        } else if (closest('.cart-icon-button')) {
                            document.getElementById('cart-modal-overlay').classList.add('show');
                            document.body.classList.add('modal-open');
                            updateCartUI();
                        } else if (closest('.checkout-btn')) {
                            document.getElementById('cart-view').style.display = 'none';
                            document.getElementById('checkout-view').style.display = 'block';
                        }
                    }
                });

                document.body.addEventListener('change', function(e){
                    const target = e.target;
                    const files = target.files ? Array.from(target.files) : [];

                    if (target.id === 'signup-avatar') {
                        if (files.length > 0) handleAvatarUpload(files[0], 'avatar-preview', true);
                    } else if (target.id === 'profile-pic-input-main') {
                         if (files.length > 0) handleAvatarUpload(files[0], 'profile-pic-img', true);
                    } else if (target.id === 'cover-photo-input') {
                        if (files.length > 0) {
                            newCoverFile = files[0];
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                document.getElementById('profile-cover-container').style.backgroundImage = `url('${event.target.result}')`;
                            };
                            reader.readAsDataURL(newCoverFile);
                        }
                    } else if (target.id === 'business-cover-photo-input' && files.length > 0) {
                         const newFile = files[0];
                         const reader = new FileReader();
                         reader.onload = (event) => {
                            const newUrl = event.target.result;
                            document.getElementById('business-page-cover-photo').style.backgroundImage = `url('${newUrl}')`;
                            userState.businessPage.coverPhoto = newUrl;
                             showNotification("Cover photo updated!");
                         };
                         reader.readAsDataURL(newFile);
                    } else if (target.id === 'business-profile-photo-input' && files.length > 0) {
                        const newFile = files[0];
                        resizeAndCropImage(newFile, 150, 150, (dataUrl) => {
                            document.getElementById('business-page-profile-pic').src = dataUrl;
                            userState.businessPage.profilePhoto = dataUrl;
                            showNotification("Profile photo updated!");
                        });
                    } else if (target.id === 'main-logo-input') {
                        if (files.length > 0) handleAvatarUpload(files[0], 'main-logo-preview');
                    } else if (target.matches('[name="user-type"]')) {
                        const orgFields = document.getElementById('org-fields');
                        const individualFields = document.getElementById('individual-fields');
                        if (!orgFields || !individualFields) return;

                        const isOrg = target.value === 'organisation';
                        orgFields.style.display = isOrg ? 'block' : 'none';
                        individualFields.style.display = isOrg ? 'none' : 'block';
                        
                        orgFields.querySelectorAll('input').forEach(input => input.required = isOrg);
                        individualFields.querySelectorAll('input').forEach(input => input.required = !isOrg);

                    } else if (target.id === 'post-media-input') {
                        postMediaFiles = files;
                        handleMediaPreview(postMediaFiles, 'post-media-preview');
                    } else if (target.id === 'business-post-media-input') {
                        businessPostMediaFiles = files;
                        handleMediaPreview(businessPostMediaFiles, 'business-post-media-preview');
                    } else if (target.id === 'sos-media-input') {
                        sosMediaFiles = files;
                        handleMediaPreview(sosMediaFiles, 'sos-media-preview');
                    } else if (target.id === 'crisis-media-input') {
                        crisisMediaFiles = files;
                        handleMediaPreview(crisisMediaFiles, 'crisis-media-preview');
                    } else if (target.id === 'item-media') {
                        if (files.length > 0) {
                            marketplaceMediaFiles = marketplaceMediaFiles.concat(files).slice(0, 15); 
                            const dataTransfer = new DataTransfer();
                            marketplaceMediaFiles.forEach(file => dataTransfer.items.add(file));
                            target.files = dataTransfer.files;
                            handleMarketplacePreview(marketplaceMediaFiles, document.getElementById('marketplace-media-preview'));
                            document.getElementById('marketplace-text-fields').style.display = 'block';
                        }
                    } else if (target.id === 'status-media-upload') {
                        if (files.length > 0) {
                            statusMediaFile = files[0];
                            const previewContainer = document.getElementById('status-media-preview-container');
                            previewContainer.innerHTML = '';
                            const url = URL.createObjectURL(statusMediaFile);
                            let mediaEl;
                            if (statusMediaFile.type.startsWith('image/')) {
                                mediaEl = document.createElement('img');
                            } else {
                                mediaEl = document.createElement('video');
                                mediaEl.muted = true;
                                mediaEl.autoplay = true; // Autoplay for preview
                                mediaEl.playsinline = true;
                            }
                            mediaEl.src = url;
                            previewContainer.appendChild(mediaEl);
                        }
                    } else if (target.id === 'withdrawal-method') {
                        handleWithdrawalMethodChange();
                        updateWithdrawalPreview();
                    } else if (target.id === 'transfer-network') { 
                        updateTransferPreview();
                    } else if (target.id === 'cross-chain-network') {
                        const selectedOption = target.options[target.selectedIndex];
                        document.getElementById('cross-chain-address').placeholder = selectedOption.dataset.placeholder;
                        updateCrossChainTransferPreview();
                    } else if (target.classList.contains('status-type-input')) {
                        const isText = target.value === 'text';
                        document.getElementById('status-media-input-area').style.display = isText ? 'none' : 'block';
                        document.getElementById('status-text-input-area').style.display = isText ? 'block' : 'none';
                    } else if (target.id === 'sales-type') {
                        const directFields = document.getElementById('direct-sales-fields');
                        const isDirect = target.value === 'direct';
                        directFields.style.display = isDirect ? 'block' : 'none';
                        directFields.querySelectorAll('input').forEach(input => input.required = isDirect);
                    } else if (target.id === 'message-file-input' && files.length > 0) {
                        const messagesContainer = document.getElementById('chat-messages-container');
                        const file = files[0];
                        const fileUrl = URL.createObjectURL(file);
                        const messageEl = createMessageElement(file.name, true, true, fileUrl, file.type);
                        messagesContainer.appendChild(messageEl);
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        target.value = ''; 
                    } else if (target.id === 'news-media-file' && files.length > 0) {
                        newsMediaFile = files[0];
                        const previewContainer = document.getElementById('news-media-preview');
                        previewContainer.innerHTML = '';
                        const url = URL.createObjectURL(newsMediaFile);
                        let mediaEl;
                        if(newsMediaFile.type.startsWith('image/')) {
                            mediaEl = document.createElement('img');
                        } else {
                            mediaEl = document.createElement('video');
                            mediaEl.controls = true;
                        }
                        mediaEl.src = url;
                        previewContainer.appendChild(mediaEl);
                    } else if (target.id === 'page-cover-photo-input' && files.length > 0) {
                        newPageCoverFile = files[0];
                        document.getElementById('page-cover-photo-preview').style.backgroundImage = `url(${URL.createObjectURL(newPageCoverFile)})`;
                        document.getElementById('page-cover-photo-preview').innerHTML = '';
                    } else if (target.id === 'page-profile-photo-input' && files.length > 0) {
                        newPageProfileFile = files[0];
                        document.getElementById('page-profile-photo-preview').style.backgroundImage = `url(${URL.createObjectURL(newPageProfileFile)})`;
                    }
                });

                document.body.addEventListener('submit', function(e) {
                    const form = e.target;
                     if (form.classList.contains('comment-form')) {
                        e.preventDefault();
                         const input = form.querySelector('input[name="comment-text"]');
                        const text = input.value.trim();
                        const postElement = form.closest('.impact-story, .news-list-item');
                        if(text && postElement){
                            rewardUserForAction('ENGAGE_COMMENT');
                            rewardUserForAction('RECEIVE_COMMENT', postElement.dataset.userId);
                            const createCommentElement = (text) => {
                                const commentEl = document.createElement('div');
                                commentEl.className = 'comment';
                                commentEl.innerHTML = `<div class="avatar-placeholder square"><img src="${userState.avatar}" alt="user avatar"></div><div class="comment-content"><strong>${userState.fullName}</strong><p>${formatWhatsAppText(text)}</p></div>`;
                                return commentEl;
                            };
                            const newComment = createCommentElement(text);
                            const commentList = form.previousElementSibling;
                            if(commentList.querySelector('p')) commentList.innerHTML = '';
                            commentList.appendChild(newComment);
                            input.value = '';
                        }
                        return;
                    }

                    e.preventDefault();
                    if (form.id !== 'promotion-finalize-form' && form.id !== 'checkout-form' && !form.checkValidity()) {
                        e.stopPropagation();
                        showNotification('Please fill all required fields.', 'error');
                        return;
                    }
                    
                    switch (form.id) {
                        case 'login-form': {
                            const captchaInput = document.getElementById('login-captcha-input').value;
                            if (captchaInput.toUpperCase() !== captchaCode.toUpperCase()) {
                                showNotification('Invalid security code.', 'error');
                                generateCaptcha();
                                return;
                            }
                            const email = document.getElementById('login-email').value;
                            const password = document.getElementById('login-password').value;
                            const isAdminLogin = email === 'admin@empyrean.com' && password === 'adminpass';
                            
                            const foundUser = Object.values(registeredUsers).find(u => u.email === email && u.password === password);

                            if (isAdminLogin) {
                                initializeApp(false, true);
                                authModal.classList.remove('show');
                                showNotification('Admin login successful!');
                            } else if (foundUser) {
                                initializeApp(false, false, foundUser);
                                authModal.classList.remove('show');
                                showNotification('Login successful!');
                            } else {
                                showNotification('Invalid email or password.', 'error');
                                generateCaptcha();
                            }
                            break;
                        }
                        case 'signup-form': { 
                            const password = document.getElementById('signup-password').value;
                            const confirmPassword = document.getElementById('signup-confirm-password').value;
                            if (password !== confirmPassword) {
                                showFormFeedback('signup', 'Passwords do not match.', 'error'); return;
                            }
                            
                            const email = document.getElementById('signup-email').value;
                            if (registeredUsers[email]) {
                                showFormFeedback('signup', 'An account with this email already exists.', 'error'); return;
                            }
                            
                            const fname = document.getElementById('signup-fname').value;
                            const lname = document.getElementById('signup-lname').value;
                            const newUser = {
                                id: `user-${Date.now()}`,
                                fullName: `${fname} ${lname}`,
                                username: document.getElementById('signup-username').value,
                                email: email,
                                password: password,
                                avatar: newAvatarFile || 'https://source.unsplash.com/random/150x150/?avatar',
                                coverPhoto: 'https://source.unsplash.com/random/1200x400/?pattern',
                                bio: "",
                                likedPostIds: new Set(),
                                followedUserIds: new Set(),
                                retweetedPostIds: new Set(),
                                statuses: [],
                                viewedStatusUserIds: new Set(),
                                empyBalance: 0,
                                isVerified: false,
                                followerCount: 0,
                                awardedRanks: new Set(),
                                businessPage: null
                            };
                            registeredUsers[email] = newUser;
                            mockUsers[newUser.id] = newUser;
                            
                            rewardUserForAction('SUCCESSFUL_REFERRAL');

                            showFormFeedback('signup', 'Account created successfully! Please log in.', 'success');
                            form.reset();
                            handleAvatarUpload(null, 'avatar-preview'); // Clear preview
                            setTimeout(() => {
                                ['login-view', 'signup-view', 'forgot-password-view'].forEach(v => document.getElementById(v).style.display = 'none');
                                document.getElementById('login-view').style.display = 'block';
                                generateCaptcha();
                            }, 2000);
                            break;
                        }
                        case 'profile-info-form': {
                            if(isGuest) return;
                            userState.fullName = document.getElementById('profile-fullname').value;
                            userState.username = document.getElementById('profile-username').value;
                            userState.bio = document.getElementById('profile-bio').value;
                            if (newAvatarFile) {
                                userState.avatar = newAvatarFile;
                                newAvatarFile = null;
                            }
                            if (newCoverFile) {
                                userState.coverPhoto = URL.createObjectURL(newCoverFile);
                                newCoverFile = null;
                            }
                            renderUserProfile(userState.id);
                            showNotification("Profile updated successfully!");
                            navigateTo('profile');
                            break;
                        }
                        case 'create-post-form': {
                            const text = document.getElementById('post-text').value;
                            if (!text.trim() && postMediaFiles.length === 0) {
                                showNotification('Post cannot be empty.', 'error'); return;
                            }
                            const newPost = createNewPostElement(text, postMediaFiles);
                            feedContainer.prepend(newPost);
                            populateProfileGallery(userState.id);
                            form.reset();
                            postMediaFiles = [];
                            document.getElementById('post-media-preview').innerHTML = '';
                            promptForPromotion(newPost.dataset.postId);
                            rewardUserForAction('CREATE_POST');
                            break;
                        }
                         case 'create-business-post-form': {
                            const text = form.querySelector('textarea').value;
                           
                            if (!text.trim() && businessPostMediaFiles.length === 0) {
                                showNotification('Post cannot be empty.', 'error'); return;
                            }
                            
                            const newPost = createNewPostElement(text, businessPostMediaFiles, userState, true);
                            document.getElementById('business-page-feed-container').prepend(newPost);
                            
                            form.reset();
                            businessPostMediaFiles = [];
                            form.querySelector('#business-post-media-preview').innerHTML = '';
                            showNotification("Posted to your page!");
                            break;
                        }
                        case 'go-live-form': {
                            liveStreamData.title = document.getElementById('live-title').value;
                            liveStreamData.streamId = `live-${Date.now()}`;
                            const selectedBgThumb = form.querySelector('.bg-thumb.active');
                            liveStreamData.background = selectedBgThumb ? selectedBgThumb.dataset.bg : liveBackgrounds[0];

                            createDashboardLiveCard(liveStreamData.streamId, liveStreamData.title, userState.fullName, userState.avatar, liveStreamData.background);
                            
                            const joinLiveBtn = document.querySelector(`.live-stream-preview-card[data-stream-id="${liveStreamData.streamId}"]`);
                            if(joinLiveBtn) joinLiveBtn.click();
                            
                            form.reset();
                            navigateTo('dashboard');
                            break;
                        }
                        case 'marketplace-form': {
                            const itemName = document.getElementById('item-name').value;
                            const itemPrice = parseFloat(document.getElementById('item-price').value);
                            const salesType = document.getElementById('sales-type').value;

                            let firstFile = marketplaceMediaFiles.length > 0 ? marketplaceMediaFiles[0] : null;
                            addMarketItemToDashboardSlider({ 
                                name: itemName, 
                                price: itemPrice, 
                                img: firstFile && firstFile.type.startsWith('image/') ? URL.createObjectURL(firstFile) : 'https://source.unsplash.com/random/400x300/?product',
                                videoSrc: firstFile && firstFile.type.startsWith('video/') ? URL.createObjectURL(firstFile) : null
                            });
                            
                            const propertyGrid = document.getElementById('property-grid-container');
                            const newCard = document.createElement('div');
                            newCard.className = 'property-card';
                            const newId = `prop-${Date.now()}`;
                            newCard.dataset.id = newId;
                            newCard.dataset.salesType = salesType;
                            
                             const mediaBlobUrls = marketplaceMediaFiles.map(file => URL.createObjectURL(file));
                             newCard.dataset.media = JSON.stringify(mediaBlobUrls);

                             if (salesType === 'direct') {
                                newCard.dataset.contactName = document.getElementById('item-seller-name').value || userState.fullName;
                                newCard.dataset.contactPhone = document.getElementById('item-seller-phone').value || 'Not provided';
                                newCard.dataset.contactEmail = document.getElementById('item-seller-email').value || 'Not provided';
                                newCard.dataset.contactAddress = document.getElementById('item-seller-address').value || 'Not provided';
                             }
                            
                            let mediaHTML = '';
                            if (mediaBlobUrls.length > 0) {
                                const firstFile = marketplaceMediaFiles[0];
                                if (firstFile.type.startsWith('image/')) {
                                    mediaHTML = `<img src="${mediaBlobUrls[0]}" alt="${itemName}">`;
                                } else {
                                    mediaHTML = `<video src="${mediaBlobUrls[0]}" autoplay loop muted controls></video>`;
                                }
                            } else {
                                mediaHTML = `<img src="https://source.unsplash.com/random/800x600/?product" alt="${itemName}">`;
                            }
                            
                            newCard.innerHTML = `
                                ${mediaHTML}
                                <div class="property-info">
                                    <h4>${itemName}</h4>
                                    <p><i class="fas fa-map-marker-alt"></i> ${document.getElementById('item-location').value}</p>
                                    <div>${formatUsdPrice(itemPrice)}</div>
                                </div>
                                <div class="property-seller-info"><span>by @${userState.username} ${salesType === 'escrow' ? '<i class="fas fa-check-circle verified-badge-small" title="Escrow Protected"></i>' : '<i class="fas fa-exclamation-circle unverified-badge-small" title="Direct Sales"></i>'}</span><span class="star-rating">New <i class="fas fa-star"></i></span></div>
                                ${salesType === 'direct' ? '<div class="direct-trade-warning" style="display:block;"><p><strong><i class="fas fa-exclamation-triangle"></i> Direct Sales:</strong> Please conduct due diligence.</p></div>' : ''}
                                <div class="direct-contact-info"></div>
                                <div class="property-actions">
                                    <span class="sponsored-badge" style="display: none; position: absolute; top: 10px; left: 10px;">Sponsored</span>
                                    ${salesType === 'escrow' ? '<button class="btn btn-accent add-to-cart-btn" style="display:block;"><i class="fas fa-cart-plus"></i> Add to Cart (Escrow)</button>' : '<button class="btn btn-danger contact-seller-btn" style="display:block;"><i class="fas fa-phone"></i> Contact Seller</button>'}
                                    <button class="btn promote-item-btn promote-post-btn"><i class="fas fa-rocket"></i> Promote</button>
                                </div>`;
                            propertyGrid.prepend(newCard);
                            
                            form.reset();
                            marketplaceMediaFiles = [];
                            document.getElementById('marketplace-media-preview').innerHTML = '';
                            document.getElementById('marketplace-text-fields').style.display = 'none'; // Hide fields again
                            showNotification('Item listed successfully!');
                            promptForPromotion(newId);
                            break;
                        }

                        case 'live-comment-form': {
                            const input = form.querySelector('#live-comment-input');
                            const text = input.value.trim();
                            if(text) createLiveComment(userState.fullName, text);
                            input.value = '';
                            break;
                        }
                         case 'help-form': {
                             const newSosRequest = {
                                id: `sos-${Date.now()}`,
                                userId: userState.id,
                                username: userState.username,
                                avatar: userState.avatar,
                                title: form.querySelector('#request-category').value,
                                story: form.querySelector('#request-story').value,
                                amount: form.querySelector('#request-amount').value,
                                currency: form.querySelector('#request-currency').value,
                                media: sosMediaFiles.map(file => ({ url: URL.createObjectURL(file), type: file.type }))
                            };
                            mockAdminSosQueue.push(newSosRequest);
                            if (isAdmin) {
                                renderAdminQueues();
                            }
                            showNotification("Your request has been submitted for verification.", "info");
                            form.reset();
                            sosMediaFiles = [];
                            document.getElementById('sos-media-preview').innerHTML = '';
                            navigateTo('dashboard');
                            break;
                        }
                         case 'crisis-form': {
                            const crisisData = {
                                type: form.querySelector('#crisis-type').value,
                                description: form.querySelector('#crisis-description').value,
                                location: form.querySelector('#crisis-location').value,
                                userId: userState.id,
                                username: userState.username,
                                avatar: userState.avatar,
                                media: crisisMediaFiles.map(file => ({ url: URL.createObjectURL(file), type: file.type }))
                            };
                            
                            form.reset();
                            crisisMediaFiles = [];
                            document.getElementById('crisis-media-preview').innerHTML = '';
                            document.getElementById('crisis-location-coords').textContent = '';

                            showNotification("Crisis report submitted!", 'success');
                            createCrisisPostOnFeed(crisisData);
                            rewardUserForAction('VERIFIED_CRISIS_REPORT');
                            navigateTo('dashboard');
                            break;
                        }
                        case 'reel-upload-form': {
                             const caption = form.querySelector('#reel-caption').value;
                             const videoFile = form.querySelector('#reel-video-file').files[0];
                             if(!videoFile) { showNotification("Please select a video file.", 'error'); return; }

                             const videoUrl = URL.createObjectURL(videoFile);
                             const newReelCard = document.createElement('div');
                             newReelCard.className = 'reel-card';
                             const newId = `reel-${Date.now()}`;
                             newReelCard.dataset.postId = newId;
                             newReelCard.dataset.videoUrl = videoUrl;
                             newReelCard.innerHTML = `<video src="${videoUrl}" poster="" loop muted playsinline></video><div class="reel-content"><div class="reel-user-info"><div class="avatar-placeholder"><img src="${userState.avatar}" alt="User avatar"></div><span>@${userState.username}</span></div><p>${formatWhatsAppText(caption)}</p></div><span class="sponsored-badge" style="display: none; position: absolute; top: 15px; left: 15px; z-index: 4;">Sponsored</span><div class="post-options" style="position: absolute; top: 15px; right: 15px;"><button class="options-btn" style="color:white; text-shadow: 1px 1px 2px black;"><i class="fas fa-ellipsis-v"></i></button><div class="options-menu"><a href="#" class="promote-post-btn"><i class="fas fa-rocket"></i> Promote</a></div></div>`;
                             
                             const video = newReelCard.querySelector('video');
                             newReelCard.addEventListener('mouseover', () => video.play().catch(e => {}));
                             newReelCard.addEventListener('mouseout', () => video.pause());

                             document.getElementById('reels-grid-container').prepend(newReelCard);
                             
                             addReelToDashboardSlider({url: videoUrl, poster: '', caption: caption});
                             rewardUserForAction('CREATE_REEL');
                             
                             form.reset();
                             showNotification('Reel uploaded successfully!');
                             promptForPromotion(newId);
                            break;
                        }
                        case 'buy-empy-form': {
                             const amountUsd = parseFloat(document.getElementById('buy-empy-amount-usd').value);
                             const empyReceived = amountUsd / EMPY_RATE_USD;
                             userState.empyBalance += empyReceived;
                             updateWalletUI();
                             form.reset();
                             document.getElementById('buy-empy-modal').classList.remove('show');
                             showNotification(`${empyReceived.toLocaleString()} EMPY purchased successfully!`);
                             break;
                        }
                        case 'donation-form': {
                            const amount = form.querySelector('#donate-amount-card').value;
                            if (amount && parseFloat(amount) > 0) {
                                showNotification(`Thank you for your generous donation of NGN ${amount}!`, 'success');
                                form.reset();
                                form.closest('.modal-overlay-container').classList.remove('show');
                                document.body.classList.remove('modal-open');
                            } else {
                                showNotification('Please enter a valid donation amount.', 'error');
                            }
                            break;
                        }
                        case 'p2p-transfer-form': { 
                            const amountEmpy = parseFloat(document.getElementById('transfer-amount').value) || 0;
                            const networkFee = 1.0;
                            const totalDeducted = amountEmpy + networkFee;

                            if (userState.empyBalance < totalDeducted) {
                                showNotification("Insufficient balance for this transfer.", "error");
                                return;
                            }
                            
                            userState.empyBalance -= totalDeducted;
                            updateWalletUI();
                            showNotification(`${amountEmpy.toLocaleString()} EMPY sent successfully!`, 'success');
                            form.reset();
                            updateTransferPreview();
                            break;
                        }
                         case 'cross-chain-transfer-form': {
                            const amountEmpy = parseFloat(form.querySelector('#cross-chain-amount').value) || 0;
                            const networkSelect = form.querySelector('#cross-chain-network');
                            const selectedOption = networkSelect.options[networkSelect.selectedIndex];
                            const networkFee = parseFloat(selectedOption.dataset.fee) || 0;
                            const totalDeducted = amountEmpy + networkFee;

                            if (userState.empyBalance < totalDeducted) {
                                showNotification("Insufficient balance for this transfer.", "error");
                                return;
                            }
                            
                            userState.empyBalance -= totalDeducted;
                            updateWalletUI();
                            showNotification(`${amountEmpy.toLocaleString()} EMPY sent to external wallet!`, 'success');
                            form.reset();
                            updateCrossChainTransferPreview();
                            break;
                        }
                        case 'promotion-setup-form': {
                            const paymentMethod = form.querySelector('#promo-payment').value;
                            const budget = parseFloat(form.querySelector('#promo-budget').value);
                            const budgetInUsd = budget / USD_TO_NGN_RATE;
                            const budgetInEmpy = budgetInUsd / EMPY_RATE_USD;

                            document.getElementById('promotion-setup-view').style.display = 'none';
                            document.getElementById('promotion-payment-details').style.display = 'block';

                            const paymentTitle = document.getElementById('payment-details-title');
                            const walletView = document.getElementById('promo-wallet-payment-view');
                            const cardView = document.getElementById('promo-card-payment-view');

                            if (paymentMethod === 'wallet') {
                                paymentTitle.textContent = "Confirm EMPY Payment";
                                walletView.style.display = 'block';
                                cardView.style.display = 'none';
                                document.getElementById('promo-empy-cost').innerHTML = `<i class="fa-solid fa-coins"></i> ${budgetInEmpy.toLocaleString(undefined, {maximumFractionDigits: 2})}`;
                            } else {
                                paymentTitle.textContent = `Pay ${formatNgnPrice(budget)} with Card`;
                                walletView.style.display = 'none';
                                cardView.style.display = 'block';
                            }
                            break;
                        }
                        case 'promotion-finalize-form': {
                            const paymentMethod = document.getElementById('promo-payment').value;
                            const budget = parseFloat(document.getElementById('promo-budget').value);
                            const budgetInUsd = budget / USD_TO_NGN_RATE;
                            const budgetInEmpy = budgetInUsd / EMPY_RATE_USD;
                             const postId = document.getElementById('promote-post-id').value;

                            if (paymentMethod === 'wallet') {
                                if (userState.empyBalance < budgetInEmpy) {
                                    showNotification('Insufficient EMPY balance for this promotion.', 'error');
                                    return;
                                }
                                userState.empyBalance -= budgetInEmpy;
                                updateWalletUI();
                            } else {
                                const cardForm = document.getElementById('promo-card-form');
                                if (!cardForm.checkValidity()) {
                                    showNotification("Please fill in your card details.", 'error');
                                    return;
                                }
                            }
                            
                            const postElement = document.querySelector(`[data-post-id="${postId}"], [data-id="${postId}"]`);
                            if(postElement) {
                                const sponsoredBadge = postElement.querySelector('.sponsored-badge');
                                if(sponsoredBadge) sponsoredBadge.style.display = 'inline-flex';
                            }

                            form.closest('.modal-overlay-container').classList.remove('show');
                            document.body.classList.remove('modal-open');
                            showNotification("Your promotion is now active!", "success");
                            break;
                        }
                        case 'edit-post-form': {
                            const postId = form.querySelector('#edit-post-id').value;
                            const newText = form.querySelector('#edit-post-text').value;
                            const postElement = document.querySelector(`.impact-story[data-post-id="${postId}"]`);
                            if (postElement) {
                                postElement.querySelector('.story-content p').innerHTML = formatWhatsAppText(newText);
                            }
                            form.closest('.modal-overlay-container').classList.remove('show');
                            showNotification("Post updated successfully!");
                            break;
                        }
                        case 'create-status-form': { // --- FIX 1: Corrected Status Creation ---
                            const type = form.querySelector('input[name="status-type"]:checked').value;
                            let newStatus;
                            if (type === 'media' && statusMediaFile) {
                                newStatus = {
                                    type: statusMediaFile.type.startsWith('image/') ? 'image' : 'video',
                                    url: URL.createObjectURL(statusMediaFile),
                                    caption: document.getElementById('status-media-caption').value,
                                    duration: 5000 
                                };
                                if(newStatus.type === 'video') {
                                    // This is an async operation, but for simulation we proceed.
                                    // In a real app, you'd wait for this to resolve.
                                    const videoEl = document.createElement('video');
                                    videoEl.onloadedmetadata = function() {
                                        if (this.duration > 120) {
                                            showNotification("Videos longer than 2 minutes will be split (simulation).", "info");
                                        }
                                        newStatus.duration = this.duration * 1000;
                                    };
                                    videoEl.src = newStatus.url;
                                }

                            } else if (type === 'text') {
                                const content = document.getElementById('status-text-input').value;
                                if (!content.trim()) {
                                    showNotification("Text status cannot be empty.", "error");
                                    return;
                                }
                                newStatus = {
                                    type: 'text',
                                    content: content,
                                    color: document.getElementById('status-text-input').style.background,
                                    duration: 5000
                                };
                            }
                            if (newStatus) {
                                if (!mockUsers[userState.id]) {
                                    mockUsers[userState.id] = { ...userState, statuses: [] };
                                }
                                if (!mockUsers[userState.id].statuses) {
                                    mockUsers[userState.id].statuses = [];
                                }
                                if (!userState.statuses) {
                                    userState.statuses = [];
                                }

                                userState.statuses.push(newStatus);
                                mockUsers[userState.id].statuses.push(newStatus);
                                renderStatusSlider();
                            }
                            form.reset();
                            statusMediaFile = null;
                            document.getElementById('status-media-preview-container').innerHTML = '';
                            document.getElementById('create-status-modal').classList.remove('show');
                            document.body.classList.remove('modal-open');
                            break;
                        }
                        case 'create-news-post-form': { 
                            const title = form.querySelector('#news-title').value;
                            const content = form.querySelector('#news-content').value;
                            
                            const newsList = document.getElementById('news-list-container');
                            const newItem = document.createElement('div');
                            newItem.className = 'news-list-item';
                            newItem.dataset.postId = `news-${Date.now()}`;
                            
                            let mediaHTML = '';
                            if (newsMediaFile) {
                                const url = URL.createObjectURL(newsMediaFile);
                                newItem.dataset.img = url;
                                if (newsMediaFile.type.startsWith('image/')) {
                                    mediaHTML = `<div class="news-item-image"><img src="${url}" alt="${title}"></div>`;
                                } else {
                                     mediaHTML = `<div class="news-item-image"><video style="width:100%; height:100%; object-fit:cover;" controls loop poster=""><source src="${url}" type="${newsMediaFile.type}"></video></div>`;
                                }
                            }
                            
                            newItem.innerHTML = `
                                ${mediaHTML}
                                <div class="news-item-content-wrapper">
                                    <div class="news-item-content"><h4>${title}</h4><span class="news-meta"><i class="fas fa-calendar-alt"></i> Just now</span><p>${content}</p></div>
                                    <div class="story-actions" style="margin-top: 15px;"><a class="action-btn like-btn"><i class="far fa-heart"></i><span class="like-count">0</span></a><a class="action-btn comment-btn"><i class="far fa-comment"></i><span class="comment-count">0</span></a><a class="action-btn share-btn"><i class="fas fa-share"></i><span>Share</span></a><a class="action-btn retweet-btn"><i class="fas fa-retweet"></i><span class="retweet-count">0</span></a></div>
                                    <div class="comment-section"><div class="comment-list"></div><form class="comment-form" novalidate><input type="text" name="comment-text" placeholder="Add a comment..." required><button type="submit"><i class="fas fa-paper-plane"></i></button></form></div>
                                </div>`;
                            
                            newsList.prepend(newItem);
                            renderDashboardNews();
                            rewardUserForAction('PUBLISH_NEWS');
                            
                            form.reset();
                            document.getElementById('news-media-preview').innerHTML = '';
                            newsMediaFile = null;
                            showNotification("News article published successfully!");
                            break;
                        }
                        case 'create-business-page-form': { 
                            const newPage = {
                                id: `biz-${Date.now()}`,
                                name: form.querySelector('#page-name').value,
                                tagline: form.querySelector('#page-tagline').value,
                                industry: form.querySelector('#page-industry').value,
                                email: form.querySelector('#page-email').value,
                                phone: form.querySelector('#page-phone').value,
                                address: form.querySelector('#page-address').value,
                                coverPhoto: newPageCoverFile ? URL.createObjectURL(newPageCoverFile) : 'https://source.unsplash.com/random/1200x400/?business',
                                profilePhoto: newPageProfileFile ? URL.createObjectURL(newPageProfileFile) : 'https://source.unsplash.com/random/150x150/?logo',
                                followerCount: 0
                            };

                            userState.businessPage = newPage;
                            mockUsers[userState.id].businessPage = newPage;

                            renderBusinessPage();
                            form.reset();
                            document.getElementById('page-cover-photo-preview').style.backgroundImage = '';
                            document.getElementById('page-cover-photo-preview').innerHTML = '<i class="fas fa-camera"></i>&nbsp; Add Cover Image';
                            document.getElementById('page-profile-photo-preview').style.backgroundImage = '';

                            newPageCoverFile = null;
                            newPageProfileFile = null;

                            form.closest('.modal-overlay-container').classList.remove('show');
                            document.body.classList.remove('modal-open');
                            showNotification("Business page created successfully!");
                            navigateTo('business-page');
                            break;
                        }
                        case 'withdrawal-form': {
                            const amountEmpy = parseFloat(document.getElementById('withdrawal-amount').value);
                             if (amountEmpy < 5) {
                                showNotification("Minimum withdrawal is 5 EMPY.", "error");
                                return;
                            }
                            showNotification("Withdrawal request submitted for approval.", "info");
                            form.reset();
                            handleWithdrawalMethodChange();
                            updateWithdrawalPreview();
                        }
                            break;
                        case 'message-form':
                            const input = form.querySelector('#message-text-input');
                            const text = input.value.trim();
                            if (text) {
                                const messagesContainer = document.getElementById('chat-messages-container');
                                const messageEl = createMessageElement(text, true);
                                messagesContainer.appendChild(messageEl);
                                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                                input.value = '';
                            }
                            break;
                    }
                });

                document.body.addEventListener('input', function(e) {
                    if (e.target.id === 'withdrawal-amount') {
                        updateWithdrawalPreview();
                    } else if (e.target.id === 'transfer-amount') { 
                        updateTransferPreview();
                    } else if (e.target.id === 'cross-chain-amount') {
                        updateCrossChainTransferPreview();
                    }
                    if (e.target.id === 'buy-empy-amount-usd') {
                        const amountUsd = parseFloat(e.target.value) || 0;
                        const previewEl = document.getElementById('empy-to-receive-preview');
                        if (amountUsd > 0) {
                            previewEl.textContent = `You will receive: ${(amountUsd / EMPY_RATE_USD).toLocaleString()} EMPY`;
                        } else {
                            previewEl.textContent = '';
                        }
                    }
                    if (e.target.id === 'promo-budget') {
                        updatePromoReachPreview();
                    }
                });
                
                // Status press and hold listeners
                const statusModalContent = document.getElementById('status-modal-content');
                if (statusModalContent) {
                    let isHolding = false;
                    const restartTimer = () => {
                        if (isHolding) return;
                        const status = currentStatusUser.statuses[currentStatusIndex];
                        let duration = status.duration;
                        const video = document.querySelector('#status-media-container video');
                        if(status.type === 'video' && video) {
                            video.play();
                            duration = (video.duration - video.currentTime) * 1000;
                        }
                        const currentProgressBar = document.querySelector('#status-progress-bar-container .progress:not(.full)');
                        if(currentProgressBar) {
                            currentProgressBar.style.transition = `width ${duration / 1000}s linear`;
                            currentProgressBar.style.width = '100%';
                        }
                        setNextStatusTimer(duration);
                    };
                    const pauseTimer = () => {
                        clearTimeout(statusTimer);
                        const video = document.querySelector('#status-media-container video');
                        if(video) video.pause();
                        const currentProgressBar = document.querySelector('#status-progress-bar-container .progress:not(.full)');
                        if(currentProgressBar) {
                            const computedWidth = window.getComputedStyle(currentProgressBar).width;
                            currentProgressBar.style.transition = 'none';
                            currentProgressBar.style.width = computedWidth;
                        }
                    };

                    statusModalContent.addEventListener('mousedown', () => { isHolding = true; pauseTimer(); });
                    statusModalContent.addEventListener('mouseup', () => { isHolding = false; restartTimer(); });
                    statusModalContent.addEventListener('mouseleave', () => { if (isHolding) { isHolding = false; restartTimer(); } });
                    statusModalContent.addEventListener('touchstart', (e) => { e.preventDefault(); isHolding = true; pauseTimer(); });
                    statusModalContent.addEventListener('touchend', () => { isHolding = false; restartTimer(); });
                }

                document.querySelectorAll('#reels .reel-card').forEach(card => {
                    const video = card.querySelector('video');
                    card.addEventListener('mouseover', () => video.play().catch(e => {}));
                    card.addEventListener('mouseout', () => video.pause());
                });

                 // Add event listeners to dynamically added videos on dashboard sliders
                new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        mutation.addedNodes.forEach((node) => {
                            if (node.nodeType === 1 && node.matches('.dashboard-news-card, .dashboard-market-card')) {
                                const video = node.querySelector('video');
                                if (video) {
                                    node.addEventListener('mouseover', () => video.play().catch(e => {}));
                                    node.addEventListener('mouseout', () => video.pause());
                                }
                            }
                        });
                    });
                }).observe(document.getElementById('dashboard-news-slider'), { childList: true });
                 new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        mutation.addedNodes.forEach((node) => {
                            if (node.nodeType === 1 && node.matches('.dashboard-news-card, .dashboard-market-card')) {
                                const video = node.querySelector('video');
                                if (video) {
                                    node.addEventListener('mouseover', () => video.play().catch(e => {}));
                                    node.addEventListener('mouseout', () => video.pause());
                                }
                            }
                        });
                    });
                }).observe(document.getElementById('dashboard-market-slider'), { childList: true });


            } 
            
            // --- WHITEPAPER SCRIPT ---
            function initializeWhitepaperScripts() {
                const logoFrame = document.getElementById('logo-frame');
                const logoInput = document.getElementById('logo-upload-input');
                const logoPlaceholder = document.getElementById('logo-placeholder');
                const uploadText = document.querySelector('#whitepaper-container .upload-text');

                if (logoFrame) {
                    logoFrame.addEventListener('click', () => logoInput.click());
                }

                if (logoInput) {
                    logoInput.addEventListener('change', (event) => {
                        const file = event.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                logoPlaceholder.src = e.target.result;
                                if (uploadText) uploadText.style.display = 'none';
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                }

                window.jsPDF = window.jspdf.jsPDF;
                const previewBtn = document.getElementById('preview-pdf-btn');
                const modal = document.getElementById('pdf-modal');
                const closeModalBtn = document.getElementById('close-modal-btn');
                const cancelBtn = document.getElementById('cancel-btn');
                const confirmDownloadBtn = document.getElementById('confirm-download-btn');
                const pdfEmbed = document.getElementById('pdf-embed');
                let generatedPdf = null; 

                const openModal = () => modal.style.display = 'flex';
                const closeModal = () => {
                    modal.style.display = 'none';
                    pdfEmbed.src = 'about:blank';
                    generatedPdf = null;
                };

                if (previewBtn) {
                    previewBtn.addEventListener('click', () => {
                        previewBtn.textContent = 'Generating...';
                        previewBtn.disabled = true;

                        const printableArea = document.createElement('div');
                        printableArea.style.cssText = `position: absolute; top: -9999px; left: -9999px; width: 900px;`;
                        
                        const headerClone = document.querySelector('#whitepaper-container header').cloneNode(true);
                        const contentClone = document.getElementById('content-to-pdf').cloneNode(true);
                        
                        headerClone.querySelector('#preview-pdf-btn').remove();
                        headerClone.style.backgroundColor = getComputedStyle(document.getElementById('whitepaper-container')).backgroundColor;
                        headerClone.style.padding = "50px 20px";

                        const featuresGridClone = contentClone.querySelector('.features-grid');
                        if(featuresGridClone) {
                            featuresGridClone.style.display = 'grid';
                            featuresGridClone.style.gridTemplateColumns = 'repeat(2, 1fr)';
                            featuresGridClone.style.overflowX = 'visible';
                            featuresGridClone.style.flexWrap = 'wrap';
                        }

                        printableArea.appendChild(headerClone);
                        printableArea.appendChild(contentClone);
                        document.body.appendChild(printableArea);

                        const options = { scale: 3, useCORS: true, allowTaint: true, backgroundColor: '#ffffff' };

                        html2canvas(printableArea, options).then(canvas => {
                            const imgData = canvas.toDataURL('image/jpeg', 0.98);
                            const pdf = new jsPDF('p', 'mm', 'a4');
                            const pdfWidth = pdf.internal.pageSize.getWidth();
                            const pdfHeight = pdf.internal.pageSize.getHeight();
                            const canvasWidth = canvas.width;
                            const canvasHeight = canvas.height;
                            const ratio = canvasWidth / pdfWidth;
                            const imgHeight = canvasHeight / ratio;
                            let heightLeft = imgHeight;
                            let position = 0;
                            
                            pdf.addImage(imgData, 'JPEG', 0, position, pdfWidth, imgHeight);
                            heightLeft -= pdfHeight;
                            
                            while (heightLeft > 0) {
                                position = heightLeft - imgHeight;
                                pdf.addPage();
                                pdf.addImage(imgData, 'JPEG', 0, position, pdfWidth, imgHeight);
                                heightLeft -= pdfHeight;
                            }
                            
                            generatedPdf = pdf;
                            pdfEmbed.src = generatedPdf.output('datauristring');
                            openModal();

                        }).catch(error => {
                            console.error('Error generating PDF:', error);
                            alert('Sorry, an error occurred while generating the PDF preview.');
                        }).finally(() => {
                            document.body.removeChild(printableArea);
                            previewBtn.textContent = 'Preview & Download PDF';
                            previewBtn.disabled = false;
                        });
                    });
                }
                if (confirmDownloadBtn) confirmDownloadBtn.addEventListener('click', () => { if (generatedPdf) { generatedPdf.save('Empyrean-Manifesto-V6.0.pdf'); } closeModal(); });
                if (closeModalBtn) closeModalBtn.addEventListener('click', closeModal);
                if (cancelBtn) cancelBtn.addEventListener('click', closeModal);
                
                document.querySelectorAll('#whitepaper-container nav a').forEach(anchor => {
                    anchor.addEventListener('click', function (e) {
                        e.preventDefault();
                        const targetSelector = this.getAttribute('href');
                        const targetElement = document.querySelector('#whitepaper-container ' + targetSelector);
                        if(targetElement) {
                            targetElement.scrollIntoView({ behavior: 'smooth' });
                        }
                    });
                });
            }

            // --- APP INITIALIZATION ---
            setupMasterEventListeners();
            initializeApp(true); 
            setInterval(simulateRewardAccrual, 1000);
        });
    </script>
</body>
</html>```